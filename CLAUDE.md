# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## AI Assistant Guidelines

  **写作限制**:
  - 禁止使用排比句和对仗句式
  - 禁止使用"赋能"、"生态"、"闭环"、"护城河"等商业术语
  - 禁止写"建立完善的XXX体系"、"提升XXX能力"等虚词
  - 禁止发散性思维，严格按要求回答
  - 禁止写"展望未来"、"战略规划"、"核心竞争力"等废话

  **回答要求**:
  - 直接回答问题，不要前言后语
  - 用具体的技术术语，不用抽象概念
  - 说"做什么"而不是"怎么做得更好"
  - 如果不知道就说不知道，不要猜测

  **代码相关**:
  - 只基于现有代码和文档回答
  - 不要建议"最佳实践"或"行业标准"
  - 具体到文件名和函数名
  - 出错了就说哪里出错，不要说"需要进一步分析"

  **禁用词汇**:
  赋能、生态、闭环、护城河、降维打击、颠覆式创新、深度赋能、全链路、一站式、平台化
  、数字化转型、智能化升级、战略布局、前瞻性思考
  
  
## 项目实际情况

**这是什么**: Telegram商户机器人系统V2.0，商户通过绑定码获得永久ID，填写信息后由管理员审核，系统定时发布到频道。用户可下单、评价，有完整的积分等级系统。

**当前状态**: V2.0重构已完成，系统处于生产就绪状态。采用ASGI统一架构，支持多模式启动，具备完整的Web管理后台和14个功能模块。

**核心功能**:
- **绑定系统**: 通过`/bind <绑定码>`为商户创建永久ID，与Telegram账号解耦
- **信息收集**: FSM状态机引导商户通过对话填写资料（不是固定步骤）
- **审核流程**: 管理员在Web后台审核商户信息，可修改并设置到期时间
- **定时发布**: 后端服务根据设定时间自动发布到频道
- **订单系统**: 用户下单，商户接单，支持评价反馈
- **激励系统**: 积分、经验、等级、勋章完整体系

**技术架构**: Python + aiogram 3.4.1 + FastHTML + SQLite + APScheduler，部署在Railway

### 最新进展（评价系统 V2 数据表）
- 一单两评：u2m（沿用 `reviews`，新增最小管理/可见性/报告链接字段）与 m2u（新表 `merchant_reviews`）。
- 用户侧聚合：新表 `user_scores`；商户侧沿用 `merchant_scores`。
- 迁移文件：`database/migrations/migration_2025_09_24_1_评价系统V2_新增m2u与扩展u2m.sql`。
- 机器人端：列表不读长文本，直接返回 `report_post_url`；查询随商户启用/未过期做门禁过滤。

## 🚨 数据库修改铁律 (CRITICAL)

### ❌ 绝对禁止：
- 直接修改数据库文件
- 手动执行SQL语句修改结构  
- 在代码中临时修复数据库问题
- 绕过迁移脚本的任何操作

### ✅ 唯一正确方式：
- **只能通过 `scripts/migrate_to_v2.py` 迁移脚本**
- 所有表结构变更必须在迁移脚本中定义
- 迁移脚本必须具备幂等性（可重复安全执行）
- 先修改迁移脚本，再执行迁移

### 🔄 标准流程：
1. 发现数据库结构问题
2. 修改 `scripts/migrate_to_v2.py` 迁移脚本
3. 执行 `python3 scripts/migrate_to_v2.py`
4. 验证修改结果
5. 测试代码兼容性

**重要**: 迁移脚本是数据库结构的唯一权威来源，代码必须适配迁移脚本定义的结构。

## 开发命令

### 本地开发
```bash
# 智能多模式启动（推荐）
python run.py                    # 自动检测环境启动
RUN_MODE=dev python run.py       # 开发模式（机器人轮询+Web根路径）
RUN_MODE=bot python run.py       # 仅机器人模式
RUN_MODE=web python run.py       # 仅Web管理后台
```

### 生产环境
```bash
python main.py                   # Railway生产环境入口（ASGI统一架构）
RUN_MODE=prod python run.py      # 生产模式（Webhook+Web子路径）
```

### 测试
```bash
python run_tests.py # 运行测试
pytest -m unit      # 只跑单元测试
pytest -m integration # 只跑集成测试
```

### 代码检查
```bash
black .     # 格式化
flake8 .    # 代码检查
mypy .      # 类型检查
```

## 关键配置

### 环境变量 (config/.env)
```bash
# 必需配置
BOT_TOKEN=你的机器人token
ADMIN_IDS=管理员用户ID，逗号分隔
GROUP_CHAT_ID=频道或群组ID
WEB_ADMIN_PASSWORD=admin123

# 部署配置
USE_WEBHOOK=false          # 开发环境false，生产环境true
PORT=8001                  # Web服务端口
RUN_MODE=dev              # dev/prod/bot/web
DATABASE_PATH=data/database.db
```

### V2.0核心设计 (config.py)
```python
# 权限体系
ADMIN_IDS = [123456789, 987654321]  # 管理员TG ID列表

# 状态驱动的帖子生命周期
POST_STATUSES = [
    'pending_submission',  # 等待商户提交信息
    'pending_approval',    # 等待管理员审核
    'approved',           # 已审核，等待发布
    'published',          # 已发布
    'expired'             # 已过期
]
```

## 架构说明

### ASGI统一架构（V2.0生产版本）
- `main.py`: 生产环境ASGI统一入口（自动数据库初始化+Uvicorn启动）
- `run.py`: 智能多模式启动脚本（开发/生产/单机器人/单Web）
- `asgi_app.py`: 完整的ASGI应用集成（Bot Webhook + 14个Web路由模块）
- `bot.py`: Telegram机器人核心类，支持轮询和Webhook两种模式
- `web/app.py`: FastHTML主应用 + 模块化路由系统
- `scheduler.py`: 独立的APScheduler定时任务服务（Railway Worker进程）

### 核心业务流程（5阶段）
1. **阶段一**: 商户通过付款机器人获得绑定码
2. **阶段二**: 商户用`/bind <绑定码>`绑定，FSM状态机引导填写信息
3. **阶段三**: 管理员在Web后台审核，可修改信息并设置到期时间
4. **阶段四**: 定时任务服务在指定时间自动发布到频道
5. **阶段五**: 商户发送 `/start` 并点击“我的资料”查看与管理，用户可下单评价

### 数据库设计（V2.0生产架构）
**核心表** (Schema版本: 2025.09.06.3):
- `merchants`: 商户永久ID系统核心表（与Telegram账号解耦）
- `binding_codes`: 绑定码管理（付费用户获得永久ID）
- `orders`: 订单系统（支持状态跟踪和评价）
- `reviews`: 双向评价系统（用户评价+商户确认）
- `users`: 用户积分等级系统（经验值、等级、勋章）
- `cities`, `districts`: 地区管理（省市二级结构）
- `media`: 媒体文件代理（仅存储telegram_file_id）
- `system_config`: 系统配置动态管理

## 🧰 数据库重建/恢复（协作注意）

开发阶段常见问题：手工修改 `schema.sql` 或直接写 `system_config.schema_version`，会造成“版本已最新但表缺失”。处理原则：

- 首选：让同学运行 `python run.py`，启动过程自带“结构自愈”（重放 schema.sql + 结构同步）。
- 需要干净环境时：
  - `python tools/reset_database.py --yes`（备份到 `data/backups/` 后重建）
  - 或 `python tools/reset_database.py --yes --no-backup`（不备份，谨慎）

边界与注意：
- reset 脚本若提示 duplicate column name，说明之前结构被部分创建；直接 `python run.py` 会触发自愈，通常能恢复。
- 绝不要只改 `schema_version` 而不迁移/重建。
- 生产环境操作前必须确认备份；本仓库默认 SQLite，备份即复制 `data/*.db` 到安全位置。

**V2.0数据库管理器**:
- `DatabaseInitializer`: 智能初始化器（自动检测版本+增量迁移）
- `db_connection.py`: 连接池管理器
- `migrate_to_v2.py`: 幂等性迁移脚本（V1→V2安全升级）

### Web管理后台（14个功能模块）
**核心管理路由**:
```
/merchants/*       # 商户管理和审核（支持快速添加、批量操作）
/orders/*          # 订单管理V2（状态跟踪、分析统计）
/users/*           # 用户管理V2（积分、等级、勋章系统）
/reviews/*         # 评价管理V2（双向评价、确认机制）
/regions/*         # 地区管理（城市-区县二级结构）
/posts/*           # 帖子状态管理（发布时间、生命周期）
/incentives/*      # 激励系统配置（积分规则、勋章触发）
/subscription/*    # 订阅验证V2（频道关注检查）
/media-proxy/*     # 媒体文件代理（Telegram文件实时获取）
```

**分析统计模块**:
```
/orders/analytics/*        # 订单数据分析
/users/analytics/*         # 用户行为分析
/subscription/analytics/*  # 订阅转化分析
```

### 权限体系
1. **管理员**: ADMIN_IDS列表中的用户，可访问Web后台
2. **商户**: merchants表中有记录的用户，有永久ID
3. **普通用户**: 其他用户，可浏览、下单、评价

## 开发重点

### 🎯 V2.0架构一致性标准 (2025年9月制定)
**核心原则**: "唯一方法、唯一接口、唯一路径、与数据库精准匹配、无冗余"

**接口设计标准**:
- **方法签名统一**: 时间范围查询必须使用 `date_from/date_to` 参数
- **导入路径规范**: 统一使用 `database.db_connection` 进行连接管理  
- **异步调用规范**: 避免重复调用协程 `()(...)`，确保正确的单次 await
- **参数完整性**: 所有必需参数必须显式传递，如 `max_xp` 参数

**数据库一致性要求**:
- 代码中的SQL查询字段名必须与实际表结构完全匹配
- 新增字段时必须同步更新迁移脚本 `scripts/migrate_to_v2.py`
- 禁止在代码中写入不存在的字段引用

**代码质量标准**:
- 消除重复日志记录，避免DB层和Route层双重记录
- 清理重复的INSERT语句和模板定义
- 移除未使用的import和函数定义

### 状态机管理（FSM）
**关键**: 商户信息收集使用FSM状态机，不是固定步骤
- 状态保存在`fsm_states`表
- 用`aiogram.fsm.state.State`定义状态
- 对话式引导，根据用户回答调整流程
- 完成时状态设为`pending_approval`

### 永久ID系统
**核心价值**: 解决商户更换Telegram账号导致数据丢失的问题
- merchants表的id字段是永久ID
- telegram_chat_id是当前绑定的TG账号，可以修改
- 业务数据都关联到永久ID，不关联TG账号

### 媒体文件处理
**重要**: 所有图片视频通过`/media-proxy/{media_id}`访问
- 不存储实际文件，只保存telegram_file_id
- Web界面需要显示时，实时从Telegram API下载
- 流式传输给前端，节省存储成本

### 定时发布系统
**技术实现**: APScheduler + 状态驱动
- 独立的后端服务定期扫描approved状态的帖子
- 到达publish_time时自动发布到频道
- 发布成功后状态更新为published

### 评价系统（双向确认）
**业务逻辑**: 用户评价 → 商户确认 → 积分发放
- 用户评价存入reviews表，状态为"待商户确认"
- 商户确认后才发放积分和经验
- 定时任务每日计算商户平均分

## V2.0功能模块状态（14个模块全部完成）

### ✅ 核心业务模块（已完成）
1. **用户注册和身份验证模块**: 三角色权限体系（管理员/商户/用户）
2. **商家绑定和管理模块**: 永久ID绑定系统（Web快速添加+FSM对话收集）  
3. **订单管理和处理模块V2**: 完整生命周期（下单→接单→评价→确认）
4. **评价与等级系统模块V2**: 双向评价机制（用户评价+商户确认）
5. **用户激励系统模块**: 积分经验等级勋章完整体系
6. **地区搜索和筛选模块**: 城市-区县二级地区管理

### ✅ 管理与配置模块（已完成）
7. **Web商家管理模块**: 完整的后台管理界面（14个路由模块）
8. **帖子管理模块**: 状态驱动的生命周期管理
9. **频道订阅验证模块V2**: 用户关注频道验证+分析统计
10. **系统配置和管理模块**: 动态配置系统（system_config表）

### ✅ 智能化模块（已完成）  
11. **关键词匹配和推荐模块**: 商户标签智能系统
12. **消息模板和自动回复模块**: 动态模板引擎
13. **媒体文件代理模块**: Telegram文件实时获取系统
14. **数据分析统计模块**: 订单/用户/订阅三维分析

## 开发任务

### 添加新的信息收集字段
1. 修改`merchants`表结构
2. 更新`handlers/merchant.py`的FSM状态
3. 修改Web后台的展示和编辑界面
4. 更新帖子模板生成逻辑

### 数据库改动
1. 写幂等性迁移脚本放在`scripts/`
2. 更新`database/schema.sql`
3. 修改对应的V2管理器类
4. 测试新旧数据兼容性

### 添加新的激励规则
1. 在`system_config`表更新积分配置
2. 在`badge_triggers`表添加新的触发条件
3. 更新激励检查逻辑
4. 测试积分发放和升级逻辑

## 常见问题

### FSM状态异常
- 影响：用户卡在信息填写过程中
- 原因：状态没有正确转换或清理
- 解决：管理员清理命令 + 状态自动过期

### 媒体代理失败
- 影响：Web后台无法显示图片视频
- 原因：telegram_file_id过期或网络问题
- 解决：重试机制 + 错误处理

### 定时发布失败
- 影响：已审核的帖子没有按时发布
- 原因：定时任务服务异常或频道权限问题
- 解决：任务监控 + 手动重试机制

### 权限判断错误
- 影响：用户看到不应该看到的功能
- 原因：ADMIN_IDS配置错误或merchants表数据异常
- 解决：权限检查逻辑优化

## 监控指标

### 业务指标
- 商户绑定转化率
- 信息填写完成率
- 管理员审核通过率
- 帖子发布成功率
- 用户下单转化率
- 评价完成率

### 技术指标
- FSM状态转换成功率
- 媒体代理响应时间
- 定时任务执行成功率
- 数据库查询性能

## 测试重点

### 业务流程测试
- 完整的商户绑定和信息收集流程
- 管理员审核和发布流程
- 用户下单和评价流程
- 积分等级升级流程

### 异步测试
- FSM状态机转换
- 定时任务执行
- 媒体文件代理
- 数据库事务一致性

## V2.0生产部署

### Railway部署配置 (railway.toml)
```toml
[deploy.web]
command = "python3 main.py"          # ASGI统一架构主进程

[deploy.worker]  
command = "python3 scheduler.py"     # APScheduler定时任务进程
```

### 多环境支持
```bash
# 开发环境
RUN_MODE=dev USE_WEBHOOK=false python run.py

# 生产环境 
RUN_MODE=prod USE_WEBHOOK=true python main.py
```

## 注意事项

**V2.0架构特点**: 
- 永久ID系统：商户数据与Telegram账号完全解耦
- 智能启动脚本：根据环境自动选择轮询/Webhook模式
- ASGI统一架构：Bot和Web管理后台单进程部署
- 模块化路由系统：14个独立的功能模块
- 幂等性数据库迁移：支持安全的增量升级

**开发原则**:
- 所有关键业务数据都关联永久ID，不关联TG账号
- 状态转换必须原子化，防止数据不一致
- 媒体文件只存储file_id，实时获取
- 激励系统必须防止重复发放和作弊

**当前项目阶段**: V2.0重构已完成，系统处于生产就绪状态。所有14个功能模块已实现，数据库架构稳定（Schema版本2025.09.06.3）。

## 🎯 V2.0唯一接口标准 (202509181800)

### 核心架构原则
- **唯一方法**: 每个功能仅有一个实现路径，消除重复和冗余
- **唯一接口**: 统一的调用链路 Route → DB Manager，无Service层
- **唯一路径**: 无重复逻辑，清晰的单一数据流
- **数据库精准匹配**: 字段名与schema完全一致，避免隐式转换
- **无冗余**: 清除所有未使用的代码、导入和中间层

### 绑定码模块标准示例 
**字段统一**:
- ✅ 全链路使用 `merchant_id` 字段名
- ❌ 禁用 `used_by_merchant_id` 历史字段名

**参数类型**:
- ✅ 路由参数使用 `{code}` 字符串类型
- ❌ 禁用 `{code_id:int}` 整型参数

**调用链路**:
- ✅ Route → DB Manager 直接调用
- ❌ 禁用中间Service层冗余

### 开发指南
遵循 `docs/development_guidelines_v2.md` 的强制标准，确保所有开发活动符合V2.0架构原则。

---

## 🎯 标准反馈框架 (STANDARD FEEDBACK FRAMEWORK)

### 反馈结构化模板

**适用场景**: 复杂技术问题解决、系统架构重构、代码质量提升、功能开发验收

#### **1. 任务执行总览**
```
**任务协议**: [任务名称/编号]
**核心目标**: [具体目标描述] 
**执行状态**: ✅/❌ [完成状态]
```

#### **2. 核心问题解决清单**
```
### ✅ [问题编号]: [问题简述]
**问题描述**: [详细问题分析，定位到文件:行号]
**解决方案**: 
1. [具体技术步骤1]
2. [具体技术步骤2]
**修复结果**:
- ✅ [具体可验证成果1]
- ✅ [具体可验证成果2]
```

#### **3. 涉及文件清单**
```
### 🆕 新创建文件
- `/path/file.py` - 功能描述

### 🔧 核心修改文件  
- `/path/file.py:行号` - 修改内容描述
```

#### **4. 质量控制验证**
```
### QC-[编号]: [验证项目名称]
- ✅ [验证点1]: [具体数值结果]
- ✅ [验证点2]: [具体数值结果] 
- ✅ 综合验证: [通过率]% 通过
```

#### **5. 系统改进成果**
```
### 📈 [改进维度]
- **[指标名称]**: [数值]% - [具体改进描述]
- **[指标名称]**: [数值]% - [具体改进描述]
```

#### **6. 最终验收**
```
### ✅ [验收标准名称]
- [具体达成情况，可量化]
- [验收通过的具体证据]
```

#### **7. 任务总结**
```
**[任务名称] 任务状态**: ✅ **[最终状态]**

[简洁有力的总结语句，突出核心价值]
系统现已具备：[关键改进点列表]

**执行。精确。高效。任务完成。**
```

### 关键设计原则

#### **结构化呈现**
- 使用emoji(✅❌📈🔧🆕📋)增强视觉识别
- 清晰的分层级组织结构
- 统一的标题和格式规范

#### **量化验证导向**
- 必须提供具体数字和百分比
- 使用可测量的结果指标
- ✅❌明确的二元状态标识
- 避免模糊性表述

#### **军事化语言风格**  
- 使用作战、任务、执行、验证等术语
- 简洁有力、绝对化的表述
- "执行。精确。高效。"式结尾

#### **完整性闭环**
- 问题→分析→方案→结果的完整链条
- 文件:行号级别的精确定位
- 验证→总结的质量控制闭环
- 无遗漏的全覆盖报告

#### **技术精准性**
- 具体到文件名和函数名
- 基于现有代码和文档的精确引用
- 避免抽象概念，使用具体技术术语
- 说"做什么"而不是"怎么做得更好"

### 执行要求

1. **每个复杂任务开始时**：创建TodoWrite跟踪任务进度
2. **任务执行过程中**：按此框架收集和组织信息
3. **任务完成时**：严格按此模板生成最终反馈
4. **质量标准**：确保每个环节都有量化验证和具体证据
- 不许使用任何简化逻辑 启动应用必须通过完整的python3 run.py
