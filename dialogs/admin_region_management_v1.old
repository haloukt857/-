"""
ç®¡ç†å‘˜åœ°åŒºç®¡ç†å¯¹è¯æµç¨‹
æä¾›çœä»½å’ŒåŒºåŸŸçš„å®Œæ•´CRUDç®¡ç†åŠŸèƒ½
"""

import logging
from typing import Dict, List, Optional, Any
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.constants import ParseMode

from database.db_regions import RegionManager
from config import MESSAGE_TEMPLATES

logger = logging.getLogger(__name__)


class AdminRegionManagement:
    """ç®¡ç†å‘˜åœ°åŒºç®¡ç†å¯¹è¯æµç¨‹"""
    
    def __init__(self):
        self.province_db = ProvinceDatabase()
        self.region_db = RegionDatabase()
        # ä¸´æ—¶çŠ¶æ€å­˜å‚¨
        self.user_states: Dict[int, Dict] = {}
    
    async def initialize(self):
        """åˆå§‹åŒ–ç®¡ç†å™¨"""
        logger.info("ç®¡ç†å‘˜åœ°åŒºç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
    
    def _get_user_state(self, user_id: int) -> Dict:
        """è·å–ç”¨æˆ·çŠ¶æ€"""
        if user_id not in self.user_states:
            self.user_states[user_id] = {
                'action': None,
                'selected_province_id': None,
                'selected_region_id': None,
                'editing_data': {}
            }
        return self.user_states[user_id]
    
    def _clear_user_state(self, user_id: int):
        """æ¸…é™¤ç”¨æˆ·çŠ¶æ€"""
        if user_id in self.user_states:
            del self.user_states[user_id]
    
    async def show_main_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
        """æ˜¾ç¤ºåœ°åŒºç®¡ç†ä¸»èœå•"""
        try:
            keyboard = [
                [
                    InlineKeyboardButton("ğŸ™ï¸ çœä»½ç®¡ç†", callback_data="admin_region_provinces"),
                    InlineKeyboardButton("ğŸ›ï¸ åŒºåŸŸç®¡ç†", callback_data="admin_region_regions")
                ],
                [
                    InlineKeyboardButton("ğŸ“Š ç»Ÿè®¡ä¿¡æ¯", callback_data="admin_region_stats"),
                    InlineKeyboardButton("ğŸ”„ åŒæ­¥æ•°æ®", callback_data="admin_region_sync")
                ],
                [InlineKeyboardButton("â†©ï¸ è¿”å›ç®¡ç†èœå•", callback_data="admin_main")]
            ]
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            message = (
                "ğŸŒ åœ°åŒºç®¡ç†ç³»ç»Ÿ\n\n"
                "é€‰æ‹©è¦ç®¡ç†çš„å†…å®¹ï¼š\n"
                "â€¢ çœä»½ç®¡ç† - æ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤çœä»½\n"
                "â€¢ åŒºåŸŸç®¡ç† - ç®¡ç†åŒºåŸŸä¿¡æ¯\n"
                "â€¢ ç»Ÿè®¡ä¿¡æ¯ - æŸ¥çœ‹åœ°åŒºæ•°æ®ç»Ÿè®¡\n"
                "â€¢ åŒæ­¥æ•°æ® - æ‰‹åŠ¨åŒæ­¥åœ°åŒºæ•°æ®"
            )
            
            if update.callback_query:
                await update.callback_query.edit_message_text(
                    text=message,
                    reply_markup=reply_markup,
                    parse_mode=None
                )
            else:
                await update.message.reply_text(
                    text=message,
                    reply_markup=reply_markup,
                    parse_mode=None
                )
            
            return True
            
        except Exception as e:
            logger.error(f"æ˜¾ç¤ºåœ°åŒºç®¡ç†ä¸»èœå•å¤±è´¥: {e}")
            return False
    
    async def handle_province_management(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
        """å¤„ç†çœä»½ç®¡ç†"""
        try:
            provinces = await self.province_db.get_all_provinces()
            
            keyboard = []
            # æ·»åŠ ç°æœ‰çœä»½çš„ç®¡ç†æŒ‰é’®
            for province in provinces:
                status_icon = "âœ…" if province['is_active'] else "âŒ"
                keyboard.append([
                    InlineKeyboardButton(
                        f"{status_icon} {province['name']} ({province['region_count']}ä¸ªåŒºåŸŸ)",
                        callback_data=f"admin_province_edit_{province['id']}"
                    )
                ])
            
            # æ“ä½œæŒ‰é’®
            keyboard.extend([
                [InlineKeyboardButton("â• æ·»åŠ æ–°çœä»½", callback_data="admin_province_add")],
                [
                    InlineKeyboardButton("ğŸ“Š çœä»½ç»Ÿè®¡", callback_data="admin_province_stats"),
                    InlineKeyboardButton("ğŸ”„ åˆ·æ–°åˆ—è¡¨", callback_data="admin_region_provinces")
                ],
                [InlineKeyboardButton("â†©ï¸ è¿”å›åœ°åŒºç®¡ç†", callback_data="admin_region_main")]
            ])
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            message = (
                f"ğŸ™ï¸ çœä»½ç®¡ç†\n\n"
                f"å½“å‰å…±æœ‰ {len(provinces)} ä¸ªçœä»½\n\n"
                "ç‚¹å‡»çœä»½åç§°è¿›è¡Œç¼–è¾‘ï¼Œæˆ–é€‰æ‹©å…¶ä»–æ“ä½œï¼š\n"
                "âœ… = æ¿€æ´»çŠ¶æ€  âŒ = ç¦ç”¨çŠ¶æ€\n"
                "æ•°å­—è¡¨ç¤ºè¯¥çœä»½ä¸‹çš„åŒºåŸŸæ•°é‡"
            )
            
            await update.callback_query.edit_message_text(
                text=message,
                reply_markup=reply_markup,
                parse_mode=None
            )
            
            return True
            
        except Exception as e:
            logger.error(f"å¤„ç†çœä»½ç®¡ç†å¤±è´¥: {e}")
            await update.callback_query.answer("âŒ åŠ è½½çœä»½åˆ—è¡¨å¤±è´¥", show_alert=True)
            return False
    
    async def handle_region_management(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
        """å¤„ç†åŒºåŸŸç®¡ç†"""
        try:
            provinces = await self.province_db.get_provinces_for_buttons()
            
            keyboard = []
            # æŒ‰çœä»½æ˜¾ç¤ºåŒºåŸŸç®¡ç†å…¥å£
            for province in provinces:
                region_count = await self.region_db.count_regions_by_province(province['id'])
                keyboard.append([
                    InlineKeyboardButton(
                        f"ğŸ›ï¸ {province['name']} ({region_count}ä¸ªåŒºåŸŸ)",
                        callback_data=f"admin_regions_by_province_{province['id']}"
                    )
                ])
            
            # æ“ä½œæŒ‰é’®
            keyboard.extend([
                [
                    InlineKeyboardButton("â• å¿«é€Ÿæ·»åŠ åŒºåŸŸ", callback_data="admin_region_quick_add"),
                    InlineKeyboardButton("ğŸ“Š åŒºåŸŸç»Ÿè®¡", callback_data="admin_region_stats")
                ],
                [InlineKeyboardButton("â†©ï¸ è¿”å›åœ°åŒºç®¡ç†", callback_data="admin_region_main")]
            ])
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            message = (
                "ğŸ›ï¸ åŒºåŸŸç®¡ç†\n\n"
                "é€‰æ‹©çœä»½æ¥ç®¡ç†å…¶ä¸‹å±åŒºåŸŸï¼š\n"
                "æ•°å­—è¡¨ç¤ºè¯¥çœä»½ä¸‹çš„åŒºåŸŸæ•°é‡"
            )
            
            await update.callback_query.edit_message_text(
                text=message,
                reply_markup=reply_markup,
                parse_mode=None
            )
            
            return True
            
        except Exception as e:
            logger.error(f"å¤„ç†åŒºåŸŸç®¡ç†å¤±è´¥: {e}")
            await update.callback_query.answer("âŒ åŠ è½½åŒºåŸŸç®¡ç†å¤±è´¥", show_alert=True)
            return False
    
    async def handle_add_province(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
        """å¼€å§‹æ·»åŠ æ–°çœä»½æµç¨‹"""
        try:
            user_id = update.effective_user.id
            state = self._get_user_state(user_id)
            state['action'] = 'adding_province'
            
            keyboard = [[InlineKeyboardButton("âŒ å–æ¶ˆ", callback_data="admin_region_provinces")]]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            message = (
                "â• æ·»åŠ æ–°çœä»½\n\n"
                "è¯·è¾“å…¥çœä»½åç§°ï¼š\n"
                "â€¢ åç§°åº”è¯¥æ¸…æ™°æ˜ç¡®\n"
                "â€¢ ä¸èƒ½ä¸ç°æœ‰çœä»½é‡å¤\n"
                "â€¢ å»ºè®®ä½¿ç”¨æ ‡å‡†çœä»½åç§°"
            )
            
            await update.callback_query.edit_message_text(
                text=message,
                reply_markup=reply_markup,
                parse_mode=None
            )
            
            return True
            
        except Exception as e:
            logger.error(f"å¼€å§‹æ·»åŠ çœä»½æµç¨‹å¤±è´¥: {e}")
            return False
    
    async def handle_text_input(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
        """å¤„ç†æ–‡æœ¬è¾“å…¥"""
        try:
            user_id = update.effective_user.id
            state = self._get_user_state(user_id)
            text = update.message.text.strip()
            
            if state['action'] == 'adding_province':
                return await self._process_add_province(update, context, text)
            elif state['action'] == 'editing_province_name':
                return await self._process_edit_province_name(update, context, text)
            elif state['action'] == 'adding_region':
                return await self._process_add_region(update, context, text)
            elif state['action'] == 'editing_region_name':
                return await self._process_edit_region_name(update, context, text)
            
            return False
            
        except Exception as e:
            logger.error(f"å¤„ç†æ–‡æœ¬è¾“å…¥å¤±è´¥: {e}")
            return False
    
    async def _process_add_province(self, update: Update, context: ContextTypes.DEFAULT_TYPE, name: str) -> bool:
        """å¤„ç†æ·»åŠ çœä»½"""
        try:
            user_id = update.effective_user.id
            
            # æ£€æŸ¥åç§°æ˜¯å¦å·²å­˜åœ¨
            existing = await self.province_db.get_province_by_name(name)
            if existing:
                await update.message.reply_text(
                    f"âŒ çœä»½ '{name}' å·²ç»å­˜åœ¨ï¼\nè¯·è¾“å…¥ä¸åŒçš„åç§°ï¼š",
                    parse_mode=None
                )
                return True
            
            # æ·»åŠ çœä»½
            province_id = await self.province_db.create_province(name)
            if province_id:
                self._clear_user_state(user_id)
                
                keyboard = [
                    [InlineKeyboardButton("â• ç»§ç»­æ·»åŠ ", callback_data="admin_province_add")],
                    [InlineKeyboardButton("ğŸ›ï¸ æ·»åŠ åŒºåŸŸ", callback_data=f"admin_regions_by_province_{province_id}")],
                    [InlineKeyboardButton("â†©ï¸ è¿”å›çœä»½ç®¡ç†", callback_data="admin_region_provinces")]
                ]
                reply_markup = InlineKeyboardMarkup(keyboard)
                
                await update.message.reply_text(
                    f"âœ… æ·»åŠ æˆåŠŸï¼\n\n"
                    f"çœä»½ '{name}' å·²æˆåŠŸæ·»åŠ \n"
                    f"ID: {province_id}",
                    reply_markup=reply_markup,
                    parse_mode=None
                )
                return True
            else:
                await update.message.reply_text("âŒ æ·»åŠ çœä»½å¤±è´¥ï¼Œè¯·é‡è¯•")
                return False
                
        except Exception as e:
            logger.error(f"æ·»åŠ çœä»½å¤±è´¥: {e}")
            await update.message.reply_text("âŒ æ·»åŠ çœä»½æ—¶å‘ç”Ÿé”™è¯¯")
            return False
    
    async def handle_edit_province(self, update: Update, context: ContextTypes.DEFAULT_TYPE, province_id: int) -> bool:
        """å¤„ç†ç¼–è¾‘çœä»½"""
        try:
            province = await self.province_db.get_province_by_id(province_id)
            if not province:
                await update.callback_query.answer("âŒ çœä»½ä¸å­˜åœ¨", show_alert=True)
                return False
            
            regions = await self.region_db.get_regions_by_province(province_id)
            
            keyboard = [
                [InlineKeyboardButton("âœï¸ ç¼–è¾‘åç§°", callback_data=f"admin_province_edit_name_{province_id}")],
                [
                    InlineKeyboardButton(
                        "ğŸ”„ åˆ‡æ¢çŠ¶æ€" if province['is_active'] else "âœ… å¯ç”¨çœä»½",
                        callback_data=f"admin_province_toggle_{province_id}"
                    ),
                    InlineKeyboardButton("ğŸ“Š è°ƒæ•´æ’åº", callback_data=f"admin_province_order_{province_id}")
                ],
                [InlineKeyboardButton("ğŸ›ï¸ ç®¡ç†åŒºåŸŸ", callback_data=f"admin_regions_by_province_{province_id}")],
            ]
            
            # åªæœ‰åœ¨æ²¡æœ‰åŒºåŸŸæ—¶æ‰å…è®¸åˆ é™¤
            if len(regions) == 0:
                keyboard.append([InlineKeyboardButton("ğŸ—‘ï¸ åˆ é™¤çœä»½", callback_data=f"admin_province_delete_{province_id}")])
            
            keyboard.append([InlineKeyboardButton("â†©ï¸ è¿”å›çœä»½ç®¡ç†", callback_data="admin_region_provinces")])
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            status = "âœ… æ¿€æ´»" if province['is_active'] else "âŒ ç¦ç”¨"
            message = (
                f"âœï¸ ç¼–è¾‘çœä»½: {province['name']}\n\n"
                f"ID: {province['id']}\n"
                f"çŠ¶æ€: {status}\n"
                f"æ’åº: {province['display_order']}\n"
                f"åŒºåŸŸæ•°é‡: {len(regions)}\n"
                f"åˆ›å»ºæ—¶é—´: {province['created_at'][:19]}\n"
                f"æ›´æ–°æ—¶é—´: {province['updated_at'][:19]}"
            )
            
            if len(regions) > 0:
                message += f"\n\nâš ï¸ è¯¥çœä»½ä¸‹æœ‰ {len(regions)} ä¸ªåŒºåŸŸï¼Œæ— æ³•åˆ é™¤"
            
            await update.callback_query.edit_message_text(
                text=message,
                reply_markup=reply_markup,
                parse_mode=None
            )
            
            return True
            
        except Exception as e:
            logger.error(f"ç¼–è¾‘çœä»½å¤±è´¥: {e}")
            await update.callback_query.answer("âŒ åŠ è½½çœä»½ä¿¡æ¯å¤±è´¥", show_alert=True)
            return False
    
    async def handle_toggle_province(self, update: Update, context: ContextTypes.DEFAULT_TYPE, province_id: int) -> bool:
        """åˆ‡æ¢çœä»½çŠ¶æ€"""
        try:
            province = await self.province_db.get_province_by_id(province_id)
            if not province:
                await update.callback_query.answer("âŒ çœä»½ä¸å­˜åœ¨", show_alert=True)
                return False
            
            new_status = not province['is_active']
            success = await self.province_db.update_province_status(province_id, new_status)
            
            if success:
                status_text = "æ¿€æ´»" if new_status else "ç¦ç”¨"
                await update.callback_query.answer(f"âœ… çœä»½å·²{status_text}")
                # åˆ·æ–°ç¼–è¾‘ç•Œé¢
                return await self.handle_edit_province(update, context, province_id)
            else:
                await update.callback_query.answer("âŒ æ›´æ–°å¤±è´¥", show_alert=True)
                return False
                
        except Exception as e:
            logger.error(f"åˆ‡æ¢çœä»½çŠ¶æ€å¤±è´¥: {e}")
            await update.callback_query.answer("âŒ æ“ä½œå¤±è´¥", show_alert=True)
            return False
    
    async def handle_regions_by_province(self, update: Update, context: ContextTypes.DEFAULT_TYPE, province_id: int) -> bool:
        """æ˜¾ç¤ºæŒ‡å®šçœä»½ä¸‹çš„åŒºåŸŸç®¡ç†"""
        try:
            province = await self.province_db.get_province_by_id(province_id)
            if not province:
                await update.callback_query.answer("âŒ çœä»½ä¸å­˜åœ¨", show_alert=True)
                return False
            
            regions = await self.region_db.get_regions_by_province(province_id)
            
            keyboard = []
            # æ·»åŠ ç°æœ‰åŒºåŸŸçš„ç®¡ç†æŒ‰é’®
            for region in regions:
                status_icon = "âœ…" if region['is_active'] else "âŒ"
                keyboard.append([
                    InlineKeyboardButton(
                        f"{status_icon} {region['name']}",
                        callback_data=f"admin_region_edit_{region['id']}"
                    )
                ])
            
            # æ“ä½œæŒ‰é’®
            keyboard.extend([
                [InlineKeyboardButton("â• æ·»åŠ åŒºåŸŸ", callback_data=f"admin_region_add_{province_id}")],
                [
                    InlineKeyboardButton("ğŸ”„ åˆ·æ–°åˆ—è¡¨", callback_data=f"admin_regions_by_province_{province_id}"),
                    InlineKeyboardButton("ğŸ“Š ç»Ÿè®¡ä¿¡æ¯", callback_data=f"admin_region_stats_{province_id}")
                ],
                [InlineKeyboardButton("â†©ï¸ è¿”å›åŒºåŸŸç®¡ç†", callback_data="admin_region_regions")]
            ])
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            message = (
                f"ğŸ›ï¸ {province['name']} - åŒºåŸŸç®¡ç†\n\n"
                f"å½“å‰å…±æœ‰ {len(regions)} ä¸ªåŒºåŸŸ\n\n"
                "ç‚¹å‡»åŒºåŸŸåç§°è¿›è¡Œç¼–è¾‘ï¼š\n"
                "âœ… = æ¿€æ´»çŠ¶æ€  âŒ = ç¦ç”¨çŠ¶æ€"
            )
            
            await update.callback_query.edit_message_text(
                text=message,
                reply_markup=reply_markup,
                parse_mode=None
            )
            
            return True
            
        except Exception as e:
            logger.error(f"æ˜¾ç¤ºçœä»½åŒºåŸŸå¤±è´¥: {e}")
            await update.callback_query.answer("âŒ åŠ è½½åŒºåŸŸåˆ—è¡¨å¤±è´¥", show_alert=True)
            return False
    
    async def handle_add_region(self, update: Update, context: ContextTypes.DEFAULT_TYPE, province_id: int) -> bool:
        """å¼€å§‹æ·»åŠ åŒºåŸŸæµç¨‹"""
        try:
            user_id = update.effective_user.id
            state = self._get_user_state(user_id)
            state['action'] = 'adding_region'
            state['selected_province_id'] = province_id
            
            province = await self.province_db.get_province_by_id(province_id)
            
            keyboard = [[InlineKeyboardButton("âŒ å–æ¶ˆ", callback_data=f"admin_regions_by_province_{province_id}")]]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            message = (
                f"â• æ·»åŠ åŒºåŸŸåˆ° {province['name']}\n\n"
                "è¯·è¾“å…¥åŒºåŸŸåç§°ï¼š\n"
                "â€¢ åç§°åº”è¯¥æ¸…æ™°æ˜ç¡®\n"
                "â€¢ ä¸èƒ½ä¸è¯¥çœä»½ç°æœ‰åŒºåŸŸé‡å¤\n"
                "â€¢ å»ºè®®ä½¿ç”¨æ ‡å‡†åŒºåŸŸåç§°"
            )
            
            await update.callback_query.edit_message_text(
                text=message,
                reply_markup=reply_markup,
                parse_mode=None
            )
            
            return True
            
        except Exception as e:
            logger.error(f"å¼€å§‹æ·»åŠ åŒºåŸŸæµç¨‹å¤±è´¥: {e}")
            return False
    
    async def _process_add_region(self, update: Update, context: ContextTypes.DEFAULT_TYPE, name: str) -> bool:
        """å¤„ç†æ·»åŠ åŒºåŸŸ"""
        try:
            user_id = update.effective_user.id
            state = self._get_user_state(user_id)
            province_id = state['selected_province_id']
            
            # æ£€æŸ¥åç§°åœ¨è¯¥çœä»½å†…æ˜¯å¦å·²å­˜åœ¨
            existing = await self.region_db.get_region_by_name_and_province(name, province_id)
            if existing:
                await update.message.reply_text(
                    f"âŒ è¯¥çœä»½å†…å·²å­˜åœ¨åŒºåŸŸ '{name}'ï¼\nè¯·è¾“å…¥ä¸åŒçš„åç§°ï¼š",
                    parse_mode=None
                )
                return True
            
            # æ·»åŠ åŒºåŸŸ
            region_id = await self.region_db.create_region(name, province_id)
            if region_id:
                self._clear_user_state(user_id)
                
                keyboard = [
                    [InlineKeyboardButton("â• ç»§ç»­æ·»åŠ ", callback_data=f"admin_region_add_{province_id}")],
                    [InlineKeyboardButton("âœï¸ ç¼–è¾‘åŒºåŸŸ", callback_data=f"admin_region_edit_{region_id}")],
                    [InlineKeyboardButton("â†©ï¸ è¿”å›åŒºåŸŸåˆ—è¡¨", callback_data=f"admin_regions_by_province_{province_id}")]
                ]
                reply_markup = InlineKeyboardMarkup(keyboard)
                
                await update.message.reply_text(
                    f"âœ… æ·»åŠ æˆåŠŸï¼\n\n"
                    f"åŒºåŸŸ '{name}' å·²æˆåŠŸæ·»åŠ \n"
                    f"ID: {region_id}",
                    reply_markup=reply_markup,
                    parse_mode=None
                )
                return True
            else:
                await update.message.reply_text("âŒ æ·»åŠ åŒºåŸŸå¤±è´¥ï¼Œè¯·é‡è¯•")
                return False
                
        except Exception as e:
            logger.error(f"æ·»åŠ åŒºåŸŸå¤±è´¥: {e}")
            await update.message.reply_text("âŒ æ·»åŠ åŒºåŸŸæ—¶å‘ç”Ÿé”™è¯¯")
            return False
    
    async def show_statistics(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
        """æ˜¾ç¤ºåœ°åŒºç»Ÿè®¡ä¿¡æ¯"""
        try:
            # è·å–ç»Ÿè®¡æ•°æ®
            provinces = await self.province_db.get_all_provinces()
            active_provinces = [p for p in provinces if p['is_active']]
            
            total_regions = 0
            active_regions = 0
            
            for province in provinces:
                regions = await self.region_db.get_regions_by_province(province['id'])
                total_regions += len(regions)
                active_regions += len([c for c in regions if c['is_active']])
            
            keyboard = [
                [InlineKeyboardButton("ğŸ™ï¸ çœä»½è¯¦æƒ…", callback_data="admin_province_stats")],
                [InlineKeyboardButton("ğŸ›ï¸ åŒºåŸŸè¯¦æƒ…", callback_data="admin_region_stats")],
                [InlineKeyboardButton("â†©ï¸ è¿”å›åœ°åŒºç®¡ç†", callback_data="admin_region_main")]
            ]
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            message = (
                f"ğŸ“Š åœ°åŒºç»Ÿè®¡ä¿¡æ¯\n\n"
                f"ğŸ™ï¸ çœä»½ç»Ÿè®¡\n"
                f"â€¢ æ€»è®¡: {len(provinces)} ä¸ª\n"
                f"â€¢ æ¿€æ´»: {len(active_provinces)} ä¸ª\n"
                f"â€¢ ç¦ç”¨: {len(provinces) - len(active_provinces)} ä¸ª\n\n"
                f"ğŸ›ï¸ åŒºåŸŸç»Ÿè®¡\n"
                f"â€¢ æ€»è®¡: {total_regions} ä¸ª\n"
                f"â€¢ æ¿€æ´»: {active_regions} ä¸ª\n"
                f"â€¢ ç¦ç”¨: {total_regions - active_regions} ä¸ª\n\n"
                f"ğŸ“ˆ å¹³å‡æ•°æ®\n"
                f"â€¢ å¹³å‡æ¯çœåŒºåŸŸæ•°: {total_regions / len(provinces) if provinces else 0:.1f}"
            )
            
            await update.callback_query.edit_message_text(
                text=message,
                reply_markup=reply_markup,
                parse_mode=None
            )
            
            return True
            
        except Exception as e:
            logger.error(f"æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯å¤±è´¥: {e}")
            await update.callback_query.answer("âŒ è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥", show_alert=True)
            return False
    
    async def cleanup(self):
        """æ¸…ç†èµ„æº"""
        self.user_states.clear()
        logger.info("åœ°åŒºç®¡ç†ç³»ç»Ÿå·²æ¸…ç†")