# V2.0系统全面测试计划

## 测试计划概述

本测试计划基于V2.0系统文档分析，覆盖4个核心用户故事的完整业务流程，确保系统各模块间的协调工作和数据一致性。

### 测试优先级
- **P1 (高)**: 核心业务流程，系统必须正常工作
- **P2 (中)**: 重要功能点，影响用户体验  
- **P3 (低)**: 边缘情况和优化功能

---

## 核心用户故事测试用例

### 用户故事1: 新商户入驻流程

**业务流程**: 绑定码验证 → FSM信息收集 → 提交审核

#### TC001-P1: 成功绑定流程
**前置条件**:
- 系统中存在有效未使用绑定码 "BIND2024001"
- 用户TG ID: 123456789 (非管理员，未绑定商户)
- merchants表、binding_codes表正常

**测试步骤**:
1. 用户发送 `/bind BIND2024001`
2. 验证系统响应绑定成功消息
3. 确认FSM状态机启动信息收集流程
4. 依次填写商户信息：
   - 名称: "测试商户"
   - 地区: 选择城市 -> 选择地区
   - 价格1: 500, 价格2: 800  
   - 优点: "服务专业，环境优雅"
   - 缺点: "价格稍高"
   - 基本功: "擅长放松按摩"
   - 上传媒体文件: 3张图片
5. 提交完成信息收集

**预期结果**:
- 绑定码状态更新为已使用
- merchants表创建新记录，获得永久ID
- FSM状态正常转换，所有字段完整填写
- 商户状态更新为 `pending_approval`
- media表正确存储媒体文件的telegram_file_id

**验证点**:
```sql
-- 验证绑定码状态
SELECT is_used, used_by_merchant_id FROM binding_codes WHERE code = 'BIND2024001';

-- 验证商户记录
SELECT id, telegram_chat_id, status FROM merchants WHERE telegram_chat_id = 123456789;

-- 验证媒体文件
SELECT COUNT(*) FROM media WHERE merchant_id = [新创建的merchant_id];
```

#### TC002-P1: 绑定码验证失败场景
**前置条件**:
- 系统中不存在绑定码 "INVALID001"

**测试步骤**:
1. 用户发送 `/bind INVALID001`

**预期结果**:
- 返回"绑定码无效或已被使用"错误消息
- 不创建任何数据库记录
- 不启动FSM流程

#### TC003-P2: FSM状态异常恢复
**前置条件**:
- 用户在信息收集过程中断开连接
- FSM状态卡在中间状态

**测试步骤**:
1. 模拟用户重新发送消息
2. 验证系统能识别断点状态
3. 提供继续填写或重新开始选项

**预期结果**:
- 系统正确恢复用户当前进度
- 已填写信息不丢失
- 用户可选择继续或重新开始

---

### 用户故事2: 帖子生命周期管理

**业务流程**: 商户提交 → 管理员审核 → 批准发布 → 状态变更 → 自动发布

#### TC004-P1: 完整审核发布流程
**前置条件**:
- merchants表中存在状态为 `pending_approval` 的商户记录
- 管理员已登录Web后台
- 定时发布服务正常运行

**测试步骤**:
1. 管理员访问Web后台帖子管理页面
2. 查看待审核帖子列表
3. 点击进入帖子详情页面
4. 验证显示完整商户信息和媒体文件
5. 编辑帖子信息（可选）
6. 设置发布时间为5分钟后
7. 设置到期时间为7天后
8. 点击"批准发布"按钮
9. 等待定时任务执行发布

**预期结果**:
- Web后台正确显示商户所有信息
- 媒体代理功能正常显示图片/视频
- 帖子状态从 `pending_approval` 更新为 `approved`
- publish_time 和 expiration_time 正确设置
- 定时任务在指定时间发布帖子到频道
- 发布成功后状态更新为 `published`

**验证点**:
```sql
-- 验证帖子状态变更
SELECT status, publish_time, expiration_time FROM merchants WHERE id = [merchant_id];

-- 验证发布日志 (如果有)
SELECT * FROM publish_logs WHERE merchant_id = [merchant_id];
```

#### TC005-P2: 媒体代理功能测试
**前置条件**:
- 商户上传了图片和视频文件
- media表中存储了telegram_file_id

**测试步骤**:
1. 管理员在Web后台查看帖子详情
2. 访问媒体代理URL: `/media-proxy/{media_id}`
3. 验证图片和视频正常显示

**预期结果**:
- 媒体文件正常加载显示
- 响应时间在可接受范围内
- 不同格式媒体文件都能正确处理

#### TC006-P1: 定时发布任务测试
**前置条件**:
- 存在状态为 `approved` 且到达发布时间的帖子
- APScheduler定时任务服务运行正常
- Bot具有频道发布权限

**测试步骤**:
1. 设置帖子发布时间为当前时间+1分钟
2. 监控定时任务执行
3. 验证帖子发布到频道
4. 检查数据库状态更新

**预期结果**:
- 定时任务按时执行
- 帖子成功发布到指定频道
- 数据库状态更新为 `published`
- 发布失败时有适当错误处理和重试

---

### 用户故事3: 用户发现与下单流程

**业务流程**: 地区搜索/频道浏览 → 商户详情 → 创建预约 → 订单生成

#### TC007-P1: 地区搜索下单流程
**前置条件**:
- 存在已发布商户 (status = 'published')
- 用户TG ID: 987654321 (普通用户)
- 城市和地区数据完整

**测试步骤**:
1. 用户点击"地区搜索"按钮
2. 系统显示包含已发布商户的城市列表
3. 用户选择城市 "北京"
4. 系统显示北京市包含已发布商户的地区列表
5. 用户选择地区 "朝阳区"
6. 系统显示朝阳区的已发布商户列表
7. 用户选择商户查看详情
8. 用户点击"立即预约"按钮
9. 选择价格选项 (P1: 500元)
10. 确认预约信息
11. 点击"确认预约"

**预期结果**:
- 搜索流程只显示 `status = 'published'` 的商户
- 地区层级导航正确
- 商户详情信息完整展示
- 订单成功创建，状态为 `尝试预约`
- 商户收到新订单通知
- 用户收到预约成功确认

**验证点**:
```sql
-- 验证订单创建
SELECT merchant_id, customer_user_id, price, status FROM orders 
WHERE customer_user_id = 987654321 ORDER BY created_at DESC LIMIT 1;

-- 验证订单关联正确
SELECT m.name, o.price FROM merchants m 
JOIN orders o ON m.id = o.merchant_id 
WHERE o.customer_user_id = 987654321;
```

#### TC008-P2: 频道帖子下单流程
**前置条件**:
- 频道中存在已发布的商户推广帖子
- 帖子包含内联键盘"立即预约"按钮

**测试步骤**:
1. 用户在频道中点击帖子的"立即预约"按钮
2. Bot私聊用户显示预约选项
3. 完成预约流程

**预期结果**:
- 内联键盘正确传递merchant_id参数
- 预约流程与地区搜索流程一致
- 订单正确关联到对应商户

#### TC009-P3: 订单状态管理测试
**前置条件**:
- 存在不同状态的订单记录

**测试步骤**:
1. Web后台查看订单列表
2. 筛选不同状态订单
3. 修改订单状态
4. 验证状态变更日志

**预期结果**:
- 订单列表正确显示和筛选
- 状态变更操作成功
- 相关通知正确发送

---

### 用户故事4: 评价激励闭环

**业务流程**: 订单完成 → 用户评价 → 商户确认 → 积分发放 → 频道推送

#### TC010-P1: 完整评价激励流程
**前置条件**:
- 存在已完成的订单 (order_id: 100)
- 用户TG ID: 987654321，商户ID: 50
- 激励系统配置正确

**测试步骤**:
1. 模拟订单完成，系统发送评价邀请给用户
2. 用户进行五维度评分：
   - 颜值: 8分
   - 身材: 9分  
   - 服务: 8分
   - 态度: 9分
   - 环境: 7分
3. 用户提交文字评价: "服务很专业，环境很好，推荐！"
4. 系统向商户发送确认评价通知
5. 商户点击"确认此评价有效"
6. 系统为用户发放积分和经验
7. 检查用户等级和勋章变化
8. 定时任务更新商户平均分

**预期结果**:
- 评价记录正确创建，初始状态 `is_confirmed_by_merchant = FALSE`
- 商户确认后状态更新为 `TRUE`
- 用户积分和经验正确增加
- 触发等级升级检查和勋章获得检查
- 商户平均分正确更新

**验证点**:
```sql
-- 验证评价记录
SELECT * FROM reviews WHERE order_id = 100;

-- 验证用户激励更新
SELECT xp, points, level_name FROM users WHERE user_id = 987654321;

-- 验证商户平均分更新
SELECT * FROM merchant_scores WHERE merchant_id = 50;

-- 验证勋章获得 (如果触发)
SELECT b.badge_name FROM user_badges ub 
JOIN badges b ON ub.badge_id = b.id 
WHERE ub.user_id = 987654321;
```

#### TC011-P2: 虚假评价防护测试
**前置条件**:
- 用户提交了评价但商户未确认

**测试步骤**:
1. 用户完成评价提交
2. 商户长时间未确认评价
3. 检查用户是否获得积分奖励

**预期结果**:
- 未经商户确认的评价不触发积分发放
- 用户等级和经验不变
- 商户平均分计算不包含未确认评价

#### TC012-P1: 定时任务商户评分更新
**前置条件**:
- 过去24小时内有新的已确认评价
- APScheduler定时任务正常运行

**测试步骤**:
1. 等待或手动触发日常评分更新任务
2. 验证任务执行日志
3. 检查商户平均分更新

**预期结果**:
- 定时任务正确识别需要更新的商户
- 平均分计算准确
- merchant_scores表正确更新

---

## 集成测试重点

### 数据一致性验证
- **订单与商户关联**: 确保订单正确关联到永久商户ID
- **评价与激励关联**: 确保评价确认后正确触发激励计算
- **媒体文件关联**: 确保媒体文件正确关联到商户记录

### 状态机同步测试
- **FSM状态持久化**: 确保用户会话中断后状态正确恢复
- **订单状态同步**: 确保订单状态在Bot和Web后台同步
- **商户状态流转**: 确保商户状态在整个生命周期中正确流转

### 权限边界测试
- **角色权限验证**: 确保不同角色只能访问授权功能
- **商户隔离**: 确保商户只能访问自己的数据
- **管理员权限**: 确保管理员可以正确管理所有数据

---

## 性能测试场景

### 高并发测试
- 多用户同时绑定不同绑定码
- 多用户同时下单同一商户
- 定时发布任务批量处理帖子

### 数据库性能测试
- 商户搜索查询响应时间
- 用户等级和勋章查询性能
- 媒体代理文件访问响应时间

---

## 错误场景测试

### 外部依赖失败
- Telegram API调用失败
- 频道发布权限丢失
- 媒体文件下载失败

### 数据异常处理
- 绑定码重复使用
- FSM状态异常
- 评价数据不完整
- 定时任务执行异常

---

## 测试执行建议

### 执行顺序
1. **Phase 1**: 用户故事1-2 (商户入驻和审核发布)
2. **Phase 2**: 用户故事3 (用户下单流程)  
3. **Phase 3**: 用户故事4 (评价激励系统)
4. **Phase 4**: 集成测试和性能测试
5. **Phase 5**: 错误场景和边界测试

### 测试环境要求
- 独立的测试数据库
- 测试专用Telegram Bot
- 测试频道/群组
- Web后台测试环境
- 定时任务测试配置

### 关键验证脚本
建议为每个测试用例准备对应的数据库验证SQL脚本，确保测试结果的准确性和可重复性。

---

## 风险评估

### 高风险点
- **数据库迁移**: 确保V1到V2的数据完整迁移
- **永久ID系统**: 确保商户身份绑定的稳定性
- **评价确认机制**: 防止虚假评价影响系统公信力
- **定时任务可靠性**: 确保帖子按时发布和状态更新

### 监控指标
- 商户绑定成功率
- 信息收集完成率  
- 审核通过率
- 帖子发布成功率
- 用户下单转化率
- 评价完成率和确认率

此测试计划确保V2.0系统的核心业务流程稳定可靠，为系统上线提供质量保障。