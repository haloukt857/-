# -*- coding: utf-8 -*-
"""
FastHTML Webç®¡ç†é¢æ¿
æ ¸å¿ƒåº”ç”¨æ–‡ä»¶ï¼Œæä¾›å¸ƒå±€ã€è®¤è¯ã€UIç»„ä»¶å’Œæ ¹è·¯ç”±ï¼ˆä»ªè¡¨æ¿ï¼‰ã€‚
"""

import logging
import os
import time
import hashlib
import asyncio
from typing import Optional, Dict, Any, List, Callable, Union
from datetime import datetime

from fasthtml.common import *
import secrets
import os
import time
from starlette.middleware.sessions import SessionMiddleware
from starlette.responses import RedirectResponse, HTMLResponse
from starlette.exceptions import HTTPException as StarletteHTTPException
from starlette.staticfiles import StaticFiles
from starlette.requests import Request

# å¯¼å…¥æ•°æ®åº“ç®¡ç†å™¨
from database.db_merchants import merchant_manager
from database.db_regions import region_manager
from database.db_users import user_manager
from database.db_incentives import incentive_manager
from database.db_reviews import review_manager
from database.db_binding_codes import binding_codes_manager
from database.db_media import media_db
from database.db_orders import OrderManager
from utils.enums import MERCHANT_STATUS, ORDER_STATUS
from web.posts_routes_v2 import (
    POST_STATUS_DISPLAY_MAP, POST_STATUS_ACTIONS,
    get_posts_status_color, get_posts_next_status_options,
    generate_posts_quick_action_buttons
)
from web.orders_routes_v2 import (
    ORDER_STATUS_DISPLAY_MAP, ORDER_STATUS_COLORS, ORDER_STATUS_ICONS,
    get_order_status_color, get_order_status_icon,
    get_order_next_status_options, generate_order_action_buttons,
    generate_order_batch_operations, generate_order_statistics_panel
)
from database.db_system_config import system_config_manager

# å¯¼å…¥å¸ƒå±€å’Œè®¤è¯ç»„ä»¶
from web.layout import create_layout, require_auth, okx_button, okx_input, okx_textarea, okx_select, okx_form_group

# å¯¼å…¥é¡¹ç›®é…ç½®
from config import WEB_CONFIG

logger = logging.getLogger(__name__)

# --- UI & App Setup ---

daisyui_css = Link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css")
tailwind_css = Script(src="https://cdn.tailwindcss.com")
okx_theme_css = Link(rel="stylesheet", href="/static/css/okx-theme.css")

app = FastHTML(hdrs=[daisyui_css, tailwind_css, okx_theme_css, Meta(name="viewport", content="width=device-width, initial-scale=1.0")])

app.mount("/static", StaticFiles(directory="static"), name="static")

# æ³¨å†Œè®¢é˜…éªŒè¯è·¯ç”±
@app.get("/subscription")
@require_auth
async def subscription_page(request: Request):
    """è®¢é˜…éªŒè¯ç®¡ç†é¡µé¢"""
    try:
        # è·å–å½“å‰é…ç½®
        config = await system_config_manager.get_config(
            'subscription_verification_config',
            {"enabled": False, "required_subscriptions": []}
        )
        
        # è·å–ç»Ÿè®¡æ•°æ®
        stats = {
            'daily_verifications': 0,
            'daily_failures': 0,  
            'pass_rate': 100.0,
            'weekly_verifications': 0
        }
        
        # çŠ¶æ€æŒ‡ç¤ºå™¨
        status_text = "å·²å¯ç”¨" if config.get('enabled', False) else "å·²ç¦ç”¨"
        status_color = "text-success" if config.get('enabled', False) else "text-error"
        status_icon = "ğŸŸ¢" if config.get('enabled', False) else "ğŸ”´"
        
        status_indicator = Div(
            Div(
                Span(status_icon, cls="text-2xl"),
                Div(
                    H3("è®¢é˜…éªŒè¯çŠ¶æ€", cls="text-lg font-semibold"),
                    P(status_text, cls=f"text-sm {status_color}")
                ), cls="ml-3"
            ), cls="flex items-center"
        ), cls="bg-white p-6 rounded-lg shadow mb-6"
        
        # ç»Ÿè®¡å¡ç‰‡
        stats_cards = Div(
            Div(Div(Span("ğŸ“º", cls="text-3xl"), Div(P("é…ç½®é¢‘é“", cls="text-sm text-gray-500"), P(str(len(config.get('required_subscriptions', []))), cls="text-2xl font-bold text-primary")), cls="flex items-center gap-3"), cls="stat-card"),
            Div(Div(Span("ğŸ”", cls="text-3xl"), Div(P("ä»Šæ—¥éªŒè¯", cls="text-sm text-gray-500"), P(str(stats['daily_verifications']), cls="text-2xl font-bold text-info")), cls="flex items-center gap-3"), cls="stat-card"),
            Div(Div(Span("âœ…", cls="text-3xl"), Div(P("é€šè¿‡ç‡", cls="text-sm text-gray-500"), P(f"{stats['pass_rate']:.1f}%", cls="text-2xl font-bold text-success")), cls="flex items-center gap-3"), cls="stat-card"),
            Div(Div(Span("âŒ", cls="text-3xl"), Div(P("ä»Šæ—¥å¤±è´¥", cls="text-sm text-gray-500"), P(str(stats['daily_failures']), cls="text-2xl font-bold text-warning")), cls="flex items-center gap-3"), cls="stat-card"),
            cls="stats-container"
        )
        
        # å·¥å…·æ 
        toggle_button_text = "ğŸ”´ ç¦ç”¨éªŒè¯" if config.get('enabled', False) else "ğŸŸ¢ å¯ç”¨éªŒè¯"
        toggle_button_class = "btn btn-warning btn-sm" if config.get('enabled', False) else "btn btn-success btn-sm"
        
        toolbar = Div(
            Div(
                H3("ç³»ç»Ÿæ§åˆ¶", cls="content-section-title"),
                P("é¢‘é“è®¢é˜…éªŒè¯ç³»ç»Ÿçš„å¼€å…³å’Œç®¡ç†", cls="text-sm text-gray-500")
            ),
            Div(
                Form(
                    Button(toggle_button_text, type="submit", cls=toggle_button_class),
                    method="post", action="/subscription/toggle", cls="inline-block mr-3"
                ),
                cls="action-buttons"
            ),
            cls="toolbar-container"
        )
        
        # é¢‘é“é…ç½®åŒºåŸŸ
        channels = config.get('required_subscriptions', [])
        if channels:
            channels_list = Div(
                *[Div(
                    Div(
                        H4(channel.get('display_name', 'æœªå‘½åé¢‘é“'), cls="font-semibold"),
                        P(f"ID: {channel.get('chat_id', 'N/A')}", cls="text-sm text-gray-600"),
                        P(f"é“¾æ¥: {channel.get('join_link', 'N/A')}", cls="text-sm text-gray-600")
                    ),
                    A("åˆ é™¤", href=f"/subscription/channel/{i}/delete", cls="btn btn-error btn-sm"),
                    cls="flex justify-between items-center p-4 border rounded-lg"
                ) for i, channel in enumerate(channels)]
            )
        else:
            channels_list = Div(
                P("æš‚æ— é…ç½®é¢‘é“", cls="text-gray-500 text-center py-8"),
                cls=""
            )
            
        channels_table = Div(
            Div(
                H3("ğŸ“º é¢‘é“é…ç½®", cls="content-section-title"),
                Div(channels_list, cls="data-table-container")
            )
        )
        
        # æ·»åŠ é¢‘é“è¡¨å•
        add_channel_form = Form(
            Div(
                H3("â• æ·»åŠ é¢‘é“", cls="text-lg font-semibold mb-4"),
                Div(
                    Label("é¢‘é“åç§°", cls="label label-text"),
                    Input(name="display_name", placeholder="å¦‚ï¼šå®˜æ–¹é¢‘é“", cls="input input-bordered w-full"),
                    cls="form-control w-full mb-4"
                ),
                Div(
                    Label("é¢‘é“ID", cls="label label-text"),
                    Input(name="chat_id", placeholder="@channel æˆ– -1001234567890", cls="input input-bordered w-full"),
                    cls="form-control w-full mb-4"
                ),
                Div(
                    Label("åŠ å…¥é“¾æ¥", cls="label label-text"),
                    Input(name="join_link", placeholder="https://t.me/channel", cls="input input-bordered w-full"),
                    cls="form-control w-full mb-4"
                ),
                Button("æ·»åŠ é¢‘é“", type="submit", cls="btn btn-primary w-full"),
                cls="space-y-4"
            ),
            method="post", action="/subscription/channel/add", cls="card bg-base-100 shadow-lg p-6"
        )
        
        content = Div(
            Div(H1("é¢‘é“è®¢é˜…éªŒè¯ç®¡ç†", cls="page-title"), cls="page-header"),
            status_indicator,
            stats_cards, 
            toolbar,
            Div(
                Div(channels_table, cls="lg:col-span-2"),
                Div(add_channel_form, cls="space-y-6"),
                cls="content-grid grid-3"
            )
        )
        
        return create_layout("é¢‘é“è®¢é˜…éªŒè¯ç®¡ç†", content)
        
    except Exception as e:
        logger.error(f"è®¢é˜…éªŒè¯é¡µé¢åŠ è½½å¤±è´¥: {e}")
        error_content = Div(
            H1("é¡µé¢åŠ è½½å¤±è´¥", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"é”™è¯¯ä¿¡æ¯: {str(e)}", cls="text-red-500")
        )
        return create_layout("é”™è¯¯", error_content)

app.add_middleware(SessionMiddleware, secret_key=WEB_CONFIG.get("secret_key", "your-secret-key-here"), max_age=86400)

# --- ç®€æ˜“ç¼“å­˜ï¼ˆé¦–é¡µä»ªè¡¨æ¿ï¼‰ ---
DASHBOARD_CACHE_TTL = int(os.getenv("DASHBOARD_CACHE_TTL", "5"))  # ç§’
_dashboard_cache_ts: float = 0.0
_dashboard_cache_payload: Dict[str, Any] = {}

# --- å¼‚å¸¸å¤„ç† ---

@app.exception_handler(StarletteHTTPException)
async def http_exception_handler(request: Request, exc: StarletteHTTPException):
    """å¤„ç†HTTPå¼‚å¸¸"""
    if exc.status_code == 404:
        content = create_layout(
            "é¡µé¢æœªæ‰¾åˆ°",
            Div(
                H2("é¡µé¢æœªæ‰¾åˆ°", cls="text-2xl font-bold mb-4"),
                P("æ‚¨è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨ã€‚"),
                A("è¿”å›é¦–é¡µ", href="/", cls="btn btn-primary mt-4")
            )
        )
        return HTMLResponse(str(content), status_code=404)
    
    content = create_layout(
        "æœåŠ¡å™¨é”™è¯¯",
        Div(
            H2("æœåŠ¡å™¨é”™è¯¯", cls="text-2xl font-bold mb-4"),
            P(f"å‘ç”Ÿäº†é”™è¯¯: {exc.detail}"),
            A("è¿”å›é¦–é¡µ", href="/", cls="btn btn-primary mt-4")
        )
    )
    return HTMLResponse(str(content), status_code=exc.status_code)

# --- è®¤è¯ã€CSRF ä¸å·¥å…·ï¼ˆå›ç½®åˆ°æœ¬æ–‡ä»¶ï¼Œé¿å…ä¾èµ–ï¼‰ ---

class AuthManager:
    """Webåå°è®¤è¯ç®¡ç†å™¨"""

    @staticmethod
    def hash_password(password: str) -> str:
        return hashlib.sha256(password.encode()).hexdigest()

    @staticmethod
    def verify_password(password: str, hashed: str) -> bool:
        return hashlib.sha256(password.encode()).hexdigest() == hashed

    @staticmethod
    def is_admin_session(request: Request) -> bool:
        return request.session.get('is_admin', False)

    @staticmethod
    def login_admin(request: Request, admin_id: int) -> bool:
        from config import ADMIN_IDS
        if admin_id in ADMIN_IDS:
            request.session['is_admin'] = True
            request.session['admin_id'] = admin_id
            return True
        return False

    @staticmethod
    def logout(request: Request) -> None:
        request.session.clear()


def require_auth(func: Callable) -> Callable:
    import functools
    @functools.wraps(func)
    async def wrapper(*args: Any, **kwargs: Any) -> Union[RedirectResponse, Any]:
        request = args[0] if args else kwargs.get('request')
        if not request or not AuthManager.is_admin_session(request):
            return RedirectResponse(url="/login", status_code=302)
        if asyncio.iscoroutinefunction(func):
            return await func(*args, **kwargs)
        else:
            return func(*args, **kwargs)
    return wrapper


def get_or_create_csrf_token(request: Request) -> str:
    token = request.session.get("csrf_token")
    if not token:
        token = secrets.token_urlsafe(32)
        request.session["csrf_token"] = token
    return token


def validate_csrf(request: Request, token: str) -> bool:
    expected = request.session.get("csrf_token")
    return bool(expected and token and secrets.compare_digest(str(token), str(expected)))


def _okx_css_version() -> str:
    try:
        path = os.path.join("static", "css", "okx-theme.css")
        mtime = os.path.getmtime(path)
        return str(int(mtime))
    except Exception:
        return str(int(time.time()))

# è®¢é˜…ç»Ÿè®¡ï¼šä½¿ç”¨æœåŠ¡å±‚ï¼Œé¿å…è·¨æ¨¡å—ç¯


def create_layout(title: str, content, show_nav: bool = True):
    """åˆ›å»ºé¡µé¢å¸ƒå±€ - ç»Ÿä¸€å¸ƒå±€æ ‡å‡†"""
    # èœå•é¡¹å®šä¹‰ï¼ˆé¿å…é‡å¤ï¼‰
    menu_items = [
        ("ä»ªè¡¨æ¿", "/", "/"),
        ("å•†æˆ·ç®¡ç†", "/merchants", "/merchants"),
        ("å¸–å­ç®¡ç†", "/posts", "/posts"),
        ("è®¢å•ç®¡ç†", "/orders", "/orders"),
        ("è¯„ä»·ç®¡ç†", "/reviews", "/reviews"),
        ("è®¢é˜…éªŒè¯", "/subscription", "/subscription"),
        ("ç»‘å®šç ", "/binding-codes", "/binding-codes"),
        ("åœ°åŒºç®¡ç†", "/regions", "/regions"),
        ("æ¿€åŠ±ç³»ç»Ÿ", "/incentives", "/incentives"),
    ]
    
    # ç”¨æˆ·ä¸­å¿ƒå­èœå•
    user_submenu = [
        ("ç”¨æˆ·åˆ—è¡¨", "/users", "/users"),
        ("ç”¨æˆ·åˆ†æ", "/users/analytics", "/users/analytics"),
    ]
    
    # åˆ›å»ºèœå•é¡¹çš„å‡½æ•°
    def create_menu_items(for_mobile=False):
        items = []
        for name, href, data_href in menu_items:
            items.append(Li(A(name, href=href, **{"data-href": data_href})))
        
        # æ·»åŠ ç”¨æˆ·ä¸­å¿ƒä¸‹æ‹‰èœå•
        user_menu = Details(
            Summary("ç”¨æˆ·ä¸­å¿ƒ"),
            Ul(
                *[Li(A(name, href=href, **{"data-href": data_href})) for name, href, data_href in user_submenu]
            )
        )
        items.insert(4, Li(user_menu))  # åœ¨è®¢å•ç®¡ç†åæ’å…¥
        return items
    
    nav = Nav(
        Div(
            # å·¦ä¾§ï¼šç§»åŠ¨ç«¯èœå•
            Div(
                # ç§»åŠ¨ç«¯ä¸‹æ‹‰èœå•
                Div(
                    Label(
                        Span("â˜°", cls="text-xl"),
                        tabindex="0",
                        cls="btn btn-ghost lg:hidden"
                    ),
                    Ul(
                        *create_menu_items(for_mobile=True),
                        cls="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-56"
                    ),
                    cls="dropdown"
                ),
                cls="navbar-start"
            ),

            # ä¸­é—´ï¼šæ¡Œé¢èœå•
            Div(
                Ul(
                    *create_menu_items(),
                    cls="menu menu-horizontal px-1 hidden lg:flex"
                ),
                id="main-nav",
                cls="navbar-center"
            ),

            # å³ä¾§ï¼šæ“ä½œ
            Div(
                A("é€€å‡º", href="/logout", cls="btn btn-sm btn-outline"),
                cls="navbar-end"
            ),
            # ä½¿ç”¨ä¸é¡µé¢å†…å®¹ç›¸åŒçš„å®¹å™¨æ ·å¼
            style="max-width: 1200px; margin: 0 auto; padding: 0 1.5rem;"
        ),
        cls="navbar bg-base-100 shadow sticky top-0 z-50"
    ) if show_nav else ""
    
    return Html(
        Head(
            Title(title),
            Meta(charset="utf-8"),
            Meta(name="viewport", content="width=device-width, initial-scale=1.0"),
            # æ·»åŠ CSSæ ·å¼é“¾æ¥
            Link(rel="preconnect", href="https://cdn.jsdelivr.net"),
            Link(rel="dns-prefetch", href="https://cdn.jsdelivr.net"),
            Link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"),
            Script(src="https://cdn.tailwindcss.com"),
            Link(rel="stylesheet", href=f"/static/css/okx-theme.css?v={_okx_css_version()}"),
        ),
        Body(
            nav,
            # ä½¿ç”¨ç»Ÿä¸€çš„é¡µé¢å®¹å™¨ç±»
            Div(
                content,
                cls="page-container"
            ),
            # æ¿€æ´»å½“å‰å¯¼èˆªé¡¹çš„å°è„šæœ¬ï¼ˆåŸºäº data-href å‰ç¼€åŒ¹é…ï¼‰
            Script(
                """
                document.addEventListener('DOMContentLoaded', function(){
                  var path = location.pathname;
                  document.querySelectorAll('#main-nav a[data-href]').forEach(function(a){
                    var href = a.getAttribute('data-href');
                    var isActive = (href === '/' && path === '/') || (href !== '/' && path.startsWith(href));
                    if (isActive) {
                      a.classList.add('active','btn-active');
                    }
                  });
                });
                """
            ),
            # ç®€æ˜“æ ·å¼æ£€æµ‹æŒ‡ç¤ºå™¨ï¼ˆä»…å‰ç«¯æ£€æµ‹ï¼Œä¸å½±å“åŠŸèƒ½ï¼‰
            Script(
                """
                document.addEventListener('DOMContentLoaded', function(){
                  try {
                    var bg = getComputedStyle(document.body).backgroundColor;
                    var fg = getComputedStyle(document.body).color;
                    var ok = (bg === 'rgb(0, 0, 0)' && fg === 'rgb(255, 255, 255)');
                    var el = document.createElement('div');
                    el.textContent = ok ? 'OKX CSS âœ“' : 'CSS æœªç”Ÿæ•ˆ';
                    el.setAttribute('title', 'ç‚¹å‡»éšè—');
                    el.style.cssText = 'position:fixed;right:10px;bottom:10px;z-index:9999;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer;opacity:0.9;'+
                                      (ok ? 'background:#10b981;color:#000' : 'background:#ef4444;color:#fff');
                    el.onclick = function(){ this.remove(); };
                    document.body.appendChild(el);
                  } catch (e) { /* å¿½ç•¥ */ }
                });
                """
            ),
            cls="min-h-screen bg-gray-50"
        )
    )

# --- è®¢é˜…ç»Ÿè®¡å ä½ï¼ˆé¿å…å¾ªç¯å¯¼å…¥ï¼Œä»…ç”¨äºé¡µé¢æ¸²æŸ“ï¼›å¦‚éœ€çœŸå®æ•°æ®è¯·æ›¿æ¢å®ç°ï¼‰ ---

async def _subscription_stats_impl() -> Dict[str, Any]:
    try:
        return {
            'daily_verifications': 0,
            'daily_failures': 0,
            'pass_rate': 100.0,
            'weekly_verifications': 0,
        }
    except Exception:
        return {
            'daily_verifications': 0,
            'daily_failures': 0,
            'pass_rate': 0.0,
            'weekly_verifications': 0,
        }

# --- è°ƒè¯•è·¯ç”±ï¼šæ ·å¼æ£€æŸ¥ ---

@app.get("/debug/style-check")
@require_auth
def style_check(_: Request):
    """æ£€æŸ¥è‡ªå®šä¹‰æ ·å¼æ˜¯å¦ç”Ÿæ•ˆçš„ç®€å•é¡µé¢"""
    content = Div(
        H1("æ ·å¼è‡ªæ£€", cls="text-2xl font-bold mb-4"),
        P("ç”¨äºéªŒè¯ /static/css/okx-theme.css æ˜¯å¦è¢«æµè§ˆå™¨åº”ç”¨ã€‚", cls="text-sm text-gray-400 mb-4"),

        Div(
            Div(
                Span("æ£€æµ‹ç»“æœ: ", cls="font-semibold"),
                Span("æ£€æµ‹ä¸­...", id="okx-result", cls="badge"),
            ),
            Div(
                P([Span("Body èƒŒæ™¯è‰²: ", cls="text-gray-400"), Code("N/A", id="okx-bg")]),
                P([Span("Body æ–‡å­—è‰²: ", cls="text-gray-400"), Code("N/A", id="okx-fg")]),
                P([Span("æŒ‰é’®ç¤ºä¾‹: ", cls="text-gray-400"), Button("ä¸»è¦æŒ‰é’®", cls="btn btn-primary btn-sm ml-2"), Button("å¹½çµæŒ‰é’®", cls="btn btn-ghost btn-sm ml-2")]),
                P([Span("å¡ç‰‡ç¤ºä¾‹: ", cls="text-gray-400"), Span("ï¼ˆä¸‹æ–¹å¡ç‰‡åº”ä¸ºæ·±è‰²èƒŒæ™¯ï¼‰")]),
            ),
            cls="mb-6"
        ),

        Div(
            Div(
                H3("ç¤ºä¾‹å¡ç‰‡", cls="text-lg font-semibold mb-2"),
                P("å¦‚æœè‡ªå®šä¹‰æ ·å¼ç”Ÿæ•ˆï¼Œæ­¤å¡ç‰‡åº”ä¸ºæ·±è‰²èƒŒæ™¯ï¼Œç™½è‰²æ–‡å­—ã€‚", cls="text-sm text-gray-400"),
                cls="card-body"
            ),
            cls="card"
        ),

        Script(
            """
            document.addEventListener('DOMContentLoaded', function(){
              const bg = getComputedStyle(document.body).backgroundColor;
              const fg = getComputedStyle(document.body).color;
              const ok = (bg === 'rgb(0, 0, 0)' && fg === 'rgb(255, 255, 255)');
              const result = document.getElementById('okx-result');
              result.textContent = ok ? 'OKX ä¸»é¢˜ç”Ÿæ•ˆ' : 'æœªç”Ÿæ•ˆæˆ–è¢«è¦†ç›–';
              result.className = 'badge ' + (ok ? 'badge-success' : 'badge-warning') + ' text-white';
              document.getElementById('okx-bg').textContent = bg;
              document.getElementById('okx-fg').textContent = fg;
            });
            """
        ),
    )
    return create_layout("æ ·å¼è‡ªæ£€", content)

def okx_button(text: str, **kwargs):
    """OKXä¸»é¢˜æŒ‰é’®ç»„ä»¶"""
    cls = kwargs.pop('cls', 'btn btn-primary')
    return Button(text, cls=cls, **kwargs)

def okx_input(name: str = None, **kwargs):
    """OKXä¸»é¢˜è¾“å…¥æ¡†ç»„ä»¶"""
    cls = kwargs.pop('cls', 'input input-bordered w-full')
    if name:
        kwargs['name'] = name
    return Input(cls=cls, **kwargs)

def okx_textarea(name: str = None, **kwargs):
    """OKXä¸»é¢˜æ–‡æœ¬åŸŸç»„ä»¶"""
    cls = kwargs.pop('cls', 'textarea textarea-bordered w-full')
    content = kwargs.pop('content', '')
    if name:
        kwargs['name'] = name
    return Textarea(content, cls=cls, **kwargs)

def okx_select(name: str = None, options: list = None, **kwargs):
    """OKXä¸»é¢˜é€‰æ‹©æ¡†ç»„ä»¶"""
    cls = kwargs.pop('cls', 'select select-bordered w-full')
    selected = kwargs.pop('selected', None)
    if name:
        kwargs['name'] = name
    
    select_options = []
    if options:
        for option in options:
            if isinstance(option, tuple):
                value, label = option
                is_selected = (str(value) == str(selected)) if selected is not None else False
                select_options.append(Option(label, value=value, selected=is_selected))
            else:
                is_selected = (str(option) == str(selected)) if selected is not None else False
                select_options.append(Option(option, value=option, selected=is_selected))
    
    return Select(*select_options, cls=cls, **kwargs)

def okx_form_group(label: str, input_element, help_text: str = None, **kwargs):
    """OKXä¸»é¢˜è¡¨å•ç»„ç»„ä»¶"""
    elements = [
        Label(label, cls="label label-text"),
        input_element
    ]
    if help_text:
        elements.append(P(help_text, cls="text-sm text-gray-500 mt-1"))
    
    return Div(
        *elements,
        cls="form-control w-full mb-4",
        **kwargs
    )

# --- è®¢é˜…éªŒè¯ï¼ˆFastHTML åŸç”Ÿè·¯ç”±ï¼‰ ---

@app.get("/subscription-old")
@require_auth
async def subscription_dashboard(_: Request):
    try:
        config = await system_config_manager.get_config(
            'subscription_verification_config',
            {"enabled": False, "required_subscriptions": []}
        )
        stats = await _subscription_stats_impl()
    except Exception as e:
        logger.error(f"è·å–è®¢é˜…éªŒè¯æ•°æ®å¤±è´¥: {e}")
        raise StarletteHTTPException(status_code=500, detail="æ— æ³•è·å–è®¢é˜…éªŒè¯æ•°æ®")

    status_indicator = Div(
        Div(
            Span("ğŸŸ¢" if config.get("enabled") else "ğŸ”´", cls="text-2xl"),
            Div(
                H3("è®¢é˜…éªŒè¯çŠ¶æ€", cls="text-lg font-semibold"),
                P("å·²å¯ç”¨" if config.get("enabled") else "å·²ç¦ç”¨", cls=f"text-sm {'text-success' if config.get('enabled') else 'text-error'}"),
                cls="ml-3"
            ),
            cls="flex items-center"
        ),
        cls="bg-white p-6 rounded-lg shadow mb-6"
    )

    channels = config.get("required_subscriptions", [])
    channel_rows = []
    for i, channel in enumerate(channels):
        channel_rows.append(
            Tr(
                Td(str(i + 1), cls="font-mono text-sm"),
                Td(Div(Strong(channel.get("display_name", "æœªå‘½å")), P(channel.get("chat_id", ""), cls="text-xs text-gray-500 font-mono"), cls="space-y-1")),
                Td(A("ğŸ”—", href=channel.get("join_link", "#"), target="_blank", cls="btn btn-ghost btn-xs") if channel.get("join_link") else "æ— é“¾æ¥", cls="text-center"),
                Td(Div(
                    A("âœï¸", href=f"/subscription/channel/{i}/edit", cls="btn btn-ghost btn-xs", title="ç¼–è¾‘"),
                    A("ğŸ—‘ï¸", href=f"/subscription/channel/{i}/delete", cls="btn btn-ghost btn-xs text-error", title="åˆ é™¤", onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤é¢‘é“é…ç½®ï¼Ÿ')"),
                    cls="flex gap-1"
                ))
            )
        )

    channels_table = Div(
        H3("ğŸ“º é¢‘é“é…ç½®", cls="content-section-title"),
        Div(
            Table(
                Thead(Tr(Th("#"), Th("é¢‘é“ä¿¡æ¯"), Th("åŠ å…¥é“¾æ¥", cls="text-center"), Th("æ“ä½œ", cls="w-20"))),
                Tbody(*channel_rows),
                cls="table table-zebra w-full"
            ) if channel_rows else Div(
                P("æš‚æ— é…ç½®é¢‘é“", cls="text-gray-500 text-center py-8"),
                A("+ æ·»åŠ é¢‘é“", href="/subscription/channel/add", cls="btn btn-primary btn-sm")
            ),
            cls="data-table-container"
        )
    )

    add_channel_form = Form(
        Div(
            H3("â• æ·»åŠ é¢‘é“", cls="text-lg font-semibold mb-4"),
            okx_form_group("é¢‘é“åç§°", okx_input("display_name", placeholder="å¦‚ï¼šå®˜æ–¹é¢‘é“")),
            okx_form_group("é¢‘é“ID", okx_input("chat_id", placeholder="@channel æˆ– -1001234567890")),
            okx_form_group("åŠ å…¥é“¾æ¥", okx_input("join_link", placeholder="https://t.me/channel")),
            okx_button("æ·»åŠ é¢‘é“", type="submit", cls="btn btn-primary w-full"),
            cls="space-y-4"
        ),
        method="post", action="/subscription/channel/add",
        cls="card bg-base-100 shadow-lg p-6"
    )

    toolbar = Div(
        Div(H3("ç³»ç»Ÿæ§åˆ¶", cls="content-section-title"), P("é¢‘é“è®¢é˜…éªŒè¯ç³»ç»Ÿçš„å¼€å…³å’Œç®¡ç†", cls="text-sm text-gray-500")),
        Div(
            Form(okx_button("ğŸ”´ ç¦ç”¨éªŒè¯" if config.get("enabled") else "ğŸŸ¢ å¯ç”¨éªŒè¯", type="submit", cls=f"btn {'btn-error' if config.get('enabled') else 'btn-success'} btn-sm"), method="post", action="/subscription/toggle", cls="inline-block mr-3"),
            A("ğŸ“Š éªŒè¯æ—¥å¿—", href="/subscription/logs", cls="btn btn-info btn-sm mr-3"),
            A("âš™ï¸ é¢‘é“é…ç½®", href="/subscription/channels", cls="btn btn-secondary btn-sm mr-3"),
            A("ğŸ“ˆ æ•°æ®åˆ†æ", href="/subscription/analytics", cls="btn btn-outline btn-sm"),
            cls="action-buttons"
        ),
        cls="toolbar-container"
    )

    stats_cards = Div(
        Div(Div(Span("ğŸ“º", cls="text-3xl"), Div(P("é…ç½®é¢‘é“", cls="text-sm text-gray-500"), P(str(len(channels)), cls="text-2xl font-bold text-primary")), cls="flex items-center gap-3"), cls="stat-card"),
        Div(Div(Span("ğŸ”", cls="text-3xl"), Div(P("ä»Šæ—¥éªŒè¯", cls="text-sm text-gray-500"), P(str(stats['daily_verifications']), cls="text-2xl font-bold text-info")), cls="flex items=center gap-3"), cls="stat-card"),
        Div(Div(Span("âœ…", cls="text-3xl"), Div(P("é€šè¿‡ç‡", cls="text-sm text-gray-500"), P(f"{stats['pass_rate']:.1f}%", cls="text-2xl font-bold text-success")), cls="flex items-center gap-3"), cls="stat-card"),
        Div(Div(Span("âŒ", cls="text-3xl"), Div(P("ä»Šæ—¥å¤±è´¥", cls="text-sm text-gray-500"), P(str(stats['daily_failures']), cls="text-2xl font-bold text-warning")), cls="flex items-center gap-3"), cls="stat-card"),
        cls="stats-container"
    )

    content = Div(
        Div(H1("é¢‘é“è®¢é˜…éªŒè¯ç®¡ç†", cls="page-title"), A("æŸ¥çœ‹åˆ†æ", href="/subscription/analytics", cls="btn btn-outline btn-sm"), cls="page-header"),
        status_indicator,
        stats_cards,
        toolbar,
        Div(Div(channels_table, cls="lg:col-span-2"), Div(add_channel_form, cls="space-y-6"), cls="content-grid grid-3")
    )

    return create_layout("é¢‘é“è®¢é˜…éªŒè¯ç®¡ç†", content)

@app.post("/subscription-old/toggle")
@require_auth
async def toggle_subscription_verification(_: Request):
    try:
        config = await system_config_manager.get_config('subscription_verification_config', {"enabled": False, "required_subscriptions": []})
        config["enabled"] = not config.get("enabled", False)
        await system_config_manager.set_config('subscription_verification_config', config, 'é¢‘é“è®¢é˜…éªŒè¯é…ç½®')
        return RedirectResponse(url="/subscription?status_changed=1", status_code=302)
    except Exception as e:
        logger.error(f"åˆ‡æ¢è®¢é˜…éªŒè¯çŠ¶æ€å¤±è´¥: {e}")
        return RedirectResponse(url="/subscription?error=toggle_failed", status_code=302)

@app.post("/subscription-old/channel/add")
@require_auth
async def add_subscription_channel(request: Request):
    form = await request.form()
    try:
        display_name = form.get('display_name', '').strip()
        chat_id = form.get('chat_id', '').strip()
        join_link = form.get('join_link', '').strip()
        if not display_name or not chat_id:
            return RedirectResponse(url="/subscription?error=missing_fields", status_code=302)
        config = await system_config_manager.get_config('subscription_verification_config', {"enabled": False, "required_subscriptions": []})
        existing_ids = [sub.get("chat_id") for sub in config.get("required_subscriptions", [])]
        if chat_id in existing_ids:
            return RedirectResponse(url="/subscription?error=duplicate_chat_id", status_code=302)
        new_channel = {"chat_id": chat_id, "display_name": display_name, "join_link": join_link or None}
        config.setdefault("required_subscriptions", []).append(new_channel)
        await system_config_manager.set_config('subscription_verification_config', config, 'é¢‘é“è®¢é˜…éªŒè¯é…ç½®')
        return RedirectResponse(url="/subscription?channel_added=1", status_code=302)
    except Exception as e:
        logger.error(f"æ·»åŠ é¢‘é“å¤±è´¥: {e}")
        return RedirectResponse(url="/subscription?error=add_failed", status_code=302)

@app.get("/subscription-old/channel/{index:int}/delete")
@require_auth
async def delete_subscription_channel(request: Request):
    try:
        index = int(request.path_params['index'])
        config = await system_config_manager.get_config('subscription_verification_config', {"enabled": False, "required_subscriptions": []})
        subs = config.get("required_subscriptions", [])
        if 0 <= index < len(subs):
            subs.pop(index)
            await system_config_manager.set_config('subscription_verification_config', config, 'é¢‘é“è®¢é˜…éªŒè¯é…ç½®')
            return RedirectResponse(url="/subscription?channel_deleted=1", status_code=302)
        return RedirectResponse(url="/subscription?error=invalid_index", status_code=302)
    except Exception as e:
        logger.error(f"åˆ é™¤é¢‘é“å¤±è´¥: {e}")
        return RedirectResponse(url="/subscription?error=delete_failed", status_code=302)

# --- æ ¸å¿ƒè·¯ç”± (ä»…ä¿ç•™æ ¹è·¯ç”±/ä»ªè¡¨æ¿) ---

@app.get("/login")
def login_page(request: Request):
    """ç™»å½•é¡µé¢"""
    if AuthManager.is_admin_session(request):
        return RedirectResponse(url="/", status_code=302)
    
    login_form = Form(
        Div(
            H2("ç®¡ç†å‘˜ç™»å½•", cls="text-2xl font-bold text-center mb-6"),
            Div(
                okx_form_group("å¯†ç ", okx_input("password", type="password", placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ")),
                okx_button("ç™»å½•", type="submit", cls="btn btn-primary w-full"),
                cls="space-y-4"
            ),
            cls="card-body"
        ),
        method="post",
        action="/login",
        cls="card w-full max-w-sm mx-auto mt-16 shadow-xl bg-base-100"
    )
    
    return create_layout("ç®¡ç†å‘˜ç™»å½•", login_form, show_nav=False)

@app.post("/login")
async def login_submit(request: Request):
    """å¤„ç†ç™»å½•æäº¤"""
    form = await request.form()
    password = form.get('password', '')
    
    # éªŒè¯ç®¡ç†å‘˜å¯†ç 
    from config import WEB_CONFIG
    admin_password = WEB_CONFIG.get("admin_password", "admin123")
    
    if AuthManager.verify_password(password, AuthManager.hash_password(admin_password)):
        # ä½¿ç”¨é»˜è®¤ç®¡ç†å‘˜IDç™»å½•
        from config import ADMIN_IDS
        admin_id = ADMIN_IDS[0] if ADMIN_IDS else 1
        AuthManager.login_admin(request, admin_id)
        return RedirectResponse(url="/", status_code=302)
    
    # ç™»å½•å¤±è´¥ï¼Œé‡æ–°æ˜¾ç¤ºç™»å½•é¡µé¢
    error_form = Form(
        Div(
            H2("ç®¡ç†å‘˜ç™»å½•", cls="text-2xl font-bold text-center mb-6"),
            Div(
                Div("å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•", cls="alert alert-error mb-4"),
                okx_form_group("å¯†ç ", okx_input("password", type="password", placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ")),
                okx_button("ç™»å½•", type="submit", cls="btn btn-primary w-full"),
                cls="space-y-4"
            ),
            cls="card-body"
        ),
        method="post",
        action="/login",
        cls="card w-full max-w-sm mx-auto mt-16 shadow-xl bg-base-100"
    )
    
    return create_layout("ç®¡ç†å‘˜ç™»å½•", error_form, show_nav=False)

@app.get("/logout")
def logout(request: Request):
    """ç™»å‡º"""
    AuthManager.logout(request)
    return RedirectResponse(url="/login", status_code=302)

@app.get("/")
async def dashboard(request: Request):
    """ä»ªè¡¨æ¿é¡µé¢ - åŸºäºå®é™…æ•°æ®çš„ç»Ÿè®¡æ˜¾ç¤º"""
    # ç®€æ˜“ç¼“å­˜å‘½ä¸­ï¼šå‡å°‘é¢‘ç¹ COUNT/èšåˆå¯¼è‡´çš„é¦–å±æŠ–åŠ¨
    global _dashboard_cache_ts, _dashboard_cache_payload
    now = time.time()
    if _dashboard_cache_ts and (now - _dashboard_cache_ts) < DASHBOARD_CACHE_TTL and _dashboard_cache_payload:
        total_merchants = _dashboard_cache_payload.get('total_merchants', 0)
        approved_merchants = _dashboard_cache_payload.get('approved_merchants', 0)
        review_total = _dashboard_cache_payload.get('review_total', 0)
        review_avg = _dashboard_cache_payload.get('review_avg', 0)
        binding_total = _dashboard_cache_payload.get('binding_total', 0)
        binding_used = _dashboard_cache_payload.get('binding_used', 0)
        binding_usage_rate = _dashboard_cache_payload.get('binding_usage_rate', 0)
        cities = _dashboard_cache_payload.get('cities', [])
        districts = _dashboard_cache_payload.get('districts', [])
        template_count = _dashboard_cache_payload.get('template_count', 0)
    else:
        try:
            # è·å–å•†æˆ·å®é™…ç»Ÿè®¡æ•°æ®
            merchant_stats = await merchant_manager.get_merchant_statistics()
            total_merchants = merchant_stats.get('total', 0)
            approved_merchants = merchant_stats.get('approved', 0)
            
            # è·å–è¯„ä»·å®é™…ç»Ÿè®¡æ•°æ®
            try:
                review_total = await review_manager.count_reviews()
                review_avg = await review_manager.get_average_rating()
            except:
                review_total = 0
                review_avg = 0
            
            # è·å–ç»‘å®šç ç»Ÿè®¡æ•°æ®
            try:
                binding_stats = await binding_codes_manager.get_binding_code_statistics()
                binding_total = binding_stats.get('total_codes', 0)
                binding_used = binding_stats.get('used_codes', 0)
                binding_usage_rate = binding_stats.get('usage_rate', 0)
            except:
                binding_total = 0
                binding_used = 0
                binding_usage_rate = 0
            
            # è·å–åœ°åŒºå®é™…æ•°æ®
            try:
                cities = await region_manager.get_all_cities()
                districts = await region_manager.get_all_districts()
            except:
                cities = []
                districts = []
            
            # è·å–æ¨¡æ¿é…ç½®æ•°é‡ï¼ˆä»æ¨¡æ¿è¡¨ï¼‰
            try:
                from database.db_templates import template_manager
                template_count = len(await template_manager.get_all_templates())
            except:
                template_count = 0
            # å†™å…¥ç¼“å­˜
            _dashboard_cache_payload = {
                'total_merchants': total_merchants,
                'approved_merchants': approved_merchants,
                'review_total': review_total,
                'review_avg': review_avg,
                'binding_total': binding_total,
                'binding_used': binding_used,
                'binding_usage_rate': binding_usage_rate,
                'cities': cities,
                'districts': districts,
                'template_count': template_count,
            }
            _dashboard_cache_ts = now
        except Exception as e:
            logger.error(f"è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: {e}")
            total_merchants = 0
            approved_merchants = 0
            review_total = 0
            review_avg = 0
            binding_total = 0
            binding_used = 0
            binding_usage_rate = 0
            cities = []
            districts = []
            template_count = 0
    
    content = Div(
        # ä½¿ç”¨ç»Ÿä¸€çš„é¡µé¢å¤´éƒ¨
        Div(
            H1("ç³»ç»Ÿä»ªè¡¨æ¿", cls="page-title"),
            P(f"æ•°æ®æ›´æ–°æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", cls="page-subtitle"),
            cls="page-header"
        ),
        
        # ä½¿ç”¨ç»Ÿä¸€çš„é¡µé¢å†…å®¹å¸ƒå±€
        Div(
            # ç¬¬ä¸€è¡Œ - æ ¸å¿ƒä¸šåŠ¡æ•°æ®
            Div(
                # å•†æˆ·æ€»æ•°
                Div(
                    Div(
                        Span("ğŸª", cls="text-4xl mb-2"),
                        H3("å•†æˆ·æ€»æ•°", cls="font-bold text-white"),
                        P("å·²æ³¨å†Œå•†æˆ·", cls="text-gray-300 text-sm"),
                        cls="text-center"
                    ),
                    Div(
                        Span(str(total_merchants), cls="text-4xl font-bold text-blue-400"),
                        P("ä¸ªå•†æˆ·", cls="text-gray-400 text-sm mt-1"),
                        cls="text-center"
                    ),
                    cls="stat-card"
                ),
                
                # æ´»è·ƒå•†æˆ·
                Div(
                    Div(
                        Span("âœ…", cls="text-4xl mb-2"),
                        H3("æ´»è·ƒå•†æˆ·", cls="font-bold text-white"),
                        P("å·²å®¡æ ¸é€šè¿‡", cls="text-gray-300 text-sm"),
                        cls="text-center"
                    ),
                    Div(
                        Span(str(approved_merchants), cls="text-4xl font-bold text-green-400"),
                        P("ä¸ªæ´»è·ƒ", cls="text-gray-400 text-sm mt-1"),
                        cls="text-center"
                    ),
                    cls="stat-card"
                ),
                
                # ç»‘å®šç æ€»æ•°
                Div(
                    Div(
                        Span("ğŸ«", cls="text-4xl mb-2"),
                        H3("ç»‘å®šç ", cls="font-bold text-white"),
                        P("ç³»ç»Ÿç»‘å®šç ", cls="text-gray-300 text-sm"),
                        cls="text-center"
                    ),
                    Div(
                        Span(str(binding_total), cls="text-4xl font-bold text-purple-400"),
                        P("ä¸ªç»‘å®šç ", cls="text-gray-400 text-sm mt-1"),
                        cls="text-center"
                    ),
                    cls="stat-card"
                ),
                
                # ç»‘å®šç ä½¿ç”¨ç‡
                Div(
                    Div(
                        Span("ğŸ“Š", cls="text-4xl mb-2"),
                        H3("ä½¿ç”¨ç‡", cls="font-bold text-white"),
                        P("ç»‘å®šç ä½¿ç”¨ç‡", cls="text-gray-300 text-sm"),
                        cls="text-center"
                    ),
                    Div(
                        Span(f"{binding_usage_rate:.1f}%" if binding_usage_rate > 0 else "0.0%", cls="text-4xl font-bold text-pink-400"),
                        P(f"({binding_used}/{binding_total})", cls="text-gray-400 text-sm mt-1"),
                        cls="text-center"
                    ),
                    cls="stat-card"
                ),
                
                cls="stats-container"
            ),
            
            # ç¬¬äºŒè¡Œ - ä¸šåŠ¡è¯„ä»·æ•°æ®
            Div(
                # è¯„ä»·æ€»æ•°
                Div(
                    Div(
                        Span("â­", cls="text-4xl mb-2"),
                        H3("è¯„ä»·æ€»æ•°", cls="font-bold text-white"),
                        P("ç”¨æˆ·è¯„ä»·æ•°", cls="text-gray-300 text-sm"),
                        cls="text-center"
                    ),
                    Div(
                        Span(str(review_total), cls="text-4xl font-bold text-yellow-400"),
                        P("æ¡è¯„ä»·", cls="text-gray-400 text-sm mt-1"),
                        cls="text-center"
                    ),
                    cls="stat-card"
                ),
                
                # å¹³å‡è¯„åˆ†
                Div(
                    Div(
                        Span("ğŸ“ˆ", cls="text-4xl mb-2"),
                        H3("å¹³å‡è¯„åˆ†", cls="font-bold text-white"),
                        P("äº”ç»´å¹³å‡åˆ†", cls="text-gray-300 text-sm"),
                        cls="text-center"
                    ),
                    Div(
                        Span(f"{review_avg:.1f}" if review_avg > 0 else "0.0", cls="text-4xl font-bold text-orange-400"),
                        P("åˆ† (æ»¡åˆ†10)", cls="text-gray-400 text-sm mt-1"),
                        cls="text-center"
                    ),
                    cls="stat-card"
                ),
                
                # åœ°åŒºè¦†ç›–
                Div(
                    Div(
                        Span("ğŸ—ºï¸", cls="text-4xl mb-2"),
                        H3("åœ°åŒºè¦†ç›–", cls="font-bold text-white"),
                        P("åŸå¸‚+åŒºå¿", cls="text-gray-300 text-sm"),
                        cls="text-center"
                    ),
                    Div(
                        Span(f"{len(cities)}+{len(districts)}", cls="text-4xl font-bold text-cyan-400"),
                        P("ä¸ªåœ°åŒº", cls="text-gray-400 text-sm mt-1"),
                        cls="text-center"
                    ),
                    cls="stat-card"
                ),
                
                # ç³»ç»Ÿæ¨¡æ¿
                Div(
                    Div(
                        Span("ğŸ“‹", cls="text-4xl mb-2"),
                        H3("ç³»ç»Ÿæ¨¡æ¿", cls="font-bold text-white"),
                        P("é…ç½®æ¨¡æ¿æ•°", cls="text-gray-300 text-sm"),
                        cls="text-center"
                    ),
                    Div(
                        Span(str(template_count), cls="text-4xl font-bold text-indigo-400"),
                        P("ä¸ªæ¨¡æ¿", cls="text-gray-400 text-sm mt-1"),
                        cls="text-center"
                    ),
                    cls="stat-card"
                ),
                
                cls="stats-container"
            ),
            
            cls="page-content"
        )
    )
    
    return create_layout("ä»ªè¡¨æ¿", content)

# --- åœ°åŒºç®¡ç†æ¨¡å— FastHTML åŸç”Ÿè·¯ç”± ---

@app.get("/regions")
@require_auth
async def regions_list(request: Request):
    """åœ°åŒºç®¡ç†é¡µé¢"""
    try:
        logger.info("å¼€å§‹è°ƒç”¨ region_manager.get_all_cities()")
        cities = await region_manager.get_all_cities()
        logger.info(f"cities è·å–æˆåŠŸ: {len(cities)} æ¡")
        # ä»…ç”¨äºä¸‹æ‹‰é€‰æ‹©ï¼šåªå±•ç¤ºå¯ç”¨åŸå¸‚ï¼Œé¿å…å‘ç¦ç”¨åŸå¸‚æ·»åŠ åœ°åŒº
        active_cities = [c for c in cities if c.get('is_active', True)]
        
        logger.info("å¼€å§‹è°ƒç”¨ region_manager.get_all_districts()")
        districts = await region_manager.get_all_districts()
        logger.info(f"districts è·å–æˆåŠŸ: {len(districts)} æ¡")
        
    except Exception as e:
        logger.error(f"è·å–åœ°åŒºæ•°æ®å¤±è´¥: {e}")
        import traceback
        logger.error(f"å®Œæ•´å †æ ˆ: {traceback.format_exc()}")
        error_content = Div(
            H1("é”™è¯¯è°ƒè¯•", cls="text-2xl font-bold text-red-600 mb-4"),
            Pre(f"{str(e)}\n\n{traceback.format_exc()}", cls="bg-gray-100 p-4 rounded text-sm")
        )
        return create_layout("ç³»ç»Ÿé”™è¯¯", error_content)

    # è·å–URLå‚æ•°
    params = request.query_params
    success_msg = None
    error_msg = None
    
    # æœç´¢ç­›é€‰å‚æ•°
    city_search = params.get('city_search', '').strip()
    district_search = params.get('district_search', '').strip()
    status_filter = params.get('status_filter', '').strip()
    
    # ç­›é€‰åŸå¸‚
    if city_search:
        cities = [c for c in cities if city_search.lower() in c['name'].lower()]
    
    # ç­›é€‰åœ°åŒº
    if district_search:
        districts = [d for d in districts if district_search.lower() in d['name'].lower()]
    
    # çŠ¶æ€ç­›é€‰
    if status_filter:
        if status_filter == 'enabled':
            cities = [c for c in cities if c['is_active']]
            districts = [d for d in districts if d['is_active']]
        elif status_filter == 'disabled':
            cities = [c for c in cities if not c['is_active']]
            districts = [d for d in districts if not d['is_active']]
    
    if params.get('city_added'):
        success_msg = "åŸå¸‚æ·»åŠ æˆåŠŸï¼"
    elif params.get('district_added'):
        success_msg = "åœ°åŒºæ·»åŠ æˆåŠŸï¼"
    elif params.get('city_updated'):
        success_msg = "åŸå¸‚æ›´æ–°æˆåŠŸï¼"
    elif params.get('district_updated'):
        success_msg = "åœ°åŒºæ›´æ–°æˆåŠŸï¼"
    elif params.get('city_deleted'):
        success_msg = "åŸå¸‚åˆ é™¤æˆåŠŸï¼"
    elif params.get('district_deleted'):
        success_msg = "åœ°åŒºåˆ é™¤æˆåŠŸï¼"
    elif params.get('error') == 'empty_name':
        error_msg = "åç§°ä¸èƒ½ä¸ºç©ºï¼"
    elif params.get('error') == 'invalid_city':
        error_msg = "è¯·é€‰æ‹©æœ‰æ•ˆçš„åŸå¸‚ï¼"
    elif params.get('error') == 'city_not_found':
        error_msg = "åŸå¸‚ä¸å­˜åœ¨ï¼"
    elif params.get('error') == 'district_not_found':
        error_msg = "åœ°åŒºä¸å­˜åœ¨ï¼"
    elif params.get('error') == 'delete_failed':
        error_msg = "åˆ é™¤å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨å…³è”æ•°æ®ï¼"
    elif params.get('error') == 'update_failed':
        error_msg = "æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•ï¼"
    elif params.get('error'):
        error_msg = "æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼"

    # ç”ŸæˆCSRF Token
    csrf_token = get_or_create_csrf_token(request)

    # åˆ›å»ºå®Œæ•´çš„åœ°åŒºç®¡ç†CRUDé¡µé¢
    content = Div(
        H1("åœ°åŒºç®¡ç†", cls="page-title"),
        
        # æç¤ºä¿¡æ¯
        *([Div(success_msg, cls="alert alert-success mb-4")] if success_msg else []),
        *([Div(error_msg, cls="alert alert-error mb-4")] if error_msg else []),
        
        # æ•°æ®ç»Ÿè®¡
        Div(
            H3("æ•°æ®ç»Ÿè®¡", cls="text-xl font-semibold mb-4"),
            Div(
                Div(
                    Div("åŸå¸‚æ€»æ•°", cls="stat-title"),
                    Div(str(len(cities)), cls="stat-value text-primary"),
                    cls="stat"
                ),
                Div(
                    Div("åœ°åŒºæ€»æ•°", cls="stat-title"),
                    Div(str(len(districts)), cls="stat-value text-secondary"),
                    cls="stat"
                ),
                cls="stats shadow mb-6"
            )
        ),
        
        # æœç´¢ç­›é€‰å·¥å…·æ 
        Div(
            H3("æœç´¢ç­›é€‰", cls="text-xl font-semibold mb-4"),
            Form(
                Div(
                    Div(
                        Label("åŸå¸‚æœç´¢", cls="label"),
                        Input(
                            name="city_search",
                            placeholder="è¾“å…¥åŸå¸‚åç§°æœç´¢...",
                            value=city_search,
                            cls="input input-bordered w-full"
                        ),
                        cls="form-control"
                    ),
                    Div(
                        Label("åœ°åŒºæœç´¢", cls="label"),
                        Input(
                            name="district_search",
                            placeholder="è¾“å…¥åœ°åŒºåç§°æœç´¢...",
                            value=district_search,
                            cls="input input-bordered w-full"
                        ),
                        cls="form-control"
                    ),
                    Div(
                        Label("çŠ¶æ€ç­›é€‰", cls="label"),
                        Select(
                            Option("å…¨éƒ¨çŠ¶æ€", value="", selected=(not status_filter)),
                            Option("å¯ç”¨", value="enabled", selected=(status_filter == "enabled")),
                            Option("ç¦ç”¨", value="disabled", selected=(status_filter == "disabled")),
                            name="status_filter",
                            cls="select select-bordered w-full"
                        ),
                        cls="form-control"
                    ),
                    Div(
                        Button("æœç´¢ç­›é€‰", type="submit", cls="btn btn-primary"),
                        Button("æ¸…é™¤ç­›é€‰", type="button", onclick="window.location.href='/regions'", cls="btn btn-ghost ml-2"),
                        cls="form-control mt-4"
                    ),
                    cls="grid grid-cols-1 md:grid-cols-4 gap-4"
                ),
                method="GET",
                action="/regions",
                cls="card bg-base-100 shadow-xl p-6 mb-6"
            )
        ),
        
        # æ·»åŠ åŸå¸‚è¡¨å•
        Div(
            H3("æ·»åŠ åŸå¸‚", cls="text-xl font-semibold mb-4"),
            Form(
                Div(
                    Input(type="hidden", name="csrf_token", value=csrf_token),
                    okx_form_group("åŸå¸‚åç§°", okx_input("city_name", placeholder="è¯·è¾“å…¥åŸå¸‚åç§°", required=True, **{"data-test": "city-name-input"})),
                    okx_form_group("æ˜¾ç¤ºé¡ºåº", okx_input("display_order", type="number", placeholder="å¯é€‰ï¼Œæ•°å­—è¶Šå°è¶Šé å‰", value="0", **{"data-test": "city-order-input"})),
                    okx_button("æ·»åŠ åŸå¸‚", type="submit", cls="btn btn-primary", **{"data-test": "save-city-btn"}),
                    cls="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"
                ),
                method="post",
                action="/regions/city/add",
                cls="card bg-base-100 shadow-xl p-6 mb-6"
            )
        ),
        
        # æ·»åŠ åœ°åŒºè¡¨å•ï¼ˆä»…å…è®¸é€‰æ‹©å¯ç”¨çš„åŸå¸‚ï¼‰
        Div(
            H3("æ·»åŠ åœ°åŒº", cls="text-xl font-semibold mb-4"),
            Form(
                Div(
                    Input(type="hidden", name="csrf_token", value=csrf_token),
                    okx_form_group(
                        "æ‰€å±åŸå¸‚",
                        okx_select("city_id", options=[(city['id'], city['name']) for city in active_cities], selected=None, **{"data-test": "city-selector"})
                    ) if active_cities else P("è¯·å…ˆå¯ç”¨è‡³å°‘ä¸€ä¸ªåŸå¸‚", cls="text-red-500"),
                    okx_form_group("åœ°åŒºåç§°", okx_input("district_name", placeholder="è¯·è¾“å…¥åœ°åŒºåç§°", required=True, **{"data-test": "district-name-input"})),
                    okx_form_group("æ˜¾ç¤ºé¡ºåº", okx_input("display_order", type="number", placeholder="å¯é€‰ï¼Œæ•°å­—è¶Šå°è¶Šé å‰", value="0", **{"data-test": "district-order-input"})),
                    (okx_button("æ·»åŠ åœ°åŒº", type="submit", cls="btn btn-secondary", **{"data-test": "save-district-btn"}) if active_cities else okx_button("æ·»åŠ åœ°åŒº", type="button", cls="btn btn-disabled", disabled=True)),
                    cls="grid grid-cols-1 md:grid-cols-4 gap-4 items-end"
                ),
                method="post",
                action="/regions/district/add",
                cls="card bg-base-100 shadow-xl p-6 mb-6"
            ) if cities else Div(
                P("è¯·å…ˆæ·»åŠ åŸå¸‚ï¼Œç„¶åæ‰èƒ½æ·»åŠ åœ°åŒº", cls="text-center text-gray-500 py-8"),
                cls="card bg-base-100 shadow-xl p-6 mb-6"
            )
        ),
        
        # åŸå¸‚åˆ—è¡¨
        Div(
            H3("åŸå¸‚åˆ—è¡¨", cls="text-xl font-semibold mb-4"),
            Div(
                Table(
                    Thead(
                        Tr(
                            Th("ID"),
                            Th("åŸå¸‚åç§°"),
                            Th("æ˜¾ç¤ºé¡ºåº"),
                            Th("çŠ¶æ€"),
                            Th("åˆ›å»ºæ—¶é—´"),
                            Th("æ“ä½œ")
                        )
                    ),
                    Tbody(
                        *[
                            Tr(
                                Td(str(city['id'])),
                                Td(city['name']),
                                Td(str(city.get('display_order', 0))),
                                Td(
                                    Div(
                                        Span("âœ… å¯ç”¨", cls="badge badge-success text-white mr-2", title="å¯ç”¨") if city.get('is_active', True) else Span("âŒ ç¦ç”¨", cls="badge badge-error text-white mr-2", title="ç¦ç”¨"),
                                        Form(
                                            Input(type="hidden", name="csrf_token", value=csrf_token),
                                            okx_button("åˆ‡æ¢", type="submit", cls="btn btn-ghost btn-xs", **{"data-test": f"toggle-city-{city['id']}"}),
                                            method="post",
                                            action=f"/regions/city/{city['id']}/toggle",
                                        ),
                                        cls="flex items-center"
                                    )
                                ),
                                Td(city.get('created_at', 'æœªçŸ¥')[:19] if city.get('created_at') else 'æœªçŸ¥'),
                                Td(
                                    Div(
                                        A("ç¼–è¾‘", href=f"/regions/city/{city['id']}/edit", cls="btn btn-sm btn-outline btn-primary mr-2", **{"data-test": f"edit-city-{city['id']}"}),
                                        Form(
                                            Input(type="hidden", name="csrf_token", value=csrf_token),
                                            okx_button("åˆ é™¤", type="submit", cls="btn btn-sm btn-outline btn-error", **{"data-test": f"delete-city-{city['id']}"}),
                                            method="post",
                                            action=f"/regions/city/{city['id']}/delete",
                                            onsubmit=f"return confirm('ç¡®å®šåˆ é™¤åŸå¸‚ {city['name']} å—ï¼Ÿ')"
                                        ),
                                        cls="flex gap-2"
                                    )
                                )
                            ) for city in cities
                        ] if cities else [
                            Tr(
                                Td("æš‚æ— åŸå¸‚æ•°æ®", colspan="6", cls="text-center text-gray-500")
                            )
                        ]
                    ),
                    cls="table table-zebra w-full"
                ),
                cls="overflow-x-auto"
            ),
            cls="card bg-base-100 shadow-xl p-6 mb-6"
        ),
        
        # åœ°åŒºåˆ—è¡¨
        Div(
            H3("åœ°åŒºåˆ—è¡¨", cls="text-xl font-semibold mb-4"),
            Div(
                Table(
                    Thead(
                        Tr(
                            Th("ID"),
                            Th("åœ°åŒºåç§°"),
                            Th("æ‰€å±åŸå¸‚"),
                            Th("æ˜¾ç¤ºé¡ºåº"),
                            Th("çŠ¶æ€"),
                            Th("åˆ›å»ºæ—¶é—´"),
                            Th("æ“ä½œ")
                        )
                    ),
                    Tbody(
                        *[
                            Tr(
                                Td(str(district['id'])),
                                Td(district['name']),
                                Td(district.get('city_name', 'æœªçŸ¥')),
                                Td(str(district.get('display_order', 0))),
                                Td(
                                    Div(
                                        Span("âœ… å¯ç”¨", cls="badge badge-success text-white mr-2", title="å¯ç”¨") if district.get('is_active', True) else Span("âŒ ç¦ç”¨", cls="badge badge-error text-white mr-2", title="ç¦ç”¨"),
                                        Form(
                                            Input(type="hidden", name="csrf_token", value=csrf_token),
                                            okx_button("åˆ‡æ¢", type="submit", cls="btn btn-ghost btn-xs", **{"data-test": f"toggle-district-{district['id']}"}),
                                            method="post",
                                            action=f"/regions/district/{district['id']}/toggle",
                                        ),
                                        cls="flex items-center"
                                    )
                                ),
                                Td(district.get('created_at', 'æœªçŸ¥')[:19] if district.get('created_at') else 'æœªçŸ¥'),
                                Td(
                                    Div(
                                        A("ç¼–è¾‘", href=f"/regions/district/{district['id']}/edit", cls="btn btn-sm btn-outline btn-primary mr-2", **{"data-test": f"edit-district-{district['id']}"}),
                                        Form(
                                            Input(type="hidden", name="csrf_token", value=csrf_token),
                                            okx_button("åˆ é™¤", type="submit", cls="btn btn-sm btn-outline btn-error", **{"data-test": f"delete-district-{district['id']}"}),
                                            method="post",
                                            action=f"/regions/district/{district['id']}/delete",
                                            onsubmit=f"return confirm('ç¡®å®šåˆ é™¤åœ°åŒº {district['name']} å—ï¼Ÿ')"
                                        ),
                                        cls="flex gap-2"
                                    )
                                )
                            ) for district in districts
                        ] if districts else [
                            Tr(
                                Td("æš‚æ— åœ°åŒºæ•°æ®", colspan="7", cls="text-center text-gray-500")
                            )
                        ]
                    ),
                    cls="table table-zebra w-full"
                ),
                cls="overflow-x-auto"
            ),
            cls="card bg-base-100 shadow-xl p-6"
        )
    )
    
    return create_layout("åœ°åŒºç®¡ç†", content)

@app.post("/regions/city/add")
@require_auth
async def add_city_route(request: Request):
    """æ·»åŠ åŸå¸‚"""
    form = await request.form()
    
    try:
        # CSRFæ ¡éªŒ
        if not validate_csrf(request, form.get('csrf_token', '')):
            return RedirectResponse(url="/regions?error=csrf", status_code=302)
        city_name = form.get('city_name', '').strip()
        display_order = int(form.get('display_order', 0))
        
        if not city_name:
            return RedirectResponse(url="/regions?error=empty_name", status_code=302)
        
        city_id = await region_manager.add_city(city_name)
        
        if city_id:
            # å¦‚æœéœ€è¦è®¾ç½®æ˜¾ç¤ºé¡ºåºï¼Œæ›´æ–°city
            if display_order > 0:
                await region_manager.update_city_display_order(city_id, display_order)
            admin_id = request.session.get('admin_id')
            logger.info(f"[audit] admin={admin_id} æ–°å¢åŸå¸‚ id={city_id} name={city_name} order={display_order}")
            return RedirectResponse(url="/regions?city_added=1", status_code=302)
        else:
            return RedirectResponse(url="/regions?error=1", status_code=302)
            
    except Exception as e:
        logger.error(f"æ·»åŠ åŸå¸‚æ—¶å‡ºé”™: {e}")
        return RedirectResponse(url="/regions?error=1", status_code=302)

@app.post("/regions/district/add")
@require_auth
async def add_district_route(request: Request):
    """æ·»åŠ åœ°åŒº"""
    form = await request.form()
    
    try:
        # CSRFæ ¡éªŒ
        if not validate_csrf(request, form.get('csrf_token', '')):
            return RedirectResponse(url="/regions?error=csrf", status_code=302)
        city_id = int(form.get('city_id', 0))
        district_name = form.get('district_name', '').strip()
        display_order = int(form.get('display_order', 0))
        
        if not district_name:
            return RedirectResponse(url="/regions?error=empty_name", status_code=302)
        
        if city_id <= 0:
            return RedirectResponse(url="/regions?error=invalid_city", status_code=302)
        
        district_id = await region_manager.add_district(city_id, district_name)
        
        if district_id:
            # å¦‚æœéœ€è¦è®¾ç½®æ˜¾ç¤ºé¡ºåºï¼Œæ›´æ–°district
            if display_order > 0:
                await region_manager.update_district_display_order(district_id, display_order)
            admin_id = request.session.get('admin_id')
            logger.info(f"[audit] admin={admin_id} æ–°å¢åœ°åŒº id={district_id} name={district_name} city_id={city_id} order={display_order}")
            return RedirectResponse(url="/regions?district_added=1", status_code=302)
        else:
            return RedirectResponse(url="/regions?error=1", status_code=302)
            
    except Exception as e:
        logger.error(f"æ·»åŠ åœ°åŒºæ—¶å‡ºé”™: {e}")
        return RedirectResponse(url="/regions?error=1", status_code=302)

@app.post("/regions/city/{city_id}/delete")
@require_auth
async def delete_city_route(request: Request):
    """åˆ é™¤åŸå¸‚ï¼ˆPOSTï¼‰"""
    city_id = request.path_params.get('city_id')
    form = await request.form()
    
    try:
        if not validate_csrf(request, form.get('csrf_token', '')):
            return RedirectResponse(url="/regions?error=csrf", status_code=302)
        city_id = int(city_id)
        success = await region_manager.delete_city(city_id)
        admin_id = request.session.get('admin_id')
        if success:
            logger.info(f"[audit] admin={admin_id} åˆ é™¤åŸå¸‚ id={city_id}")
            return RedirectResponse(url="/regions?city_deleted=1", status_code=302)
        else:
            return RedirectResponse(url="/regions?error=delete_failed", status_code=302)
            
    except Exception as e:
        logger.error(f"åˆ é™¤åŸå¸‚æ—¶å‡ºé”™: {e}")
        return RedirectResponse(url="/regions?error=1", status_code=302)

@app.post("/regions/district/{district_id}/delete")
@require_auth
async def delete_district_route(request: Request):
    """åˆ é™¤åœ°åŒºï¼ˆPOSTï¼‰"""
    district_id = request.path_params.get('district_id')
    form = await request.form()
    
    try:
        if not validate_csrf(request, form.get('csrf_token', '')):
            return RedirectResponse(url="/regions?error=csrf", status_code=302)
        district_id = int(district_id)
        success = await region_manager.delete_district(district_id)
        admin_id = request.session.get('admin_id')
        if success:
            logger.info(f"[audit] admin={admin_id} åˆ é™¤åœ°åŒº id={district_id}")
            return RedirectResponse(url="/regions?district_deleted=1", status_code=302)
        else:
            return RedirectResponse(url="/regions?error=delete_failed", status_code=302)
            
    except Exception as e:
        logger.error(f"åˆ é™¤åœ°åŒºæ—¶å‡ºé”™: {e}")
        return RedirectResponse(url="/regions?error=1", status_code=302)

@app.get("/regions/city/{city_id}/edit")
@require_auth
async def edit_city_get_route(request: Request):
    """åŸå¸‚ç¼–è¾‘é¡µé¢"""
    city_id = request.path_params.get('city_id')
    
    try:
        city_id = int(city_id)
        city = await region_manager.get_city_by_id(city_id)
        
        if not city:
            return RedirectResponse(url="/regions?error=city_not_found", status_code=302)
        
        # æ˜¾ç¤ºç¼–è¾‘è¡¨å•
        csrf_token = get_or_create_csrf_token(request)
        content = Div(
            H2("ç¼–è¾‘åŸå¸‚", cls="text-2xl font-bold mb-6"),
            Form(
                Input(type="hidden", name="csrf_token", value=csrf_token),
                okx_form_group("åŸå¸‚åç§°", okx_input("city_name", value=city['name'], required=True, **{"data-test": "edit-city-name"})),
                okx_form_group("æ˜¾ç¤ºé¡ºåº", okx_input("display_order", type="number", value=str(city.get('display_order', 0)), **{"data-test": "edit-city-order"})),
                Div(
                    okx_button("ä¿å­˜", type="submit", cls="btn btn-primary mr-2", **{"data-test": "save-edit-city"}),
                    A("å–æ¶ˆ", href="/regions", cls="btn btn-secondary"),
                    cls="flex gap-2"
                ),
                method="post",
                action=f"/regions/city/{city_id}/edit",
                cls="card bg-base-100 shadow-xl p-6"
            )
        )
        return create_layout("ç¼–è¾‘åŸå¸‚", content)
                
    except Exception as e:
        logger.error(f"ç¼–è¾‘åŸå¸‚æ—¶å‡ºé”™: {e}")
        return RedirectResponse(url="/regions?error=1", status_code=302)

@app.post("/regions/city/{city_id}/edit")
@require_auth
async def edit_city_post_route(request: Request):
    """å¤„ç†åŸå¸‚ç¼–è¾‘"""
    city_id = request.path_params.get('city_id')
    
    try:
        city_id = int(city_id)
        form = await request.form()
        if not validate_csrf(request, form.get('csrf_token', '')):
            return RedirectResponse(url=f"/regions/city/{city_id}/edit?error=csrf", status_code=302)
        city_name = form.get('city_name', '').strip()
        display_order = int(form.get('display_order', 0))
        
        if not city_name:
            return RedirectResponse(url=f"/regions/city/{city_id}/edit?error=empty_name", status_code=302)
        
        # æ›´æ–°åŸå¸‚ä¿¡æ¯
        name_success = await region_manager.update_city_name(city_id, city_name)
        order_success = await region_manager.update_city_display_order(city_id, display_order)
        
        if name_success and order_success:
            admin_id = request.session.get('admin_id')
            logger.info(f"[audit] admin={admin_id} æ›´æ–°åŸå¸‚ id={city_id} name={city_name} order={display_order}")
            return RedirectResponse(url="/regions?city_updated=1", status_code=302)
        else:
            return RedirectResponse(url=f"/regions/city/{city_id}/edit?error=update_failed", status_code=302)
            
    except Exception as e:
        logger.error(f"ç¼–è¾‘åŸå¸‚æ—¶å‡ºé”™: {e}")
        return RedirectResponse(url="/regions?error=1", status_code=302)

@app.get("/regions/district/{district_id}/edit")
@require_auth
async def edit_district_get_route(request: Request):
    """åœ°åŒºç¼–è¾‘é¡µé¢"""
    district_id = request.path_params.get('district_id')
    
    try:
        district_id = int(district_id)
        district = await region_manager.get_district_by_id(district_id)
        cities = await region_manager.get_all_cities()
        
        if not district:
            return RedirectResponse(url="/regions?error=district_not_found", status_code=302)
        
        # æ˜¾ç¤ºç¼–è¾‘è¡¨å•
        csrf_token = get_or_create_csrf_token(request)
        content = Div(
            H2("ç¼–è¾‘åœ°åŒº", cls="text-2xl font-bold mb-6"),
            Form(
                Input(type="hidden", name="csrf_token", value=csrf_token),
                okx_form_group("æ‰€å±åŸå¸‚", okx_select("city_id", options=[(city['id'], city['name']) for city in cities], selected=district.get('city_id'), **{"data-test": "edit-district-city"})),
                okx_form_group("åœ°åŒºåç§°", okx_input("district_name", value=district['name'], required=True, **{"data-test": "edit-district-name"})),
                okx_form_group("æ˜¾ç¤ºé¡ºåº", okx_input("display_order", type="number", value=str(district.get('display_order', 0)), **{"data-test": "edit-district-order"})),
                Div(
                    okx_button("ä¿å­˜", type="submit", cls="btn btn-primary mr-2", **{"data-test": "save-edit-district"}),
                    A("å–æ¶ˆ", href="/regions", cls="btn btn-secondary"),
                    cls="flex gap-2"
                ),
                method="post",
                action=f"/regions/district/{district_id}/edit",
                cls="card bg-base-100 shadow-xl p-6"
            )
        )
        return create_layout("ç¼–è¾‘åœ°åŒº", content)
                
    except Exception as e:
        logger.error(f"ç¼–è¾‘åœ°åŒºæ—¶å‡ºé”™: {e}")
        return RedirectResponse(url="/regions?error=1", status_code=302)

@app.post("/regions/district/{district_id}/edit")
@require_auth
async def edit_district_post_route(request: Request):
    """å¤„ç†åœ°åŒºç¼–è¾‘"""
    district_id = request.path_params.get('district_id')
    
    try:
        district_id = int(district_id)
        form = await request.form()
        if not validate_csrf(request, form.get('csrf_token', '')):
            return RedirectResponse(url=f"/regions/district/{district_id}/edit?error=csrf", status_code=302)
        district_name = form.get('district_name', '').strip()
        display_order = int(form.get('display_order', 0))
        
        if not district_name:
            return RedirectResponse(url=f"/regions/district/{district_id}/edit?error=empty_name", status_code=302)
        
        # æ›´æ–°åœ°åŒºä¿¡æ¯
        name_success = await region_manager.update_district_name(district_id, district_name)
        order_success = await region_manager.update_district_display_order(district_id, display_order)
        
        if name_success and order_success:
            admin_id = request.session.get('admin_id')
            logger.info(f"[audit] admin={admin_id} æ›´æ–°åœ°åŒº id={district_id} name={district_name} order={display_order}")
            return RedirectResponse(url="/regions?district_updated=1", status_code=302)
        else:
            return RedirectResponse(url=f"/regions/district/{district_id}/edit?error=update_failed", status_code=302)
            
    except Exception as e:
        logger.error(f"ç¼–è¾‘åœ°åŒºæ—¶å‡ºé”™: {e}")
        return RedirectResponse(url="/regions?error=1", status_code=302)

# --- çŠ¶æ€åˆ‡æ¢ï¼ˆPOSTï¼‰ ---

@app.post("/regions/city/{city_id}/toggle")
@require_auth
async def toggle_city_status_route(request: Request):
    city_id = int(request.path_params.get('city_id'))
    form = await request.form()
    try:
        if not validate_csrf(request, form.get('csrf_token', '')):
            return RedirectResponse(url="/regions?error=csrf", status_code=302)
        success = await region_manager.toggle_city_status(city_id)
        admin_id = request.session.get('admin_id')
        if success:
            logger.info(f"[audit] admin={admin_id} åˆ‡æ¢åŸå¸‚çŠ¶æ€ id={city_id}")
        return RedirectResponse(url="/regions", status_code=302)
    except Exception as e:
        logger.error(f"åˆ‡æ¢åŸå¸‚çŠ¶æ€å¤±è´¥: {e}")
        return RedirectResponse(url="/regions?error=1", status_code=302)

@app.post("/regions/district/{district_id}/toggle")
@require_auth
async def toggle_district_status_route(request: Request):
    district_id = int(request.path_params.get('district_id'))
    form = await request.form()
    try:
        if not validate_csrf(request, form.get('csrf_token', '')):
            return RedirectResponse(url="/regions?error=csrf", status_code=302)
        success = await region_manager.toggle_district_status(district_id)
        admin_id = request.session.get('admin_id')
        if success:
            logger.info(f"[audit] admin={admin_id} åˆ‡æ¢åœ°åŒºçŠ¶æ€ id={district_id}")
        return RedirectResponse(url="/regions", status_code=302)
    except Exception as e:
        logger.error(f"åˆ‡æ¢åœ°åŒºçŠ¶æ€å¤±è´¥: {e}")
        return RedirectResponse(url="/regions?error=1", status_code=302)

# --- å•†æˆ·ç®¡ç†æ¨¡å— FastHTML åŸç”Ÿè·¯ç”± ---

@app.get("/merchants")
async def merchants_list(request: Request):
    """å•†æˆ·ç®¡ç†é¡µé¢"""
    try:
        # è·å–æŸ¥è¯¢å‚æ•°
        params = request.query_params
        status_filter = params.get('status', 'pending_approval')
        search_query = params.get('search', '').strip()
        
        # çŠ¶æ€ä¸ºâ€œå…¨éƒ¨â€æ—¶ä¸ä¼ è¿‡æ»¤å‚æ•°
        effective_status = status_filter if (status_filter and status_filter != 'all') else None
        # è·å–å•†æˆ·æ•°æ®
        merchants = await merchant_manager.get_merchants(status=effective_status, search=search_query)
        
        # ç»Ÿè®¡æ•°æ®
        all_merchants = await merchant_manager.get_merchants()
        total_count = len(all_merchants)
        filtered_count = len(merchants)
        
        # çŠ¶æ€ç»Ÿè®¡
        status_counts = {}
        for merchant in all_merchants:
            status = merchant.get('status', 'unknown')
            status_counts[status] = status_counts.get(status, 0) + 1
        
        # åˆ›å»ºå•†æˆ·ç®¡ç†é¡µé¢
        content = Div(
            # ä½¿ç”¨ç»Ÿä¸€çš„é¡µé¢å¤´éƒ¨
            Div(
                H1("å•†æˆ·ç®¡ç†", cls="page-title"),
                cls="page-header"
            ),
            
            # ä½¿ç”¨ç»Ÿä¸€çš„é¡µé¢å†…å®¹å¸ƒå±€
            Div(
                # æ•°æ®ç»Ÿè®¡
                Div(
                H3("æ•°æ®ç»Ÿè®¡", cls="content-section-title"),
                Div(
                    Div(
                        Div("å•†æˆ·æ€»æ•°", cls="stat-title"),
                        Div(str(total_count), cls="stat-value text-primary"),
                        cls="stat"
                    ),
                    Div(
                        Div("å½“å‰ç­›é€‰", cls="stat-title"),
                        Div(str(filtered_count), cls="stat-value text-secondary"),
                        cls="stat"
                    ),
                    Div(
                        Div("å¾…å®¡æ ¸", cls="stat-title"),
                        Div(str(status_counts.get('pending_approval', 0)), cls="stat-value text-warning"),
                        cls="stat"
                    ),
                    Div(
                        Div("å·²å®¡æ ¸", cls="stat-title"),
                        Div(str(status_counts.get('approved', 0)), cls="stat-value text-success"),
                        cls="stat"
                    ),
                    cls="stats shadow mb-6"
                )
            ),
            
            # æœç´¢ç­›é€‰å·¥å…·æ 
            Div(
                H3("æœç´¢ç­›é€‰", cls="text-xl font-semibold mb-4"),
                Form(
                    Div(
                        Div(
                            Label("çŠ¶æ€ç­›é€‰", cls="label"),
                            Select(
                                Option("å¾…å®¡æ ¸", value="pending_approval", selected=(status_filter == "pending_approval")),
                                Option("å·²å®¡æ ¸", value="approved", selected=(status_filter == "approved")),
                                Option("å·²å‘å¸ƒ", value="published", selected=(status_filter == "published")),
                                Option("å·²è¿‡æœŸ", value="expired", selected=(status_filter == "expired")),
                                Option("å…¨éƒ¨çŠ¶æ€", value="", selected=(status_filter == "" or status_filter == "all")),
                                name="status",
                                cls="select select-bordered w-full"
                            ),
                            cls="form-control"
                        ),
                        Div(
                            Label("å•†æˆ·æœç´¢", cls="label"),
                            Input(
                                name="search",
                                placeholder="è¾“å…¥å•†æˆ·åç§°ã€è”ç³»æ–¹å¼æˆ–åœ°åŒºæœç´¢...",
                                value=search_query,
                                cls="input input-bordered w-full"
                            ),
                            cls="form-control"
                        ),
                        Div(
                            Button("æœç´¢ç­›é€‰", type="submit", cls="btn btn-primary"),
                            Button("æ¸…é™¤ç­›é€‰", type="button", onclick="window.location.href='/merchants'", cls="btn btn-ghost ml-2"),
                            cls="form-control mt-4"
                        ),
                        cls="grid grid-cols-1 md:grid-cols-3 gap-4"
                    ),
                    method="GET",
                    action="/merchants",
                    cls="card bg-base-100 shadow-xl p-6 mb-6"
                )
            ),
            
            # å•†æˆ·åˆ—è¡¨
            Div(
                H3("å•†æˆ·åˆ—è¡¨", cls="text-xl font-semibold mb-4"),
                Div(
                    Table(
                        Thead(
                            Tr(
                                Th("ID"),
                                Th("å•†æˆ·åç§°"),
                                Th("è”ç³»æ–¹å¼"),
                                Th("åœ°åŒº"),
                                Th("çŠ¶æ€"),
                                Th("åˆ›å»ºæ—¶é—´"),
                                Th("æ“ä½œ"),
                            )
                        ),
                        Tbody(
                            *[
                                Tr(
                                    Td(str(merchant.get('id', '-'))),
                                    Td(merchant.get('name', '-')),
                                    Td(merchant.get('contact_info', '-')),
                                    Td(f"{merchant.get('city_name', '-')} - {merchant.get('district_name', '-')}"),
                                    Td(
                                        Div(
                                            merchant.get('status', 'unknown'),
                                            cls=f"badge badge-{'success' if merchant.get('status') == 'approved' else 'warning' if merchant.get('status') == 'pending_approval' else 'info'}"
                                        )
                                    ),
                                    Td(merchant.get('created_at', '-')),
                                    Td(
                                        Div(
                                            A("æŸ¥çœ‹", href=f"/posts/{merchant.get('id')}", cls="btn btn-sm btn-primary mr-2"),
                                            A("ç¼–è¾‘", href=f"/posts/{merchant.get('id')}", cls="btn btn-sm btn-secondary"),
                                            cls="btn-group"
                                        )
                                    )
                                )
                                for merchant in merchants
                            ] if merchants else [
                                Tr(
                                    Td("æš‚æ— å•†æˆ·æ•°æ®", colspan="7", cls="text-center text-gray-500")
                                )
                            ]
                        ),
                        cls="table table-zebra w-full"
                    ),
                    cls="overflow-x-auto"
                ),
                cls="card bg-base-100 shadow-xl p-6"
            ),
            cls="page-content"  # å…³é—­page-content div
            )
        )
        
        return create_layout("å•†æˆ·ç®¡ç†", content)
        
    except Exception as e:
        logger.error(f"å•†æˆ·ç®¡ç†é¡µé¢é”™è¯¯: {e}")
        import traceback
        logger.error(f"å®Œæ•´å †æ ˆ: {traceback.format_exc()}")
        error_content = Div(
            H1("å•†æˆ·ç®¡ç†é”™è¯¯", cls="text-2xl font-bold text-red-600 mb-4"),
            Pre(f"{str(e)}\n\n{traceback.format_exc()}", cls="bg-gray-100 p-4 rounded text-sm")
        )
        return create_layout("ç³»ç»Ÿé”™è¯¯", error_content)

# --- ç”¨æˆ·ç®¡ç†æ¨¡å—V2 FastHTML åŸç”Ÿè·¯ç”± ---

@app.get("/users")
@require_auth
async def users_list(request: Request):
    """ç”¨æˆ·ç®¡ç†é¡µé¢"""
    try:
        # è·å–æŸ¥è¯¢å‚æ•°
        params = request.query_params
        level_filter = params.get('level', '')
        search_query = params.get('search', '').strip()
        page = int(params.get('page', '1'))
        per_page = int(params.get('per_page', '20'))
        
        # è·å–ç”¨æˆ·æ•°æ®
        users = await user_manager.get_users_with_pagination(
            limit=per_page,
            offset=(page - 1) * per_page,
            level_filter=level_filter if level_filter else None,
            search=search_query if search_query else None
        )
        
        # è·å–æ€»ç”¨æˆ·æ•°
        total_users = await user_manager.count_users(
            level_filter=level_filter if level_filter else None,
            search=search_query if search_query else None
        )
        
        # è·å–ç»Ÿè®¡æ•°æ®
        stats = await user_manager.get_user_statistics()
        
        # è·å–ç­‰çº§åˆ—è¡¨ç”¨äºç­›é€‰
        levels = await incentive_manager.get_all_levels()
        
    except Exception as e:
        logger.error(f"è·å–ç”¨æˆ·æ•°æ®å¤±è´¥: {e}")
        import traceback
        logger.error(f"å®Œæ•´å †æ ˆ: {traceback.format_exc()}")
        error_content = Div(
            H1("ç”¨æˆ·ç®¡ç†é”™è¯¯", cls="text-2xl font-bold text-red-600 mb-4"),
            Pre(f"{str(e)}\n\n{traceback.format_exc()}", cls="bg-gray-100 p-4 rounded text-sm")
        )
        return create_layout("ç³»ç»Ÿé”™è¯¯", error_content)
    
    # ç»Ÿè®¡å¡ç‰‡
    stats_cards = Div(
        Div(
            Div("ç”¨æˆ·æ€»æ•°", cls="stat-title"),
            Div(str(stats.get('total_users', 0)), cls="stat-value text-primary"),
            cls="stat"
        ),
        Div(
            Div("æœ¬å‘¨æ´»è·ƒ", cls="stat-title"),
            Div(str(stats.get('weekly_active', 0)), cls="stat-value text-success"),
            cls="stat"
        ),
        Div(
            Div("å¹³å‡ç§¯åˆ†", cls="stat-title"),
            Div(f"{stats.get('avg_points', 0):.1f}", cls="stat-value text-warning"),
            cls="stat"
        ),
        Div(
            Div("é«˜ç­‰çº§ç”¨æˆ·", cls="stat-title"),
            Div(str(stats.get('high_level_users', 0)), cls="stat-value text-info"),
            cls="stat"
        ),
        cls="stats shadow mb-6"
    )
    
    # æœç´¢ç­›é€‰å·¥å…·æ 
    filter_form = Form(
        Div(
            Div(
                Label("ç­‰çº§ç­›é€‰", cls="label"),
                Select(
                    Option("æ‰€æœ‰ç­‰çº§", value="", selected=(not level_filter)),
                    *[Option(level['level_name'], value=level['level_name'], 
                            selected=(level_filter == level['level_name'])) for level in levels],
                    name="level",
                    cls="select select-bordered w-full",
                    **{"data-test": "level-filter"}
                ),
                cls="form-control"
            ),
            Div(
                Label("ç”¨æˆ·æœç´¢", cls="label"),
                Input(
                    name="search",
                    placeholder="è¾“å…¥ç”¨æˆ·åæˆ–ç”¨æˆ·IDæœç´¢...",
                    value=search_query,
                    cls="input input-bordered w-full",
                    **{"data-test": "user-search-input"}
                ),
                cls="form-control"
            ),
            Div(
                Label("æ¯é¡µæ˜¾ç¤º", cls="label"),
                Select(
                    Option("10æ¡", value="10", selected=(per_page == 10)),
                    Option("20æ¡", value="20", selected=(per_page == 20)),
                    Option("50æ¡", value="50", selected=(per_page == 50)),
                    Option("100æ¡", value="100", selected=(per_page == 100)),
                    name="per_page",
                    cls="select select-bordered w-full",
                    **{"data-test": "per-page-select"}
                ),
                cls="form-control"
            ),
            Div(
                Button("æœç´¢ç­›é€‰", type="submit", cls="btn btn-primary", **{"data-test": "apply-filter-btn"}),
                Button("æ¸…é™¤ç­›é€‰", type="button", onclick="window.location.href='/users'", cls="btn btn-ghost ml-2", **{"data-test": "clear-filter-btn"}),
                cls="form-control mt-4"
            ),
            cls="grid grid-cols-1 md:grid-cols-4 gap-4"
        ),
        method="GET",
        action="/users",
        cls="card bg-base-100 shadow-xl p-6 mb-6"
    )
    
    # ç”¨æˆ·åˆ—è¡¨è¡¨æ ¼
    table_rows = []
    for user in users:
        import json
        badges_count = len(json.loads(user.get('badges', '[]'))) if user.get('badges') else 0
        
        row = Tr(
            Td(
                Div(
                    Strong(user.get('username', f"ç”¨æˆ·{user['user_id']}"), cls="font-medium text-sm"),
                    P(f"ID: {user['user_id']}", cls="text-xs text-gray-500 font-mono"),
                    cls="space-y-1"
                )
            ),
            Td(
                Span(user.get('level_name', 'æ–°æ‰‹'), cls="badge badge-primary text-xs")
            ),
            Td(Strong(str(user.get('xp', 0)), cls="text-primary"), cls="text-center"),
            Td(Strong(str(user.get('points', 0)), cls="text-warning"), cls="text-center"),
            Td(Strong(str(user.get('order_count', 0)), cls="text-success"), cls="text-center"),
            Td(Span(f"ğŸ† {badges_count}", cls="text-sm text-info"), cls="text-center"),
            Td(
                Div(
                    A("ğŸ‘ï¸", href=f"/users/{user['user_id']}/detail", 
                      cls="btn btn-ghost btn-xs", title="æŸ¥çœ‹è¯¦æƒ…", **{"data-test": f"user-detail-{user['user_id']}"}),
                    cls="flex gap-1"
                )
            ),
            cls="hover:bg-gray-50"
        )
        table_rows.append(row)
    
    # åˆ†é¡µè®¡ç®—
    total_pages = (total_users + per_page - 1) // per_page
    
    # ç®€å•åˆ†é¡µå¯¼èˆª
    pagination_links = []
    if page > 1:
        prev_params = dict(params)
        prev_params['page'] = str(page - 1)
        prev_query = '&'.join([f"{k}={v}" for k, v in prev_params.items() if v])
        pagination_links.append(A("â€¹ ä¸Šä¸€é¡µ", href=f"/users?{prev_query}", cls="btn btn-outline btn-sm"))
    
    pagination_links.append(Span(f"ç¬¬ {page} é¡µï¼Œå…± {total_pages} é¡µ", cls="text-sm"))
    
    if page < total_pages:
        next_params = dict(params)
        next_params['page'] = str(page + 1)
        next_query = '&'.join([f"{k}={v}" for k, v in next_params.items() if v])
        pagination_links.append(A("ä¸‹ä¸€é¡µ â€º", href=f"/users?{next_query}", cls="btn btn-outline btn-sm"))
    
    # ä¸»è¡¨æ ¼
    users_table = Div(
        Table(
            Thead(
                Tr(
                    Th("ç”¨æˆ·"),
                    Th("ç­‰çº§"),
                    Th("ç»éªŒå€¼", cls="text-center"),
                    Th("ç§¯åˆ†", cls="text-center"),
                    Th("è®¢å•æ•°", cls="text-center"),
                    Th("å‹‹ç« ", cls="text-center"),
                    Th("æ“ä½œ", cls="w-24")
                )
            ),
            Tbody(*table_rows if table_rows else [
                Tr(Td("æš‚æ— ç”¨æˆ·æ•°æ®", colspan="7", cls="text-center text-gray-500"))
            ]),
            cls="table table-zebra w-full"
        ),
        cls="overflow-x-auto bg-white rounded-lg shadow"
    )
    
    # å·¥å…·æ ï¼šå¯¼å‡º/åˆ†æ
    current_query = request.url.query
    toolbar = Div(
        A("ğŸ“‹ å¯¼å‡ºæ•°æ®", href=(f"/users/export?{current_query}" if current_query else "/users/export"), cls="btn btn-outline btn-sm", **{"data-test": "users-export-btn"}),
        A("ğŸ“Š æŸ¥çœ‹åˆ†æ", href="/users/analytics", cls="btn btn-info btn-sm ml-2", **{"data-test": "users-analytics-btn"}),
        cls="mb-4"
    )

    content = Div(
        H1("ç”¨æˆ·ç®¡ç†", cls="page-title"),
        stats_cards,
        filter_form,
        toolbar,
        users_table,
        
        # åˆ†é¡µä¿¡æ¯
        Div(
            Div(*pagination_links, cls="flex gap-2 items-center"),
            P(f"æ˜¾ç¤ºç¬¬ {(page-1)*per_page+1}-{min(page*per_page, total_users)} æ¡ï¼Œå…± {total_users} ä¸ªç”¨æˆ·",
              cls="text-sm text-gray-500"),
            cls="flex justify-between items-center mt-6"
        )
    )
    
    return create_layout("ç”¨æˆ·ç®¡ç†", content)

# --- ç”¨æˆ·åˆ†æï¼ˆFastHTML åŸç”Ÿè·¯ç”±ï¼‰ ---

@app.get("/users/analytics")
@require_auth
async def users_analytics_dashboard(request: Request):
    """ç”¨æˆ·æ¿€åŠ±ç³»ç»Ÿåˆ†æä»ªè¡¨æ¿ï¼ˆFastHTML åŸç”Ÿï¼‰"""
    try:
        # ç­‰çº§åˆ†å¸ƒ
        level_distribution = await user_manager.get_level_distribution()
        # è¿‘30å¤©æ´»è·ƒåº¦
        from datetime import datetime, timedelta
        activity_dates = []
        activity_counts = []
        for i in range(30):
            date = datetime.now().date() - timedelta(days=i)
            activity_dates.append(date.strftime('%m-%d'))
            activity_counts.append(await user_manager.count_active_users_on_date(date.isoformat()))
        activity_dates.reverse(); activity_counts.reverse()
        # çƒ­é—¨å‹‹ç« 
        popular_badges = await user_manager.get_popular_badges(10)
        badge_names = [f"{b.get('badge_icon', 'ğŸ†')} {b['badge_name']}" for b in popular_badges]
        badge_counts = [b['user_count'] for b in popular_badges]
        # ç§¯åˆ†åˆ†å¸ƒ
        points_ranges = ['0', '1-100', '101-500', '501-1000', '1001-5000', '5000+']
        points_counts = [
            await user_manager.count_users_by_points_range(0,0),
            await user_manager.count_users_by_points_range(1,100),
            await user_manager.count_users_by_points_range(101,500),
            await user_manager.count_users_by_points_range(501,1000),
            await user_manager.count_users_by_points_range(1001,5000),
            await user_manager.count_users_by_points_range(5001,None)
        ]
        # è¯„ä»·æ´»è·ƒåº¦ï¼ˆè¿‘7å¤©ï¼‰
        review_dates = []
        review_counts = []
        for i in range(7):
            d = datetime.now().date() - timedelta(days=i)
            review_dates.append(d.strftime('%m-%d'))
            review_counts.append(await review_manager.count_reviews(date_from=d.isoformat(), date_to=(d+timedelta(days=1)).isoformat()))
        review_dates.reverse(); review_counts.reverse()
        # ç»éªŒå€¼åˆ†å¸ƒ
        xp_ranges = ['0', '1-50', '51-200', '201-500', '501-1000', '1000+']
        xp_counts = [
            await user_manager.count_users_by_xp_range(0,0),
            await user_manager.count_users_by_xp_range(1,50),
            await user_manager.count_users_by_xp_range(51,200),
            await user_manager.count_users_by_xp_range(201,500),
            await user_manager.count_users_by_xp_range(501,1000),
            await user_manager.count_users_by_xp_range(1001,None)
        ]
        
        data = {
            'level_names': level_distribution['names'],
            'level_counts': level_distribution['counts'],
            'activity_dates': activity_dates,
            'activity_counts': activity_counts,
            'badge_names': badge_names,
            'badge_counts': badge_counts,
            'points_ranges': points_ranges,
            'points_counts': points_counts,
            'review_activity_dates': review_dates,
            'review_activity_counts': review_counts,
            'xp_ranges': xp_ranges,
            'xp_counts': xp_counts
        }
    except Exception as e:
        logger.error(f"è·å–ç”¨æˆ·åˆ†ææ•°æ®å¤±è´¥: {e}")
        error_content = Div(
            H1("ç”¨æˆ·æ•°æ®åˆ†æé”™è¯¯", cls="text-2xl font-bold text-red-600 mb-4"),
            Pre(str(e), cls="bg-gray-100 p-4 rounded text-sm")
        )
        return create_layout("ç³»ç»Ÿé”™è¯¯", error_content)

    charts = Div(
        Div(
            Div(H3("ğŸ“Š ç”¨æˆ·ç­‰çº§åˆ†å¸ƒ", cls="text-xl font-semibold mb-4"), Canvas(id="levelDistributionChart", width="400", height="200"), cls="bg-white p-6 rounded-lg shadow"),
            Div(H3("ğŸ“ˆ ç”¨æˆ·æ´»è·ƒåº¦è¶‹åŠ¿ (è¿‘30å¤©)", cls="text-xl font-semibold mb-4"), Canvas(id="userActivityChart", width="400", height="200"), cls="bg-white p-6 rounded-lg shadow"),
            cls="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"
        ),
        Div(
            Div(H3("ğŸ† çƒ­é—¨å‹‹ç« æ’è¡Œ (Top 10)", cls="text-xl font-semibold mb-4"), Canvas(id="popularBadgesChart", width="400", height="300"), cls="bg-white p-6 rounded-lg shadow"),
            Div(H3("ğŸ’° ç”¨æˆ·ç§¯åˆ†åˆ†å¸ƒ", cls="text-xl font-semibold mb-4"), Canvas(id="pointsDistributionChart", width="400", height="300"), cls="bg-white p-6 rounded-lg shadow"),
            cls="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"
        ),
        Div(
            Div(H3("â­ è¯„ä»·æ´»è·ƒåº¦ç»Ÿè®¡", cls="text-xl font-semibold mb-4"), Canvas(id="reviewActivityChart", width="400", height="250"), cls="bg-white p-6 rounded-lg shadow"),
            Div(H3("ğŸ“ˆ ç”¨æˆ·æˆé•¿è½¨è¿¹ (ç»éªŒå€¼åˆ†å¸ƒ)", cls="text-xl font-semibold mb-4"), Canvas(id="userGrowthChart", width="400", height="250"), cls="bg-white p-6 rounded-lg shadow"),
            cls="grid grid-cols-1 lg:grid-cols-2 gap-6"
        )
    )

    import json as _json
    chartjs = Script(src="https://cdn.jsdelivr.net/npm/chart.js")
    init_script = Script(f"""
    const data = {_json.dumps(data)};
    const doughnut = (ctx, labels, values, colors) => new Chart(ctx, {{type:'doughnut', data:{{labels:labels, datasets:[{{data:values, backgroundColor:colors, borderWidth:2, borderColor:'#fff'}}]}}, options:{{responsive:true,plugins:{{legend:{{position:'right'}}}}}}}});
    const line = (ctx, labels, values) => new Chart(ctx, {{type:'line', data:{{labels:labels, datasets:[{{label:'æ´»è·ƒç”¨æˆ·æ•°', data:values, borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,0.1)', tension:0.1, fill:true}}]}}, options:{{responsive:true,plugins:{{legend:{{display:false}}}}}}}});
    const bar = (ctx, labels, values, color) => new Chart(ctx, {{type:'bar', data:{{labels:labels, datasets:[{{label:'æ•°é‡', data:values, backgroundColor:color, borderColor:color.replace('0.8','1'), borderWidth:1}}]}}, options:{{responsive:true,plugins:{{legend:{{display:false}}}},scales:{{y:{{beginAtZero:true}}}}}}}});
    doughnut(document.getElementById('levelDistributionChart'), data.level_names, data.level_counts, ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4']);
    line(document.getElementById('userActivityChart'), data.activity_dates, data.activity_counts);
    bar(document.getElementById('popularBadgesChart'), data.badge_names, data.badge_counts, 'rgba(245,158,11,0.8)');
    bar(document.getElementById('pointsDistributionChart'), data.points_ranges, data.points_counts, 'rgba(16,185,129,0.8)');
    bar(document.getElementById('reviewActivityChart'), data.review_activity_dates, data.review_activity_counts, 'rgba(139,92,246,0.8)');
    bar(document.getElementById('userGrowthChart'), data.xp_ranges, data.xp_counts, 'rgba(236,72,153,0.8)');
    """)

    content = Div(
        H1("ç”¨æˆ·æ¿€åŠ±ç³»ç»Ÿæ•°æ®åˆ†æ", cls="page-title"),
        Div(
            A("â† è¿”å›ç”¨æˆ·åˆ—è¡¨", href="/users", cls="btn btn-outline mb-6"),
            A("âš™ï¸ ç­‰çº§é…ç½®", href="/incentives", cls="btn btn-secondary mb-6 ml-2"),
        ),
        charts,
        chartjs,
        init_script
    )
    return create_layout("ç”¨æˆ·æ•°æ®åˆ†æ", content)

@app.get("/users/analytics-data")
@require_auth
async def users_analytics_data_api(request: Request):
    """è¿”å›ç”¨æˆ·åˆ†ææ•°æ®JSONï¼ˆå¦‚éœ€å‰ç«¯è½®è¯¢ï¼‰"""
    import json as _json
    try:
        # ç®€åŒ–å®ç°ï¼šå¤ç”¨ä»ªè¡¨æ¿é€»è¾‘å†æ¬¡æŸ¥è¯¢ï¼ˆä¹Ÿå¯æ¥å…¥ç¼“å­˜ï¼‰
        from datetime import datetime, timedelta
        level_distribution = await user_manager.get_level_distribution()
        activity_dates=[]; activity_counts=[]
        for i in range(30):
            d = datetime.now().date() - timedelta(days=i)
            activity_dates.append(d.strftime('%m-%d'))
            activity_counts.append(await user_manager.count_active_users_on_date(d.isoformat()))
        activity_dates.reverse(); activity_counts.reverse()
        popular_badges = await user_manager.get_popular_badges(10)
        badge_names = [f"{b.get('badge_icon', 'ğŸ†')} {b['badge_name']}" for b in popular_badges]
        badge_counts = [b['user_count'] for b in popular_badges]
        points_ranges=['0','1-100','101-500','501-1000','1001-5000','5000+']
        points_counts=[
            await user_manager.count_users_by_points_range(0,0),
            await user_manager.count_users_by_points_range(1,100),
            await user_manager.count_users_by_points_range(101,500),
            await user_manager.count_users_by_points_range(501,1000),
            await user_manager.count_users_by_points_range(1001,5000),
            await user_manager.count_users_by_points_range(5001,None)
        ]
        review_dates=[]; review_counts=[]
        for i in range(7):
            d = datetime.now().date() - timedelta(days=i)
            review_dates.append(d.strftime('%m-%d'))
            review_counts.append(await review_manager.count_reviews(date_from=d.isoformat(), date_to=(d+timedelta(days=1)).isoformat()))
        review_dates.reverse(); review_counts.reverse()
        xp_ranges=['0','1-50','51-200','201-500','501-1000','1000+']
        xp_counts=[
            await user_manager.count_users_by_xp_range(0,0),
            await user_manager.count_users_by_xp_range(1,50),
            await user_manager.count_users_by_xp_range(51,200),
            await user_manager.count_users_by_xp_range(201,500),
            await user_manager.count_users_by_xp_range(501,1000),
            await user_manager.count_users_by_xp_range(1001,None)
        ]
        payload = {
            'level_names': level_distribution['names'],
            'level_counts': level_distribution['counts'],
            'activity_dates': activity_dates,
            'activity_counts': activity_counts,
            'badge_names': badge_names,
            'badge_counts': badge_counts,
            'points_ranges': points_ranges,
            'points_counts': points_counts,
            'review_activity_dates': review_dates,
            'review_activity_counts': review_counts,
            'xp_ranges': xp_ranges,
            'xp_counts': xp_counts
        }
        from starlette.responses import Response as _Resp
        return _Resp(content=_json.dumps(payload, ensure_ascii=False), media_type="application/json")
    except Exception as e:
        logger.error(f"ç”¨æˆ·åˆ†ææ•°æ®APIå¤±è´¥: {e}")
        from starlette.responses import Response as _Resp
        return _Resp(content=_json.dumps({"error":"è·å–æ•°æ®å¤±è´¥"}, ensure_ascii=False), status_code=500, media_type="application/json")

@app.get("/users/{user_id}/detail")
@require_auth
async def user_detail(request: Request):
    """ç”¨æˆ·è¯¦æƒ…é¡µé¢"""
    user_id = int(request.path_params['user_id'])
    
    try:
        # è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
        user_info = await user_manager.get_user_with_details(user_id)
        if not user_info:
            error_content = Div(
                H2("ç”¨æˆ·ä¸å­˜åœ¨", cls="text-2xl font-bold text-red-600 mb-4"),
                P("æ‚¨æŸ¥æ‰¾çš„ç”¨æˆ·ä¸å­˜åœ¨ã€‚"),
                A("è¿”å›ç”¨æˆ·åˆ—è¡¨", href="/users", cls="btn btn-primary mt-4")
            )
            return create_layout("ç”¨æˆ·ä¸å­˜åœ¨", error_content)
        
    except Exception as e:
        logger.error(f"è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥: {e}")
        import traceback
        logger.error(f"å®Œæ•´å †æ ˆ: {traceback.format_exc()}")
        error_content = Div(
            H1("ç”¨æˆ·è¯¦æƒ…é”™è¯¯", cls="text-2xl font-bold text-red-600 mb-4"),
            Pre(f"{str(e)}\n\n{traceback.format_exc()}", cls="bg-gray-100 p-4 rounded text-sm")
        )
        return create_layout("ç³»ç»Ÿé”™è¯¯", error_content)
    
    import json
    badges = json.loads(user_info.get('badges', '[]')) if user_info.get('badges') else []
    
    # ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å¡ç‰‡
    user_info_card = Div(
        H3("ğŸ‘¤ åŸºæœ¬ä¿¡æ¯", cls="text-xl font-semibold mb-4"),
        Div(
            Div(f"ç”¨æˆ·ID: {user_info['user_id']}", cls="font-mono text-lg mb-2"),
            Div(f"ç”¨æˆ·å: {user_info.get('username', 'æœªè®¾ç½®')}", cls="mb-2"),
            Div(f"å½“å‰ç­‰çº§: {user_info.get('level_name', 'æ–°æ‰‹')}", cls="badge badge-primary badge-lg mb-2"),
            Div(f"ç»éªŒå€¼: {user_info.get('xp', 0)} XP", cls="text-primary font-bold mb-2"),
            Div(f"ç§¯åˆ†: {user_info.get('points', 0)} åˆ†", cls="text-warning font-bold mb-2"),
            Div(f"å®Œæˆè®¢å•: {user_info.get('total_orders', 0)} æ¬¡", cls="text-success font-bold mb-2"),
            Div(f"å‘è¡¨è¯„ä»·: {user_info.get('total_reviews', 0)} æ¬¡", cls="text-info font-bold mb-2"),
            cls="space-y-3"
        ),
        cls="bg-white p-6 rounded-lg shadow"
    )
    
    # å‹‹ç« å±•ç¤ºå¡ç‰‡
    badge_items = []
    for badge in badges:
        badge_item = Div(
            Div(
                Span("ğŸ†", cls="text-2xl"),
                P(badge, cls="font-medium text-sm"),
                cls="text-center space-y-1"
            ),
            cls="bg-gray-50 p-3 rounded-lg"
        )
        badge_items.append(badge_item)
    
    badges_card = Div(
        H3("ğŸ† è·å¾—å‹‹ç« ", cls="text-xl font-semibold mb-4"),
        Div(
            *badge_items if badge_items else [P("æš‚æ— å‹‹ç« ", cls="text-gray-500 text-center py-8")],
            cls="grid grid-cols-2 md:grid-cols-3 gap-3"
        ),
        cls="bg-white p-6 rounded-lg shadow"
    )
    
    content = Div(
        H1(f"ç”¨æˆ·è¯¦æƒ… - {user_info.get('username', f'ç”¨æˆ·{user_id}')}", cls="page-title"),
        
        Div(
            # å·¦ä¾§
            user_info_card,
            # å³ä¾§
            badges_card,
            cls="grid grid-cols-1 lg:grid-cols-2 gap-8"
        ),
        
        # è¿”å›æŒ‰é’®
        Div(
            A("â† è¿”å›ç”¨æˆ·åˆ—è¡¨", href="/users", cls="btn btn-outline"),
            cls="mt-8"
        )
    )
    
    return create_layout("ç”¨æˆ·è¯¦æƒ…", content)

@app.get("/users/export")
@require_auth
async def users_export(request: Request):
    """å¯¼å‡ºç”¨æˆ·æ•°æ®ä¸ºCSV"""
    try:
        # è·å–ç­›é€‰å‚æ•°
        params = request.query_params
        level_filter = params.get("level") if params.get("level") else None
        search_query = params.get("search") if params.get("search") else None
        
        users = await user_manager.get_users_with_pagination(
            limit=10000,  # å¯¼å‡ºé™åˆ¶
            level_filter=level_filter,
            search=search_query
        )
        
        # åˆ›å»ºCSVå†…å®¹
        import csv
        import io
        from datetime import datetime
        
        output = io.StringIO()
        writer = csv.writer(output)
        
        # å†™å…¥è¡¨å¤´
        writer.writerow([
            'ç”¨æˆ·ID', 'ç”¨æˆ·å', 'ç­‰çº§', 'ç»éªŒå€¼', 'ç§¯åˆ†', 'è®¢å•æ•°', 'å‹‹ç« æ•°', 'æ³¨å†Œæ—¶é—´'
        ])
        
        # å†™å…¥æ•°æ®
        import json
        for user in users:
            badges_count = len(json.loads(user.get('badges', '[]'))) if user.get('badges') else 0
            writer.writerow([
                user['user_id'],
                user.get('username', ''),
                user.get('level_name', 'æ–°æ‰‹'),
                user.get('xp', 0),
                user.get('points', 0),
                user.get('order_count', 0),
                badges_count,
                user.get('created_at', '')
            ])
        
        # å‡†å¤‡å“åº”
        output.seek(0)
        filename = f"users_export_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        
        from starlette.responses import StreamingResponse
        
        def generate():
            yield output.getvalue().encode('utf-8-sig')  # BOM for Excel
        
        return StreamingResponse(
            generate(),
            media_type="text/csv",
            headers={"Content-Disposition": f"attachment; filename={filename}"}
        )
        
    except Exception as e:
        logger.error(f"å¯¼å‡ºç”¨æˆ·æ•°æ®å¤±è´¥: {e}")
        error_content = Div(
            H1("å¯¼å‡ºå¤±è´¥", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"å¯¼å‡ºç”¨æˆ·æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"),
            A("è¿”å›ç”¨æˆ·ç®¡ç†", href="/users", cls="btn btn-primary mt-4")
        )
        return create_layout("å¯¼å‡ºå¤±è´¥", error_content)

# --- è¯„ä»·ç®¡ç†æ¨¡å—V2 FastHTML åŸç”Ÿè·¯ç”± ---

@app.get("/reviews")
@require_auth
async def reviews_list(request: Request):
    """è¯„ä»·ç®¡ç†é¡µé¢"""
    try:
        # è·å–æŸ¥è¯¢å‚æ•°
        params = request.query_params
        status_filter = params.get('status', '')
        confirmed_filter = params.get('confirmed', '')
        search_query = params.get('search', '').strip()
        page = int(params.get('page', '1'))
        per_page = int(params.get('per_page', '20'))
        date_from = params.get('date_from', '')
        date_to = params.get('date_to', '')
        
        # æ„å»ºæŸ¥è¯¢å‚æ•°
        query_params = {
            'status': status_filter if status_filter else None,
            'is_confirmed': confirmed_filter == 'true' if confirmed_filter else None,
            'date_from': date_from if date_from else None,
            'date_to': date_to if date_to else None,
            'limit': per_page,
            'offset': (page - 1) * per_page
        }
        
        # è·å–è¯„ä»·æ•°æ®
        reviews = await review_manager.get_reviews_with_details(**query_params)
        
        # è·å–æ€»æ•°ç”¨äºåˆ†é¡µ
        total_reviews = await review_manager.count_reviews(
            status=query_params['status'],
            is_confirmed=query_params['is_confirmed'],
            date_from=query_params['date_from'],
            date_to=query_params['date_to']
        )
        
        # è·å–ç»Ÿè®¡æ•°æ®
        total_count = await review_manager.count_reviews()
        confirmed_count = await review_manager.count_reviews(is_confirmed=True)
        pending_count = await review_manager.count_reviews(is_confirmed=False)
        avg_rating = await review_manager.get_average_rating()
        
        # è·å–å•†æˆ·åˆ—è¡¨ç”¨äºç­›é€‰
        merchants = await merchant_manager.get_merchants(limit=100)
        
    except Exception as e:
        logger.error(f"è·å–è¯„ä»·æ•°æ®å¤±è´¥: {e}")
        import traceback
        logger.error(f"å®Œæ•´å †æ ˆ: {traceback.format_exc()}")
        error_content = Div(
            H1("è¯„ä»·ç®¡ç†é”™è¯¯", cls="text-2xl font-bold text-red-600 mb-4"),
            Pre(f"{str(e)}\n\n{traceback.format_exc()}", cls="bg-gray-100 p-4 rounded text-sm")
        )
        return create_layout("ç³»ç»Ÿé”™è¯¯", error_content)
    
    # ç»Ÿè®¡å¡ç‰‡
    stats_cards = Div(
        Div(
            Div("è¯„ä»·æ€»æ•°", cls="stat-title"),
            Div(str(total_count), cls="stat-value text-primary"),
            cls="stat"
        ),
        Div(
            Div("æœ‰æ•ˆè¯„ä»·", cls="stat-title"),
            Div(str(confirmed_count), cls="stat-value text-success"),
            cls="stat"
        ),
        Div(
            Div("å¾…ç¡®è®¤", cls="stat-title"),
            Div(str(pending_count), cls="stat-value text-warning"),
            cls="stat"
        ),
        Div(
            Div("å¹³å‡è¯„åˆ†", cls="stat-title"),
            Div(f"{avg_rating:.1f}", cls="stat-value text-info"),
            cls="stat"
        ),
        cls="stats shadow mb-6"
    )
    
    # æœç´¢ç­›é€‰å·¥å…·æ 
    filter_form = Form(
        Div(
            Div(
                Label("è¯„ä»·çŠ¶æ€", cls="label"),
                Select(
                    Option("å…¨éƒ¨çŠ¶æ€", value="", selected=(not status_filter)),
                    Option("å¾…å•†æˆ·ç¡®è®¤", value="pending_merchant_confirmation", selected=(status_filter == "pending_merchant_confirmation")),
                    Option("å·²å®Œæˆ", value="completed", selected=(status_filter == "completed")),
                    name="status",
                    cls="select select-bordered w-full"
                ),
                cls="form-control"
            ),
            Div(
                Label("ç¡®è®¤çŠ¶æ€", cls="label"),
                Select(
                    Option("å…¨éƒ¨", value="", selected=(not confirmed_filter)),
                    Option("å·²ç¡®è®¤", value="true", selected=(confirmed_filter == "true")),
                    Option("æœªç¡®è®¤", value="false", selected=(confirmed_filter == "false")),
                    name="confirmed",
                    cls="select select-bordered w-full"
                ),
                cls="form-control"
            ),
            Div(
                Label("å¼€å§‹æ—¥æœŸ", cls="label"),
                Input(
                    name="date_from",
                    type="date",
                    value=date_from,
                    cls="input input-bordered w-full"
                ),
                cls="form-control"
            ),
            Div(
                Label("ç»“æŸæ—¥æœŸ", cls="label"),
                Input(
                    name="date_to",
                    type="date",
                    value=date_to,
                    cls="input input-bordered w-full"
                ),
                cls="form-control"
            ),
            Div(
                Label("æ¯é¡µæ˜¾ç¤º", cls="label"),
                Select(
                    Option("10æ¡", value="10", selected=(per_page == 10)),
                    Option("20æ¡", value="20", selected=(per_page == 20)),
                    Option("50æ¡", value="50", selected=(per_page == 50)),
                    name="per_page",
                    cls="select select-bordered w-full"
                ),
                cls="form-control"
            ),
            Div(
                Button("æœç´¢ç­›é€‰", type="submit", cls="btn btn-primary", **{"data-test": "apply-review-filter"}),
                Button("æ¸…é™¤ç­›é€‰", type="button", onclick="window.location.href='/reviews'", cls="btn btn-ghost ml-2", **{"data-test": "clear-review-filter"}),
                A("å¯¼å‡ºæ•°æ®", href=f"/reviews/export?{request.url.query}" if request.url.query else "/reviews/export", cls="btn btn-outline ml-2", **{"data-test": "reviews-export-btn"}),
                cls="form-control mt-4"
            ),
            cls="grid grid-cols-1 md:grid-cols-6 gap-4"
        ),
        method="GET",
        action="/reviews",
        cls="card bg-base-100 shadow-xl p-6 mb-6"
    )
    
    # è¯„ä»·åˆ—è¡¨è¡¨æ ¼
    table_rows = []
    for review in reviews:
        # è®¡ç®—å¹³å‡è¯„åˆ†
        ratings = [
            review.get('rating_appearance', 0),
            review.get('rating_figure', 0), 
            review.get('rating_service', 0),
            review.get('rating_attitude', 0),
            review.get('rating_environment', 0)
        ]
        avg_rating_single = sum(r for r in ratings if r > 0) / len([r for r in ratings if r > 0]) if any(r > 0 for r in ratings) else 0
        
        row = Tr(
            Td(
                Div(
                    Strong(f"#{review['id']}", cls="font-mono text-sm"),
                    P(f"è®¢å•: {review['order_id']}", cls="text-xs text-gray-500"),
                    cls="space-y-1"
                )
            ),
            Td(
                Div(
                    P(review.get('customer_username', f"ç”¨æˆ·{review['customer_user_id']}"), cls="font-medium text-sm"),
                    P(f"ID: {review['customer_user_id']}", cls="text-xs text-gray-500"),
                    cls="space-y-1"
                )
            ),
            Td(
                Div(
                    P(review.get('merchant_name', 'æœªçŸ¥å•†æˆ·'), cls="font-medium text-sm"),
                    P(f"ID: {review['merchant_id']}", cls="text-xs text-gray-500"),
                    cls="space-y-1"
                )
            ),
            Td(
                Div(
                    Strong(f"{avg_rating_single:.1f}/10", cls="text-primary"),
                    P("å¹³å‡åˆ†", cls="text-xs text-gray-500"),
                    cls="text-center space-y-1"
                )
            ),
            Td(
                Span(
                    review['status'], 
                    cls=f"badge badge-{'success' if review['status'] == 'completed' else 'warning'}"
                )
            ),
            Td(
                Span(
                    "âœ… å·²ç¡®è®¤" if review.get('is_confirmed_by_merchant') else "â³ å¾…ç¡®è®¤",
                    cls="text-xs " + ("text-success" if review.get('is_confirmed_by_merchant') else "text-warning")
                )
            ),
            Td(
                review['created_at'][:16] if review.get('created_at') else '-'
            ),
            Td(
                Div(
                    A("ğŸ‘ï¸", href=f"/reviews/{review['id']}/detail", 
                      cls="btn btn-ghost btn-xs", title="æŸ¥çœ‹è¯¦æƒ…"),
                    A("âœï¸", href=f"/reviews/{review['id']}/manage", 
                      cls="btn btn-ghost btn-xs", title="ç®¡ç†è¯„ä»·"),
                    cls="flex gap-1"
                )
            ),
            cls="hover:bg-gray-50"
        )
        table_rows.append(row)
    
    # åˆ†é¡µè®¡ç®—
    total_pages = (total_reviews + per_page - 1) // per_page
    
    # åˆ†é¡µå¯¼èˆª
    pagination_links = []
    if page > 1:
        prev_params = dict(params)
        prev_params['page'] = str(page - 1)
        prev_query = '&'.join([f"{k}={v}" for k, v in prev_params.items() if v])
        pagination_links.append(A("â€¹ ä¸Šä¸€é¡µ", href=f"/reviews?{prev_query}", cls="btn btn-outline btn-sm"))
    
    pagination_links.append(Span(f"ç¬¬ {page} é¡µï¼Œå…± {total_pages} é¡µ", cls="text-sm"))
    
    if page < total_pages:
        next_params = dict(params)
        next_params['page'] = str(page + 1)
        next_query = '&'.join([f"{k}={v}" for k, v in next_params.items() if v])
        pagination_links.append(A("ä¸‹ä¸€é¡µ â€º", href=f"/reviews?{next_query}", cls="btn btn-outline btn-sm"))
    
    # ä¸»è¡¨æ ¼
    reviews_table = Div(
        Table(
            Thead(
                Tr(
                    Th("è¯„ä»·ID"),
                    Th("ç”¨æˆ·"),
                    Th("å•†æˆ·"),
                    Th("è¯„åˆ†", cls="text-center"),
                    Th("çŠ¶æ€"),
                    Th("ç¡®è®¤", cls="text-center"),
                    Th("æ—¶é—´"),
                    Th("æ“ä½œ", cls="w-24")
                )
            ),
            Tbody(*table_rows if table_rows else [
                Tr(Td("æš‚æ— è¯„ä»·æ•°æ®", colspan="8", cls="text-center text-gray-500"))
            ]),
            cls="table table-zebra w-full"
        ),
        cls="overflow-x-auto bg-white rounded-lg shadow"
    )
    
    content = Div(
        H1("è¯„ä»·ç®¡ç†", cls="page-title"),
        stats_cards,
        filter_form,
        reviews_table,
        
        # åˆ†é¡µä¿¡æ¯
        Div(
            Div(*pagination_links, cls="flex gap-2 items-center"),
            P(f"æ˜¾ç¤ºç¬¬ {(page-1)*per_page+1}-{min(page*per_page, total_reviews)} æ¡ï¼Œå…± {total_reviews} æ¡è¯„ä»·",
              cls="text-sm text-gray-500"),
            cls="flex justify-between items-center mt-6"
        )
    )
    
    return create_layout("è¯„ä»·ç®¡ç†", content)

@app.get("/reviews/{review_id}/detail")
@require_auth
async def review_detail(request: Request):
    """è¯„ä»·è¯¦æƒ…é¡µé¢"""
    review_id = int(request.path_params['review_id'])
    
    try:
        # è·å–è¯„ä»·è¯¦ç»†ä¿¡æ¯
        review = await review_manager.get_review_detail(review_id)
        if not review:
            error_content = Div(
                H2("è¯„ä»·ä¸å­˜åœ¨", cls="text-2xl font-bold text-red-600 mb-4"),
                P("æ‚¨æŸ¥æ‰¾çš„è¯„ä»·ä¸å­˜åœ¨ã€‚"),
                A("è¿”å›è¯„ä»·åˆ—è¡¨", href="/reviews", cls="btn btn-primary mt-4")
            )
            return create_layout("è¯„ä»·ä¸å­˜åœ¨", error_content)
        
    except Exception as e:
        logger.error(f"è·å–è¯„ä»·è¯¦æƒ…å¤±è´¥: {e}")
        import traceback
        logger.error(f"å®Œæ•´å †æ ˆ: {traceback.format_exc()}")
        error_content = Div(
            H1("è¯„ä»·è¯¦æƒ…é”™è¯¯", cls="text-2xl font-bold text-red-600 mb-4"),
            Pre(f"{str(e)}\n\n{traceback.format_exc()}", cls="bg-gray-100 p-4 rounded text-sm")
        )
        return create_layout("ç³»ç»Ÿé”™è¯¯", error_content)
    
    # è¯„ä»·åŸºæœ¬ä¿¡æ¯å¡ç‰‡
    review_info_card = Div(
        H3("ğŸ“‹ è¯„ä»·ä¿¡æ¯", cls="text-xl font-semibold mb-4"),
        Div(
            Div(f"è¯„ä»·ID: #{review['id']}", cls="font-mono text-lg mb-2"),
            Div(f"è®¢å•ID: #{review['order_id']}", cls="font-mono mb-2"),
            Div(f"çŠ¶æ€: {review['status']}", cls=f"badge badge-{'success' if review['status'] == 'completed' else 'warning'} badge-lg mb-2"),
            Div(f"ç¡®è®¤çŠ¶æ€: {'âœ… å·²ç¡®è®¤' if review.get('is_confirmed_by_merchant') else 'â³ å¾…ç¡®è®¤'}", 
                cls=f"{'text-success' if review.get('is_confirmed_by_merchant') else 'text-warning'} mb-2"),
            Div(f"è¯„ä»·æ—¶é—´: {review['created_at']}", cls="text-sm text-gray-500"),
            cls="space-y-3"
        ),
        cls="bg-white p-6 rounded-lg shadow"
    )
    
    # äº”ç»´è¯„åˆ†å¡ç‰‡
    rating_items = [
        ('é¢œå€¼è¯„åˆ†', review.get('rating_appearance', 0), 'ğŸ’„'),
        ('èº«æè¯„åˆ†', review.get('rating_figure', 0), 'ğŸ‘—'),
        ('æœåŠ¡è¯„åˆ†', review.get('rating_service', 0), 'ğŸ›ï¸'),
        ('æ€åº¦è¯„åˆ†', review.get('rating_attitude', 0), 'ğŸ˜Š'),
        ('ç¯å¢ƒè¯„åˆ†', review.get('rating_environment', 0), 'ğŸ ')
    ]
    
    rating_cards = []
    for name, score, icon in rating_items:
        card = Div(
            Div(
                Span(icon, cls="text-2xl"),
                P(name, cls="text-sm font-medium"),
                Strong(f"{score}/10", cls="text-lg text-primary"),
                cls="text-center space-y-1"
            ),
            cls="bg-gray-50 p-4 rounded-lg"
        )
        rating_cards.append(card)
    
    ratings_card = Div(
        H3("â­ äº”ç»´è¯„åˆ†", cls="text-xl font-semibold mb-4"),
        Div(*rating_cards, cls="grid grid-cols-2 md:grid-cols-5 gap-3"),
        cls="bg-white p-6 rounded-lg shadow"
    )
    
    # æ–‡å­—è¯„ä»·å¡ç‰‡
    text_review_card = Div(
        H3("ğŸ“ æ–‡å­—è¯„ä»·", cls="text-xl font-semibold mb-4"),
        Div(
            P(review.get('text_review_by_user', 'æš‚æ— æ–‡å­—è¯„ä»·'), 
              cls="text-gray-700 leading-relaxed" if review.get('text_review_by_user') else "text-gray-500 italic"),
            cls="bg-gray-50 p-4 rounded-lg"
        ),
        cls="bg-white p-6 rounded-lg shadow"
    )
    
    # ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
    user_info_card = Div(
        H3("ğŸ‘¤ è¯„ä»·ç”¨æˆ·", cls="text-xl font-semibold mb-4"),
        Div(
            P(f"ç”¨æˆ·ID: {review['customer_user_id']}", cls="font-mono mb-2"),
            P(f"ç”¨æˆ·å: {review.get('customer_username', 'æœªè®¾ç½®')}", cls="mb-2"),
            A("æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…", href=f"/users/{review['customer_user_id']}/detail", 
              cls="btn btn-outline btn-sm"),
            cls="space-y-2"
        ),
        cls="bg-white p-6 rounded-lg shadow"
    )
    
    # å•†æˆ·ä¿¡æ¯å¡ç‰‡
    merchant_info_card = Div(
        H3("ğŸª è¢«è¯„ä»·å•†æˆ·", cls="text-xl font-semibold mb-4"),
        Div(
            P(f"å•†æˆ·: {review.get('merchant_name', 'æœªçŸ¥å•†æˆ·')}", cls="font-medium mb-2"),
            P(f"å•†æˆ·ID: {review['merchant_id']}", cls="font-mono text-sm mb-2"),
            A("æŸ¥çœ‹å•†æˆ·è¯¦æƒ…", href=f"/posts/{review['merchant_id']}", 
              cls="btn btn-outline btn-sm"),
            cls="space-y-2"
        ),
        cls="bg-white p-6 rounded-lg shadow"
    )
    
    # ç”ŸæˆCSRF Token
    csrf_token = get_or_create_csrf_token(request)

    # ç®¡ç†æ“ä½œå¡ç‰‡ï¼ˆå¦‚æœè¯„ä»·æœªç¡®è®¤ï¼‰
    management_card = None
    if not review.get('is_confirmed_by_merchant'):
        management_card = Div(
            H3("âš™ï¸ ç®¡ç†æ“ä½œ", cls="text-xl font-semibold mb-4"),
            Div(
                P("è¯¥è¯„ä»·è¿˜æœªè¢«å•†æˆ·ç¡®è®¤ï¼Œç®¡ç†å‘˜å¯ä»¥è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š", cls="text-sm text-gray-600 mb-4"),
                Form(
                    Input(type="hidden", name="csrf_token", value=csrf_token),
                    Button("âœ… ä»£ä¸ºç¡®è®¤è¯„ä»·", type="submit", cls="btn btn-success", **{"data-test": "confirm-review-btn"}),
                    method="post",
                    action=f"/reviews/{review_id}/confirm"
                ),
                cls="space-y-3"
            ),
            cls="bg-yellow-50 border border-yellow-200 p-6 rounded-lg"
        )
    
    content = Div(
        H1(f"è¯„ä»·è¯¦æƒ… - #{review['id']}", cls="page-title"),
        
        Div(
            # å·¦ä¾§
            Div(
                review_info_card,
                ratings_card,
                text_review_card,
                *([management_card] if management_card else []),
                cls="space-y-6"
            ),
            
            # å³ä¾§
            Div(
                user_info_card,
                merchant_info_card,
                cls="space-y-6"
            ),
            
            cls="grid grid-cols-1 lg:grid-cols-2 gap-8"
        ),
        
        # è¿”å›æŒ‰é’®
        Div(
            A("â† è¿”å›è¯„ä»·åˆ—è¡¨", href="/reviews", cls="btn btn-outline"),
            cls="mt-8"
        )
    )
    
    return create_layout("è¯„ä»·è¯¦æƒ…", content)

@app.post("/reviews/{review_id}/confirm")
@require_auth
async def confirm_review_route(request: Request):
    """ç®¡ç†å‘˜ä»£ä¸ºç¡®è®¤è¯„ä»·"""
    review_id = int(request.path_params['review_id'])
    
    try:
        form = await request.form()
        if not validate_csrf(request, form.get('csrf_token', '')):
            return RedirectResponse(url=f"/reviews/{review_id}/detail?error=csrf", status_code=302)
        success = await review_manager.confirm_review(review_id)
        if success:
            return RedirectResponse(url=f"/reviews/{review_id}/detail?confirmed=1", status_code=302)
        else:
            return RedirectResponse(url=f"/reviews/{review_id}/detail?error=confirm_failed", status_code=302)
    except Exception as e:
        logger.error(f"ç¡®è®¤è¯„ä»·å¤±è´¥: {e}")
        return RedirectResponse(url=f"/reviews/{review_id}/detail?error=system_error", status_code=302)

@app.get("/reviews/{review_id}/manage")
@require_auth
async def review_manage(request: Request):
    """è¯„ä»·ç®¡ç†é¡µé¢ï¼ˆé¢„ç•™åŠŸèƒ½ï¼‰"""
    review_id = int(request.path_params['review_id'])
    
    try:
        review = await review_manager.get_review_detail(review_id)
        if not review:
            error_content = Div(
                H2("è¯„ä»·ä¸å­˜åœ¨", cls="text-2xl font-bold text-red-600 mb-4"),
                P("æ‚¨æŸ¥æ‰¾çš„è¯„ä»·ä¸å­˜åœ¨ã€‚"),
                A("è¿”å›è¯„ä»·åˆ—è¡¨", href="/reviews", cls="btn btn-primary mt-4")
            )
            return create_layout("è¯„ä»·ä¸å­˜åœ¨", error_content)
        
    except Exception as e:
        logger.error(f"è·å–è¯„ä»·ç®¡ç†é¡µé¢å¤±è´¥: {e}")
        return RedirectResponse(url=f"/reviews/{review_id}/detail", status_code=302)
    
    content = Div(
        H1(f"ç®¡ç†è¯„ä»· - #{review['id']}", cls="page-title"),
        
        # ç®¡ç†åŠŸèƒ½å¡ç‰‡
        Div(
            H3("ğŸ› ï¸ å¯ç”¨æ“ä½œ", cls="text-xl font-semibold mb-4"),
            Div(
                A("æŸ¥çœ‹è¯¦æƒ…", href=f"/reviews/{review_id}/detail", cls="btn btn-primary mr-2"),
                *([Form(
                    Input(type="hidden", name="csrf_token", value=get_or_create_csrf_token(request)),
                    Button("ç¡®è®¤è¯„ä»·", type="submit", cls="btn btn-success mr-2", **{"data-test": "confirm-review-inline-btn"}),
                    method="post",
                    action=f"/reviews/{review_id}/confirm",
                    cls="inline-block"
                )] if not review.get('is_confirmed_by_merchant') else []),
                A("è¿”å›åˆ—è¡¨", href="/reviews", cls="btn btn-outline"),
                cls="flex gap-2"
            ),
            cls="bg-white p-6 rounded-lg shadow"
        )
    )
    
    return create_layout("è¯„ä»·ç®¡ç†", content)

@app.get("/reviews/export")
@require_auth
async def reviews_export(request: Request):
    """å¯¼å‡ºè¯„ä»·æ•°æ®ä¸ºCSV"""
    try:
        # è·å–ç­›é€‰å‚æ•°
        params = request.query_params
        query_params = {
            'status': params.get('status') if params.get('status') else None,
            'is_confirmed': params.get('confirmed') == 'true' if params.get('confirmed') else None,
            'date_from': params.get('date_from') if params.get('date_from') else None,
            'date_to': params.get('date_to') if params.get('date_to') else None,
            'limit': 10000  # å¯¼å‡ºé™åˆ¶
        }
        
        reviews = await review_manager.get_reviews_with_details(**query_params)
        
        # åˆ›å»ºCSVå†…å®¹
        import csv
        import io
        from datetime import datetime
        
        output = io.StringIO()
        writer = csv.writer(output)
        
        # å†™å…¥è¡¨å¤´
        writer.writerow([
            'è¯„ä»·ID', 'è®¢å•ID', 'ç”¨æˆ·ID', 'ç”¨æˆ·å', 'å•†æˆ·ID', 'å•†æˆ·å',
            'é¢œå€¼è¯„åˆ†', 'èº«æè¯„åˆ†', 'æœåŠ¡è¯„åˆ†', 'æ€åº¦è¯„åˆ†', 'ç¯å¢ƒè¯„åˆ†',
            'æ–‡å­—è¯„ä»·', 'çŠ¶æ€', 'å•†æˆ·ç¡®è®¤', 'è¯„ä»·æ—¶é—´'
        ])
        
        # å†™å…¥æ•°æ®
        for review in reviews:
            writer.writerow([
                review['id'],
                review['order_id'],
                review['customer_user_id'],
                review.get('customer_username', ''),
                review['merchant_id'],
                review.get('merchant_name', ''),
                review.get('rating_appearance', ''),
                review.get('rating_figure', ''),
                review.get('rating_service', ''),
                review.get('rating_attitude', ''),
                review.get('rating_environment', ''),
                review.get('text_review_by_user', ''),
                review['status'],
                'æ˜¯' if review.get('is_confirmed_by_merchant') else 'å¦',
                review['created_at']
            ])
        
        # å‡†å¤‡å“åº”
        output.seek(0)
        filename = f"reviews_export_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        
        from starlette.responses import StreamingResponse
        
        def generate():
            yield output.getvalue().encode('utf-8-sig')  # BOM for Excel
        
        return StreamingResponse(
            generate(),
            media_type="text/csv",
            headers={"Content-Disposition": f"attachment; filename={filename}"}
        )
        
    except Exception as e:
        logger.error(f"å¯¼å‡ºè¯„ä»·æ•°æ®å¤±è´¥: {e}")
        error_content = Div(
            H1("å¯¼å‡ºå¤±è´¥", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"å¯¼å‡ºè¯„ä»·æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"),
            A("è¿”å›è¯„ä»·ç®¡ç†", href="/reviews", cls="btn btn-primary mt-4")
        )
        return create_layout("å¯¼å‡ºå¤±è´¥", error_content)


# ================================== ç»‘å®šç ç®¡ç†æ¨¡å—V2 ==================================

@app.get("/binding-codes")
@require_auth
async def binding_codes_list(request: Request):
    """ç»‘å®šç åˆ—è¡¨é¡µé¢"""
    try:
        # è·å–æŸ¥è¯¢å‚æ•°
        include_used = request.query_params.get("include_used", "true").lower() == "true"
        include_expired = request.query_params.get("include_expired", "false").lower() == "true"
        page = int(request.query_params.get("page", "1"))
        limit = 20  # æ¯é¡µæ˜¾ç¤º20æ¡
        offset = (page - 1) * limit
        
        # è·å–ç»‘å®šç æ•°æ®
        binding_data = await binding_codes_manager.get_all_binding_codes(
            include_used=include_used,
            include_expired=include_expired,
            limit=limit if page == 1 else None  # é¦–é¡µé™åˆ¶ï¼Œåç»­åŠ è½½æ›´å¤š
        )
        
        codes = binding_data.get("codes", [])
        total = binding_data.get("total", 0)
        
        # è·å–ç»Ÿè®¡ä¿¡æ¯
        stats = await binding_codes_manager.get_binding_code_statistics()
        
        # åˆ†é¡µå¤„ç†
        displayed_codes = codes[offset:offset+limit] if page > 1 else codes[:limit]
        has_more = len(codes) > offset + limit or binding_data.get("has_more", False)
        
        # æ„å»ºè¡¨æ ¼è¡Œ
        table_rows = []
        for code in displayed_codes:
            status_badge = Span(
                "å·²ä½¿ç”¨" if code.get('is_used') else "æœªä½¿ç”¨",
                cls="badge badge-success" if code.get('is_used') else "badge badge-warning"
            )
            
            merchant_info = "æœªç»‘å®š"
            if code.get('merchant_name'):
                merchant_info = f"{code.get('merchant_name')} (ID: {code.get('merchant_id')})"
            
            expires_info = "æ°¸ä¹…æœ‰æ•ˆ"
            if code.get('expires_at'):
                expires_info = code.get('expires_at')
            
            actions = Div(
                A("è¯¦æƒ…", href=f"/binding-codes/{code['id']}/detail", 
                  cls="btn btn-xs btn-info mr-1"),
                Button("åˆ é™¤", onclick=f"confirmDeleteCode({code['id']})", 
                       cls="btn btn-xs btn-error mr-1"),
                cls="flex gap-1"
            )
            
            table_rows.append(
                Tr(
                    Td(code['code'], cls="font-mono"),
                    Td(status_badge),
                    Td(merchant_info),
                    Td(code.get('created_at', '')),
                    Td(expires_info),
                    Td(code.get('used_at', '') or '-'),
                    Td(actions)
                )
            )
        
        # è¿‡æ»¤å™¨è¡¨å•
        filter_form = Form(
            Div(
                Div(
                    Label("æ˜¾ç¤ºé€‰é¡¹:", cls="label label-text font-semibold"),
                    Div(
                        Label(
                            Input(type="checkbox", name="include_used", value="true",
                                  checked=include_used, cls="checkbox"),
                            Span("åŒ…å«å·²ä½¿ç”¨", cls="label-text ml-2"),
                            cls="cursor-pointer flex items-center"
                        ),
                        Label(
                            Input(type="checkbox", name="include_expired", value="true",
                                  checked=include_expired, cls="checkbox"),
                            Span("åŒ…å«å·²è¿‡æœŸ", cls="label-text ml-2"),
                            cls="cursor-pointer flex items-center"
                        ),
                        cls="flex gap-4"
                    ),
                    cls="form-control"
                ),
                Button("ç­›é€‰", type="submit", cls="btn btn-primary"),
                cls="flex items-end gap-4"
            ),
            method="GET",
            cls="bg-base-200 p-4 rounded mb-6"
        )
        
        # ç»Ÿè®¡å¡ç‰‡
        stats_cards = Div(
            Div(
                Div(
                    Div(
                        H3(str(stats.get('total_codes', 0)), cls="text-2xl font-bold"),
                        P("æ€»ç»‘å®šç ", cls="text-sm opacity-60"),
                        cls="stat"
                    ),
                    Div(
                        H3(str(stats.get('valid_codes', 0)), cls="text-2xl font-bold text-success"),
                        P("æœªä½¿ç”¨", cls="text-sm opacity-60"),
                        cls="stat"
                    ),
                    Div(
                        H3(str(stats.get('used_codes', 0)), cls="text-2xl font-bold text-warning"),
                        P("å·²ä½¿ç”¨", cls="text-sm opacity-60"),
                        cls="stat"
                    ),
                    Div(
                        H3(f"{stats.get('usage_rate', 0):.1f}%", cls="text-2xl font-bold text-info"),
                        P("ä½¿ç”¨ç‡", cls="text-sm opacity-60"),
                        cls="stat"
                    ),
                    cls="stats shadow w-full"
                ),
                cls="mb-6"
            ),
        )
        
        # ä¸»è¡¨æ ¼
        table = Div(
            Table(
                Thead(
                    Tr(
                        Th("ç»‘å®šç ", cls="w-32"),
                        Th("çŠ¶æ€"),
                        Th("ç»‘å®šå•†æˆ·"),
                        Th("åˆ›å»ºæ—¶é—´"),
                        Th("è¿‡æœŸæ—¶é—´"),
                        Th("ä½¿ç”¨æ—¶é—´"),
                        Th("æ“ä½œ", cls="w-32")
                    )
                ),
                Tbody(*table_rows),
                cls="table table-zebra w-full"
            ),
            cls="overflow-x-auto bg-base-100 rounded-lg shadow"
        )
        
        # åˆ†é¡µ
        pagination = ""
        if total > limit:
            pagination = Div(
                Div(
                    Button("ä¸Šä¸€é¡µ", 
                           onclick=f"loadPage({page-1})" if page > 1 else None,
                           disabled=page <= 1, cls="btn btn-sm"),
                    Span(f"ç¬¬ {page} é¡µ", cls="mx-4"),
                    Button("ä¸‹ä¸€é¡µ", 
                           onclick=f"loadPage({page+1})" if has_more else None,
                           disabled=not has_more, cls="btn btn-sm"),
                    cls="join"
                ),
                cls="flex justify-center mt-6"
            )
        
        # é¡µé¢å†…å®¹
        content = Div(
            # é¡µé¢æ ‡é¢˜
            Div(
                H1("ç»‘å®šç ç®¡ç†", cls="page-title"),
                Div(
                    A("ç”Ÿæˆæ–°ç»‘å®šç ", href="/binding-codes/generate", 
                      cls="btn btn-primary"),
                    A("å¯¼å‡ºæ•°æ®", href="/binding-codes/export", 
                      cls="btn btn-secondary ml-2"),
                    cls="flex gap-2"
                ),
                cls="flex justify-between items-center mb-6"
            ),
            
            # ç»Ÿè®¡ä¿¡æ¯
            stats_cards,
            
            # è¿‡æ»¤å™¨
            filter_form,
            
            # æ•°æ®è¡¨æ ¼
            table,
            
            # åˆ†é¡µ
            pagination,
            
            # JavaScript
            Script("""
                function confirmDeleteCode(codeId) {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç»‘å®šç å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                        fetch(`/binding-codes/${codeId}/delete`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        }).then(response => {
                            if (response.ok) {
                                location.reload();
                            } else {
                                alert('åˆ é™¤å¤±è´¥');
                            }
                        });
                    }
                }
                
                function loadPage(page) {
                    const params = new URLSearchParams(window.location.search);
                    params.set('page', page);
                    window.location.search = params.toString();
                }
            """)
        )
        
        return create_layout("ç»‘å®šç ç®¡ç†", content)
        
    except Exception as e:
        logger.error(f"ç»‘å®šç åˆ—è¡¨é¡µé¢é”™è¯¯: {e}")
        error_content = Div(
            H1("é¡µé¢é”™è¯¯", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"åŠ è½½ç»‘å®šç åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"),
            A("è¿”å›é¦–é¡µ", href="/", cls="btn btn-primary mt-4")
        )
        return create_layout("é¡µé¢é”™è¯¯", error_content)


@app.get("/binding-codes/generate")
@require_auth
async def binding_codes_generate_page(request: Request):
    """ç”Ÿæˆç»‘å®šç é¡µé¢"""
    try:
        # ç”Ÿæˆè¡¨å•
        form = Form(
            Div(
                H2("ç”Ÿæˆæ–°ç»‘å®šç ", cls="text-2xl font-bold mb-6"),
                
                # æ•°é‡é€‰æ‹©
                Div(
                    Label("ç”Ÿæˆæ•°é‡:", cls="label label-text font-semibold"),
                    Input(type="number", name="count", value="1", min="1", max="100",
                          cls="input input-bordered", required=True),
                    Div("ä¸€æ¬¡æœ€å¤šç”Ÿæˆ100ä¸ªç»‘å®šç ", cls="text-sm text-gray-500 mt-1"),
                    cls="form-control mb-4"
                ),
                
                # è¿‡æœŸè®¾ç½®
                Div(
                    Label("è¿‡æœŸæ—¶é—´:", cls="label label-text font-semibold"),
                    Select(
                        Option("æ°¸ä¸è¿‡æœŸ", value=""),
                        Option("1å°æ—¶å", value="1"),
                        Option("24å°æ—¶å", value="24"),
                        Option("7å¤©å", value="168"),
                        Option("30å¤©å", value="720"),
                        name="expiry_hours",
                        cls="select select-bordered"
                    ),
                    cls="form-control mb-6"
                ),
                
                # æ“ä½œæŒ‰é’®
                Div(
                    Button("ç”Ÿæˆç»‘å®šç ", type="submit", cls="btn btn-primary"),
                    A("å–æ¶ˆ", href="/binding-codes", cls="btn btn-ghost ml-2"),
                    cls="flex gap-2"
                ),
                
                cls="bg-base-100 p-6 rounded-lg shadow max-w-md mx-auto"
            ),
            method="POST",
            action="/binding-codes/generate"
        )
        
        content = Div(
            Div(
                A("â† è¿”å›ç»‘å®šç ç®¡ç†", href="/binding-codes", 
                  cls="btn btn-ghost mb-4"),
                cls="mb-6"
            ),
            form
        )
        
        return create_layout("ç”Ÿæˆç»‘å®šç ", content)
        
    except Exception as e:
        logger.error(f"ç»‘å®šç ç”Ÿæˆé¡µé¢é”™è¯¯: {e}")
        error_content = Div(
            H1("é¡µé¢é”™è¯¯", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"åŠ è½½ç”Ÿæˆé¡µé¢æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"),
            A("è¿”å›ç»‘å®šç ç®¡ç†", href="/binding-codes", cls="btn btn-primary mt-4")
        )
        return create_layout("é¡µé¢é”™è¯¯", error_content)


@app.post("/binding-codes/generate")
@require_auth
async def binding_codes_generate_action(request: Request):
    """å¤„ç†ç”Ÿæˆç»‘å®šç è¯·æ±‚"""
    try:
        # è·å–è¡¨å•æ•°æ®
        form_data = await request.form()
        # ç”Ÿæˆæ•°é‡
        raw_count = form_data.get("count", "1")
        try:
            count = int(str(raw_count).strip())
        except Exception:
            raise ValueError("ç”Ÿæˆæ•°é‡å¿…é¡»æ˜¯æ•°å­—")
        # è¿‡æœŸæ—¶é—´ï¼šå…è®¸ 'æ°¸ä¸è¿‡æœŸ' æˆ–ç©ºï¼ŒåŠæ•°å­—å°æ—¶
        raw_expiry = form_data.get("expiry_hours")
        expiry_hours = None
        if raw_expiry is not None:
            s = str(raw_expiry).strip()
            if s and s not in ("æ°¸ä¸è¿‡æœŸ", "none", "null", "-1"):
                if s.isdigit():
                    expiry_hours = int(s)
                else:
                    # å®¹é”™ï¼šå°è¯•å»é™¤éæ•°å­—å­—ç¬¦
                    import re
                    digits = "".join(re.findall(r"\d+", s))
                    expiry_hours = int(digits) if digits else None
        
        # éªŒè¯æ•°é‡
        if count < 1 or count > 100:
            raise ValueError("ç”Ÿæˆæ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´")
        
        # æ­¤æ—¶ expiry_hours å·²æ˜¯ None æˆ– int
        
        # ç”Ÿæˆç»‘å®šç 
        generated_codes = []
        for i in range(count):
            code_info = await binding_codes_manager.generate_binding_code(
                expiry_hours=expiry_hours
            )
            generated_codes.append(code_info)
        
        # æ˜¾ç¤ºç»“æœé¡µé¢
        codes_list = Div(
            *[
                Div(
                    Div(code['code'], cls="font-mono text-lg font-bold"),
                    Div(f"è¿‡æœŸæ—¶é—´: {code.get('expires_at', 'æ°¸ä¸è¿‡æœŸ')}", 
                        cls="text-sm text-gray-500"),
                    cls="bg-base-200 p-3 rounded mb-2"
                )
                for code in generated_codes
            ]
        )
        
        content = Div(
            Div(
                H1("ç»‘å®šç ç”ŸæˆæˆåŠŸ", cls="text-2xl font-bold text-success mb-4"),
                P(f"å·²æˆåŠŸç”Ÿæˆ {count} ä¸ªç»‘å®šç :", cls="mb-4"),
                
                codes_list,
                
                Div(
                    A("è¿”å›ç»‘å®šç ç®¡ç†", href="/binding-codes", cls="btn btn-primary"),
                    A("ç»§ç»­ç”Ÿæˆ", href="/binding-codes/generate", cls="btn btn-ghost ml-2"),
                    cls="mt-6 flex gap-2"
                ),
                
                cls="max-w-2xl mx-auto"
            )
        )
        
        return create_layout("ç”ŸæˆæˆåŠŸ", content)
        
    except Exception as e:
        logger.error(f"ç”Ÿæˆç»‘å®šç å¤±è´¥: {e}")
        error_content = Div(
            H1("ç”Ÿæˆå¤±è´¥", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"ç”Ÿæˆç»‘å®šç æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"),
            A("é‡è¯•", href="/binding-codes/generate", cls="btn btn-primary mt-4"),
            A("è¿”å›ç®¡ç†", href="/binding-codes", cls="btn btn-ghost mt-4 ml-2")
        )
        return create_layout("ç”Ÿæˆå¤±è´¥", error_content)


@app.get("/binding-codes/{code_id}/detail")
@require_auth
async def binding_code_detail(request: Request):
    """ç»‘å®šç è¯¦æƒ…é¡µé¢"""
    try:
        # è·å–è·¯å¾„å‚æ•°
        code_id = request.path_params.get("code_id")
        if not code_id:
            raise ValueError("ç¼ºå°‘ç»‘å®šç ID")
        
        # è·å–ç»‘å®šç ä¿¡æ¯
        code_info = await binding_codes_manager.get_binding_code_info(int(code_id))
        if not code_info:
            raise ValueError("ç»‘å®šç ä¸å­˜åœ¨")
        
        # çŠ¶æ€å¾½ç« 
        status_badge = Span(
            "å·²ä½¿ç”¨" if code_info.get('is_used') else "æœªä½¿ç”¨",
            cls="badge badge-lg " + ("badge-success" if code_info.get('is_used') else "badge-warning")
        )
        
        # å•†æˆ·ä¿¡æ¯
        merchant_section = ""
        if code_info.get('merchant_name'):
            merchant_section = Div(
                H3("ç»‘å®šå•†æˆ·ä¿¡æ¯", cls="text-lg font-bold mb-2"),
                Div(
                    P(f"å•†æˆ·åç§°: {code_info.get('merchant_name')}"),
                    P(f"å•†æˆ·ID: {code_info.get('merchant_id')}"),
                    P(f"Telegram ID: {code_info.get('merchant_chat_id', 'æœªçŸ¥')}"),
                    P(f"ç»‘å®šæ—¶é—´: {code_info.get('used_at', 'æœªçŸ¥')}"),
                    cls="bg-base-200 p-4 rounded"
                ),
                cls="mb-6"
            )
        
        # è¯¦æƒ…å†…å®¹
        content = Div(
            # é¡µé¢æ ‡é¢˜
            Div(
                A("â† è¿”å›ç»‘å®šç ç®¡ç†", href="/binding-codes", 
                  cls="btn btn-ghost mb-4"),
                H1("ç»‘å®šç è¯¦æƒ…", cls="page-title"),
                cls="mb-6"
            ),
            
            # åŸºæœ¬ä¿¡æ¯å¡ç‰‡
            Div(
                H2("åŸºæœ¬ä¿¡æ¯", cls="text-xl font-bold mb-4"),
                Div(
                    Div(
                        Div("ç»‘å®šç ", cls="font-semibold"),
                        Div(code_info['code'], cls="font-mono text-lg"),
                        cls="flex justify-between items-center py-2"
                    ),
                    Div(
                        Div("çŠ¶æ€", cls="font-semibold"),
                        status_badge,
                        cls="flex justify-between items-center py-2"
                    ),
                    Div(
                        Div("åˆ›å»ºæ—¶é—´", cls="font-semibold"),
                        Div(code_info.get('created_at', 'æœªçŸ¥')),
                        cls="flex justify-between items-center py-2"
                    ),
                    Div(
                        Div("è¿‡æœŸæ—¶é—´", cls="font-semibold"),
                        Div(code_info.get('expires_at', 'æ°¸ä¹…æœ‰æ•ˆ')),
                        cls="flex justify-between items-center py-2"
                    ),
                    cls="divide-y divide-base-300"
                ),
                cls="bg-base-100 p-6 rounded-lg shadow mb-6"
            ),
            
            # å•†æˆ·ä¿¡æ¯ï¼ˆå¦‚æœå·²ç»‘å®šï¼‰
            merchant_section,
            
            # æ“ä½œæŒ‰é’®
            Div(
                Button("åˆ é™¤ç»‘å®šç ", 
                       onclick=f"confirmDeleteCode({code_id})",
                       cls="btn btn-error"),
                A("ç¼–è¾‘", href=f"/binding-codes/{code_id}/edit", 
                  cls="btn btn-primary ml-2"),
                cls="flex gap-2"
            ),
            
            # JavaScript
            Script(f"""
                function confirmDeleteCode(codeId) {{
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç»‘å®šç å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {{
                        fetch(`/binding-codes/${{codeId}}/delete`, {{
                            method: 'POST',
                            headers: {{
                                'Content-Type': 'application/json',
                            }}
                        }}).then(response => {{
                            if (response.ok) {{
                                window.location.href = '/binding-codes';
                            }} else {{
                                alert('åˆ é™¤å¤±è´¥');
                            }}
                        }});
                    }}
                }}
            """)
        )
        
        return create_layout("ç»‘å®šç è¯¦æƒ…", content)
        
    except Exception as e:
        logger.error(f"ç»‘å®šç è¯¦æƒ…é¡µé¢é”™è¯¯: {e}")
        error_content = Div(
            H1("é¡µé¢é”™è¯¯", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"åŠ è½½ç»‘å®šç è¯¦æƒ…æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"),
            A("è¿”å›ç»‘å®šç ç®¡ç†", href="/binding-codes", cls="btn btn-primary mt-4")
        )
        return create_layout("é¡µé¢é”™è¯¯", error_content)


@app.post("/binding-codes/{code_id}/delete")
@require_auth
async def binding_code_delete(request: Request):
    """åˆ é™¤ç»‘å®šç """
    try:
        # è·å–è·¯å¾„å‚æ•°
        code_id = request.path_params.get("code_id")
        if not code_id:
            raise ValueError("ç¼ºå°‘ç»‘å®šç ID")
        
        # åˆ é™¤ç»‘å®šç 
        success = await binding_codes_manager.delete_binding_code(int(code_id))
        
        if success:
            logger.info(f"ç»‘å®šç åˆ é™¤æˆåŠŸ: {code_id}")
            return {"success": True, "message": "ç»‘å®šç åˆ é™¤æˆåŠŸ"}
        else:
            logger.warning(f"ç»‘å®šç åˆ é™¤å¤±è´¥: {code_id}")
            return {"success": False, "message": "ç»‘å®šç åˆ é™¤å¤±è´¥"}
        
    except Exception as e:
        logger.error(f"åˆ é™¤ç»‘å®šç é”™è¯¯: {e}")
        return {"success": False, "message": f"åˆ é™¤å¤±è´¥: {str(e)}"}


@app.get("/binding-codes/export")
@require_auth
async def binding_codes_export(request: Request):
    """å¯¼å‡ºç»‘å®šç æ•°æ®"""
    try:
        # è·å–æ‰€æœ‰ç»‘å®šç æ•°æ®
        binding_data = await binding_codes_manager.get_all_binding_codes(
            include_used=True,
            include_expired=True
        )
        codes = binding_data.get("codes", [])
        
        # åˆ›å»ºCSVå†…å®¹
        import io, csv
        output = io.StringIO()
        writer = csv.writer(output)
        
        # å†™å…¥æ ‡é¢˜è¡Œ
        headers = [
            'ID', 'ç»‘å®šç ', 'çŠ¶æ€', 'å•†æˆ·ID', 'å•†æˆ·åç§°', 
            'åˆ›å»ºæ—¶é—´', 'è¿‡æœŸæ—¶é—´', 'ä½¿ç”¨æ—¶é—´', 'ç»‘å®šç”¨æˆ·å', 'ç»‘å®šç”¨æˆ·å§“å'
        ]
        writer.writerow(headers)
        
        # å†™å…¥æ•°æ®è¡Œ
        for code in codes:
            writer.writerow([
                code['id'],
                code['code'],
                'å·²ä½¿ç”¨' if code.get('is_used') else 'æœªä½¿ç”¨',
                code.get('merchant_id', ''),
                code.get('merchant_name', ''),
                code.get('created_at', ''),
                code.get('expires_at', ''),
                code.get('used_at', ''),
                code.get('bound_telegram_username', ''),
                code.get('bound_telegram_name', '')
            ])
        
        # å‡†å¤‡å“åº”
        output.seek(0)
        filename = f"binding_codes_export_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        
        from starlette.responses import StreamingResponse
        
        def generate():
            yield output.getvalue().encode('utf-8-sig')  # BOM for Excel
        
        return StreamingResponse(
            generate(),
            media_type="text/csv",
            headers={"Content-Disposition": f"attachment; filename={filename}"}
        )
        
    except Exception as e:
        logger.error(f"å¯¼å‡ºç»‘å®šç æ•°æ®å¤±è´¥: {e}")
        error_content = Div(
            H1("å¯¼å‡ºå¤±è´¥", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"å¯¼å‡ºç»‘å®šç æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"),
            A("è¿”å›ç»‘å®šç ç®¡ç†", href="/binding-codes", cls="btn btn-primary mt-4")
        )
        return create_layout("å¯¼å‡ºå¤±è´¥", error_content)


# ==== å¸–å­ç®¡ç†æ¨¡å— FastHTML è·¯ç”± ====

@app.get("/posts")
async def posts_list(request):
    """å¸–å­åˆ—è¡¨é¡µé¢"""
    try:
        # è§£ææŸ¥è¯¢å‚æ•°
        params = dict(request.query_params)
        page = int(params.get('page', 1))
        per_page = int(params.get('per_page', 20))
        
        # ç­›é€‰å‚æ•°
        status_filter = params.get('status', '')
        district_filter = params.get('district', '')
        search_query = params.get('search', '')
        sort_by = params.get('sort', 'created_at')
        
        # è·å–å¸–å­æ•°æ®
        posts_data = await merchant_manager.get_merchants_list(
            page=page,
            per_page=per_page,
            status=status_filter,
            district_id=int(district_filter) if district_filter else None,
            search=search_query,
            sort_by=sort_by
        )
        
        # è·å–åœ°åŒºåˆ—è¡¨
        districts = await region_manager.get_all_districts()
        
        # æ„å»ºç­›é€‰è¡¨å•
        filter_form = Form(
            Div(
                # çŠ¶æ€ç­›é€‰
                Div(
                    Label("çŠ¶æ€ç­›é€‰:", cls="label"),
                    Select(
                        Option("å…¨éƒ¨çŠ¶æ€", value="", selected=not status_filter),
                        *[Option(POST_STATUS_DISPLAY_MAP[status], value=status, 
                               selected=status_filter==status) 
                          for status in POST_STATUS_DISPLAY_MAP.keys()],
                        name="status", cls="select select-bordered"
                    ),
                    cls="form-control w-full max-w-xs"
                ),
                
                # åŒºå¿ç­›é€‰
                Div(
                    Label("åŒºå¿ç­›é€‰:", cls="label"),
                    Select(
                        Option("å…¨éƒ¨åœ°åŒº", value="", selected=not district_filter),
                        *[Option(f"{district['city_name']} - {district['name']}", 
                               value=str(district['id']),
                               selected=district_filter==str(district['id'])) 
                          for district in districts],
                        name="district", cls="select select-bordered"
                    ),
                    cls="form-control w-full max-w-xs"
                ),
                
                # æœç´¢æ¡†
                Div(
                    Label("æœç´¢:", cls="label"),
                    Input(type="text", name="search", value=search_query,
                          placeholder="æœç´¢å•†æˆ·åç§°æˆ–ç”¨æˆ·å", cls="input input-bordered"),
                    cls="form-control w-full max-w-xs"
                ),
                
                # æ’åºé€‰æ‹©
                Div(
                    Label("æ’åº:", cls="label"),
                    Select(
                        Option("åˆ›å»ºæ—¶é—´", value="created_at", selected=sort_by=="created_at"),
                        Option("æ›´æ–°æ—¶é—´", value="updated_at", selected=sort_by=="updated_at"),
                        Option("å‘å¸ƒæ—¶é—´", value="publish_time", selected=sort_by=="publish_time"),
                        name="sort", cls="select select-bordered"
                    ),
                    cls="form-control w-full max-w-xs"
                ),
                
                cls="flex flex-wrap gap-4 mb-4"
            ),
            
            Div(
                Button("æœç´¢", type="submit", cls="btn btn-primary"),
                A("é‡ç½®", href="/posts", cls="btn btn-ghost ml-2"),
                cls="flex gap-2"
            ),
            
            method="get"
        )
        
        # æ„å»ºå¸–å­è¡¨æ ¼
        posts_table = Table(
            Thead(
                Tr(
                    Th("ID"),
                    Th("å•†æˆ·åç§°"),
                    Th("çŠ¶æ€"),
                    Th("åœ°åŒº"),
                    Th("å‘å¸ƒæ—¶é—´"),
                    Th("åˆ°æœŸæ—¶é—´"),
                    Th("åˆ›å»ºæ—¶é—´"),
                    Th("æ“ä½œ")
                )
            ),
            Tbody(
                *[
                    Tr(
                        Td(str(post['id'])),
                        Td(post.get('name', 'æœªè®¾ç½®')),
                        Td(
                            Span(
                                POST_STATUS_DISPLAY_MAP.get(post['status'], post['status']),
                                cls=f"badge {get_posts_status_color(post['status'])}"
                            )
                        ),
                        Td(f"{post.get('city_name', '')} - {post.get('district_name', '')}"),
                        Td(post.get('publish_time', 'æœªè®¾ç½®')),
                        Td(post.get('expiration_time', 'æœªè®¾ç½®')),
                        Td(post.get('created_at', '')),
                        Td(
                            Div(
                                A("è¯¦æƒ…", href=f"/posts/{post['id']}", 
                                  cls="btn btn-sm btn-info mr-1"),
                                *generate_posts_quick_action_buttons(
                                    str(post['id']), post['status']
                                ),
                                cls="flex gap-1 flex-wrap"
                            )
                        )
                    )
                    for post in posts_data['posts']
                ]
            ),
            cls="table table-zebra w-full"
        )
        
        # åˆ†é¡µç»„ä»¶
        total_pages = (posts_data['total'] + per_page - 1) // per_page
        pagination = Div(
            Div(f"å…± {posts_data['total']} æ¡è®°å½•", cls="text-sm text-gray-500"),
            Div(
                *[
                    A(
                        str(p),
                        href=f"/posts?page={p}&per_page={per_page}&status={status_filter}&district={district_filter}&search={search_query}&sort={sort_by}",
                        cls=f"btn btn-sm {'btn-active' if p == page else 'btn-ghost'}"
                    )
                    for p in range(max(1, page-2), min(total_pages+1, page+3))
                ],
                cls="btn-group"
            ),
            cls="flex justify-between items-center mt-4"
        )
        
        content = Div(
            H1("å¸–å­ç®¡ç†", cls="page-title"),
            
            # ç­›é€‰è¡¨å•
            Div(filter_form, cls="bg-base-100 p-4 rounded-lg shadow mb-6"),
            
            # å¸–å­è¡¨æ ¼
            Div(posts_table, cls="overflow-x-auto"),
            
            # åˆ†é¡µ
            pagination if total_pages > 1 else "",
            
            cls="w-full"
        )
        
        return create_layout("å¸–å­ç®¡ç†", content)
        
    except Exception as e:
        logger.error(f"è·å–å¸–å­åˆ—è¡¨å¤±è´¥: {e}")
        error_content = Div(
            H1("è·å–å¤±è´¥", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"è·å–å¸–å­åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"),
            A("è¿”å›é¦–é¡µ", href="/", cls="btn btn-primary mt-4")
        )
        return create_layout("è·å–å¤±è´¥", error_content)


@app.get("/posts/{post_id}")
async def post_detail(post_id: int):
    """å¸–å­è¯¦æƒ…å’Œç¼–è¾‘é¡µé¢"""
    try:
        # è·å–å¸–å­è¯¦æƒ…ï¼ˆä½¿ç”¨V2æ ‡å‡†æ–¹æ³•ï¼‰
        post_data = await merchant_manager.get_merchant(post_id)
        if not post_data:
            raise ValueError("å¸–å­ä¸å­˜åœ¨")
        
        # è·å–åª’ä½“æ–‡ä»¶
        media_files = await media_db.get_media_by_merchant_id(post_id)
        
        # è·å–åœ°åŒºåˆ—è¡¨
        districts = await region_manager.get_all_districts()
        
        # çŠ¶æ€è½¬æ¢é€‰é¡¹
        status_options = get_posts_next_status_options(post_data['status'])
        
        # æ„å»ºç¼–è¾‘è¡¨å•
        edit_form = Form(
            Div(
                # åŸºæœ¬ä¿¡æ¯
                Div(
                    H3("åŸºæœ¬ä¿¡æ¯", cls="text-lg font-bold mb-4"),
                    
                    Div(
                        Label("å•†æˆ·åç§°:", cls="label"),
                        Input(
                            name="name",
                            value=post_data.get('name', ''),
                            cls="input input-bordered w-full"
                        ),
                        cls="form-control w-full mb-4"
                    ),
                    
                    Div(
                        Label("åœ°åŒº:", cls="label"),
                        Select(
                            *[Option(f"{district['city_name']} - {district['name']}", 
                                   value=str(district['id']),
                                   selected=post_data.get('district_id')==district['id']) 
                              for district in districts],
                            name="district_id", cls="select select-bordered w-full"
                        ),
                        cls="form-control w-full mb-4"
                    ),
                    
                    cls="bg-base-200 p-4 rounded mb-6"
                ),
                
                # ä»·æ ¼ä¿¡æ¯ï¼ˆå­—æ®µä¸æ•°æ®åº“ä¸€è‡´ï¼‰
                Div(
                    H3("ä»·æ ¼ä¿¡æ¯", cls="text-lg font-bold mb-4"),
                    
                    Div(
                        Div(
                            Label("ä»·æ ¼1:", cls="label"),
                            Input(
                                type="number",
                                name="p_price",
                                value=str(post_data.get('p_price', '') or ''),
                                cls="input input-bordered w-full"
                            ),
                            cls="form-control w-full"
                        ),
                        Div(
                            Label("ä»·æ ¼2:", cls="label"),
                            Input(
                                type="number", 
                                name="pp_price",
                                value=str(post_data.get('pp_price', '') or ''),
                                cls="input input-bordered w-full"
                            ),
                            cls="form-control w-full"
                        ),
                        cls="grid grid-cols-2 gap-4 mb-4"
                    ),
                    
                    cls="bg-base-200 p-4 rounded mb-6"
                ),
                
                # æè¿°ä¿¡æ¯ï¼ˆå•å­—æ®µï¼‰
                Div(
                    H3("æè¿°ä¿¡æ¯", cls="text-lg font-bold mb-4"),
                    Div(
                        Label("è‡ªå®šä¹‰æè¿°:", cls="label"),
                        Textarea(
                            post_data.get('custom_description', ''),
                            name="custom_description",
                            cls="textarea textarea-bordered w-full h-32"
                        ),
                        cls="form-control w-full mb-4"
                    ),
                    cls="bg-base-200 p-4 rounded mb-6"
                ),
                
                # å‘å¸ƒæ—¶é—´è®¾ç½®
                Div(
                    H3("å‘å¸ƒè®¾ç½®", cls="text-lg font-bold mb-4"),
                    
                    Div(
                        Label("çŠ¶æ€:", cls="label"),
                        Select(
                            *[Option(display_text, value=status_value,
                                   selected=post_data['status']==status_value)
                              for status_value, display_text in status_options],
                            name="status", cls="select select-bordered w-full"
                        ),
                        cls="form-control w-full mb-4"
                    ),
                    
                    Div(
                        Label("å‘å¸ƒæ—¶é—´:", cls="label"),
                        Input(
                            type="datetime-local",
                            name="publish_time",
                            value=post_data.get('publish_time', '').replace(' ', 'T')[:16] if post_data.get('publish_time') else '',
                            cls="input input-bordered w-full"
                        ),
                        cls="form-control w-full mb-4"
                    ),
                    
                    Div(
                        Label("åˆ°æœŸæ—¶é—´:", cls="label"),
                        Input(
                            type="datetime-local",
                            name="expiration_time", 
                            value=post_data.get('expiration_time', '').replace(' ', 'T')[:16] if post_data.get('expiration_time') else '',
                            cls="input input-bordered w-full"
                        ),
                        cls="form-control w-full mb-4"
                    ),
                    
                    cls="bg-base-200 p-4 rounded mb-6"
                ),
                
                cls="max-w-4xl mx-auto"
            ),
            
            # æäº¤æŒ‰é’®
            Div(
                Button("ä¿å­˜ä¿®æ”¹", type="submit", cls="btn btn-primary"),
                A("å–æ¶ˆ", href="/posts", cls="btn btn-ghost ml-2"),
                cls="flex gap-2 justify-center mt-6"
            ),
            
            method="post",
            action=f"/posts/{post_id}/update"
        )
        
        # åª’ä½“æ–‡ä»¶å±•ç¤º
        media_section = ""
        if media_files:
            media_section = Div(
                H3("åª’ä½“æ–‡ä»¶", cls="text-lg font-bold mb-4"),
                Div(
                    *[
                        Div(
                            Img(src=f"/media-proxy/{media['id']}", 
                                cls="w-32 h-32 object-cover rounded"),
                            P(f"ç±»å‹: {media['media_type']}", cls="text-sm text-gray-500 mt-1"),
                            cls="flex flex-col items-center"
                        )
                        for media in media_files
                    ],
                    cls="flex flex-wrap gap-4"
                ),
                cls="bg-base-200 p-4 rounded mb-6"
            )
        
        # å¿«é€Ÿæ“ä½œæŒ‰é’®
        quick_actions = Div(
            H3("å¿«é€Ÿæ“ä½œ", cls="text-lg font-bold mb-4"),
            Div(
                *generate_posts_quick_action_buttons(str(post_id), post_data['status']),
                cls="flex gap-2 flex-wrap"
            ),
            cls="bg-base-200 p-4 rounded mb-6"
        )
        
        content = Div(
            H1(f"å¸–å­è¯¦æƒ… #{post_id}", cls="page-title"),
            
            # å½“å‰çŠ¶æ€
            Div(
                Span("å½“å‰çŠ¶æ€: ", cls="text-lg"),
                Span(
                    POST_STATUS_DISPLAY_MAP.get(post_data['status'], post_data['status']),
                    cls=f"badge badge-lg {get_posts_status_color(post_data['status'])}"
                ),
                cls="mb-6"
            ),
            
            # åª’ä½“æ–‡ä»¶
            media_section,
            
            # å¿«é€Ÿæ“ä½œ
            quick_actions,
            
            # ç¼–è¾‘è¡¨å•
            edit_form,
            
            cls="w-full"
        )
        
        return create_layout("å¸–å­è¯¦æƒ…", content)
        
    except Exception as e:
        logger.error(f"è·å–å¸–å­è¯¦æƒ…å¤±è´¥: {e}")
        error_content = Div(
            H1("è·å–å¤±è´¥", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"è·å–å¸–å­è¯¦æƒ…æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"),
            A("è¿”å›å¸–å­åˆ—è¡¨", href="/posts", cls="btn btn-primary mt-4")
        )
        return create_layout("è·å–å¤±è´¥", error_content)


@app.post("/posts/{post_id}/update")
async def post_update(post_id: int, request):
    """æ›´æ–°å¸–å­ä¿¡æ¯"""
    try:
        # è·å–è¡¨å•æ•°æ®
        form_data = await request.form()
        
        # å¤„ç†æ—¶é—´æ ¼å¼
        publish_time = form_data.get('publish_time')
        if publish_time:
            publish_time = publish_time.replace('T', ' ')
        
        expiration_time = form_data.get('expiration_time') 
        if expiration_time:
            expiration_time = expiration_time.replace('T', ' ')
        
        # æ›´æ–°æ•°æ®ï¼ˆå”¯ä¸€å­—æ®µï¼Œç›´å†™æ•°æ®åº“åˆ—ï¼‰
        update_data = {
            'name': form_data.get('name'),
            'district_id': int(form_data.get('district_id')) if form_data.get('district_id') else None,
            'p_price': int(form_data.get('p_price')) if form_data.get('p_price') else None,
            'pp_price': int(form_data.get('pp_price')) if form_data.get('pp_price') else None,
            'custom_description': form_data.get('custom_description') or None,
            'status': form_data.get('status'),
            'publish_time': publish_time,
            'expiration_time': expiration_time
        }

        await merchant_manager.update_merchant(post_id, update_data)
        
        # é‡å®šå‘åˆ°è¯¦æƒ…é¡µ
        from starlette.responses import RedirectResponse
        return RedirectResponse(url=f"/posts/{post_id}", status_code=302)
        
    except Exception as e:
        logger.error(f"æ›´æ–°å¸–å­å¤±è´¥: {e}")
        error_content = Div(
            H1("æ›´æ–°å¤±è´¥", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"æ›´æ–°å¸–å­ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"),
            A("è¿”å›è¯¦æƒ…é¡µ", href=f"/posts/{post_id}", cls="btn btn-primary mt-4")
        )
        return create_layout("æ›´æ–°å¤±è´¥", error_content)


@app.post("/posts/{post_id}/approve")
async def post_approve(post_id: int):
    """æ‰¹å‡†å¸–å­"""
    try:
        await merchant_manager.update_merchant_status(post_id, MERCHANT_STATUS.APPROVED.value)
        
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/posts", status_code=302)
        
    except Exception as e:
        logger.error(f"æ‰¹å‡†å¸–å­å¤±è´¥: {e}")
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/posts?error=æ‰¹å‡†å¤±è´¥", status_code=302)


@app.post("/posts/{post_id}/reject")
async def post_reject(post_id: int):
    """é©³å›å¸–å­"""
    try:
        await merchant_manager.update_merchant_status(post_id, MERCHANT_STATUS.PENDING_SUBMISSION.value)
        
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/posts", status_code=302)
        
    except Exception as e:
        logger.error(f"é©³å›å¸–å­å¤±è´¥: {e}")
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/posts?error=é©³å›å¤±è´¥", status_code=302)


@app.post("/posts/{post_id}/publish")
async def post_publish(post_id: int):
    """ç«‹å³å‘å¸ƒå¸–å­"""
    try:
        # è®¾ç½®å½“å‰æ—¶é—´ä¸ºå‘å¸ƒæ—¶é—´
        from datetime import datetime
        now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        
        await merchant_manager.update_merchant(post_id, {
            'status': MERCHANT_STATUS.PUBLISHED.value,
            'publish_time': now
        })
        
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/posts", status_code=302)
        
    except Exception as e:
        logger.error(f"å‘å¸ƒå¸–å­å¤±è´¥: {e}")
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/posts?error=å‘å¸ƒå¤±è´¥", status_code=302)


@app.post("/posts/{post_id}/expire")
async def post_expire(post_id: int):
    """è®¾ä¸ºè¿‡æœŸ"""
    try:
        await merchant_manager.update_merchant_status(post_id, MERCHANT_STATUS.EXPIRED.value)
        
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/posts", status_code=302)
        
    except Exception as e:
        logger.error(f"è®¾ç½®è¿‡æœŸå¤±è´¥: {e}")
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/posts?error=è®¾ç½®è¿‡æœŸå¤±è´¥", status_code=302)


@app.post("/posts/{post_id}/extend")
async def post_extend(post_id: int, request):
    """å»¶é•¿å¸–å­æ—¶é—´"""
    try:
        form_data = await request.form()
        days = int(form_data.get('days', 1))
        
        # è·å–å½“å‰å¸–å­ä¿¡æ¯
        post_data = await merchant_manager.get_merchant(post_id)
        if not post_data:
            raise ValueError("å¸–å­ä¸å­˜åœ¨")
        
        # è®¡ç®—æ–°çš„åˆ°æœŸæ—¶é—´
        from datetime import datetime, timedelta
        current_expiry = datetime.strptime(post_data.get('expiration_time', ''), '%Y-%m-%d %H:%M:%S') if post_data.get('expiration_time') else datetime.now()
        new_expiry = current_expiry + timedelta(days=days)
        
        await merchant_manager.update_merchant(post_id, {
            'expiration_time': new_expiry.strftime('%Y-%m-%d %H:%M:%S')
        })
        
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/posts", status_code=302)
        
    except Exception as e:
        logger.error(f"å»¶é•¿æ—¶é—´å¤±è´¥: {e}")
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/posts?error=å»¶é•¿æ—¶é—´å¤±è´¥", status_code=302)


@app.post("/posts/{post_id}/delete")
async def post_delete(post_id: int):
    """åˆ é™¤å¸–å­"""
    try:
        await merchant_manager.delete_merchant(post_id)
        
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/posts", status_code=302)
        
    except Exception as e:
        logger.error(f"åˆ é™¤å¸–å­å¤±è´¥: {e}")
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/posts?error=åˆ é™¤å¤±è´¥", status_code=302)


# ==== è®¢å•ç®¡ç†æ¨¡å— FastHTML è·¯ç”± ====

# å®ä¾‹åŒ–è®¢å•ç®¡ç†å™¨
order_manager = OrderManager()

@app.get("/orders")
async def orders_list(request):
    """è®¢å•åˆ—è¡¨é¡µé¢ - åŒ…å«å®Œæ•´çš„æ¨¡å—å…³è”åŠŸèƒ½"""
    try:
        # è§£ææŸ¥è¯¢å‚æ•°
        params = dict(request.query_params)
        page = int(params.get('page', 1))
        per_page = int(params.get('per_page', 20))
        
        # ç­›é€‰å‚æ•°
        status_filter = params.get('status', '')
        merchant_filter = params.get('merchant_id', '')
        customer_filter = params.get('customer_id', '')
        date_from = params.get('date_from', '')
        date_to = params.get('date_to', '')
        
        # è·å–è®¢å•æ•°æ®ï¼ˆå¯¹æ¥V2åç«¯æ–¹æ³•ï¼‰
        orders = await order_manager.get_orders(
            status=status_filter or None,
            merchant_id=int(merchant_filter) if merchant_filter else None,
            user_id=int(customer_filter) if customer_filter else None,
            date_from=date_from or None,
            date_to=date_to or None,
            limit=per_page,
            offset=(page - 1) * per_page
        )

        # è·å–æ€»æ•°ç”¨äºåˆ†é¡µ
        total_count = await order_manager.count_orders(
            status=status_filter or None,
            merchant_id=int(merchant_filter) if merchant_filter else None,
            user_id=int(customer_filter) if customer_filter else None,
            date_from=date_from or None,
            date_to=date_to or None
        )

        orders_data = {
            'orders': orders,
            'total': total_count,
            'page': page,
            'per_page': per_page
        }

        # è·å–ç»Ÿè®¡æ•°æ®ï¼ˆä½¿ç”¨æ ‡å‡†æ–¹æ³•åï¼‰
        stats = await order_manager.get_order_statistics()
        
        # è·å–å•†æˆ·åˆ—è¡¨ï¼ˆç”¨äºç­›é€‰ï¼‰
        merchants = await merchant_manager.get_all_merchants()
        
        # æ„å»ºç­›é€‰è¡¨å•
        filter_form = Form(
            Div(
                # çŠ¶æ€ç­›é€‰
                Div(
                    Label("çŠ¶æ€ç­›é€‰:", cls="label"),
                    Select(
                        Option("å…¨éƒ¨çŠ¶æ€", value="", selected=not status_filter),
                        *[Option(ORDER_STATUS_DISPLAY_MAP[status], value=status, 
                               selected=status_filter==status) 
                          for status in ORDER_STATUS_DISPLAY_MAP.keys()],
                        name="status", cls="select select-bordered"
                    ),
                    cls="form-control w-full max-w-xs"
                ),
                
                # å•†æˆ·ç­›é€‰
                Div(
                    Label("å•†æˆ·ç­›é€‰:", cls="label"),
                    Select(
                        Option("å…¨éƒ¨å•†æˆ·", value="", selected=not merchant_filter),
                        *[Option(f"#{merchant['id']} - {merchant.get('name', 'æœªè®¾ç½®')}", 
                               value=str(merchant['id']),
                               selected=merchant_filter==str(merchant['id'])) 
                          for merchant in merchants],
                        name="merchant_id", cls="select select-bordered"
                    ),
                    cls="form-control w-full max-w-xs"
                ),
                
                # æ—¥æœŸç­›é€‰
                Div(
                    Label("å¼€å§‹æ—¥æœŸ:", cls="label"),
                    Input(type="date", name="date_from", value=date_from,
                          cls="input input-bordered"),
                    cls="form-control w-full max-w-xs"
                ),
                
                Div(
                    Label("ç»“æŸæ—¥æœŸ:", cls="label"),
                    Input(type="date", name="date_to", value=date_to,
                          cls="input input-bordered"),
                    cls="form-control w-full max-w-xs"
                ),
                
                cls="flex flex-wrap gap-4 mb-4"
            ),
            
            Div(
                Button("æœç´¢", type="submit", cls="btn btn-primary"),
                A("é‡ç½®", href="/orders", cls="btn btn-ghost ml-2"),
                cls="flex gap-2"
            ),
            
            method="get"
        )
        
        # ç»Ÿè®¡é¢æ¿
        stats_panel = generate_order_statistics_panel(stats)
        
        # æ‰¹é‡æ“ä½œé¢æ¿
        batch_operations = generate_order_batch_operations()
        
        # æ„å»ºè®¢å•è¡¨æ ¼
        orders_table = Table(
            Thead(
                Tr(
                    Th(Input(type="checkbox", cls="checkbox", id="select_all")),
                    Th("è®¢å•ID"),
                    Th("å•†æˆ·"),
                    Th("å®¢æˆ·"),
                    Th("ä»·æ ¼"),
                    Th("çŠ¶æ€"),
                    Th("é¢„çº¦æ—¶é—´"),
                    Th("åˆ›å»ºæ—¶é—´"),
                    Th("æ“ä½œ")
                )
            ),
            Tbody(
                *[
                    Tr(
                        Td(Input(type="checkbox", name="order_ids", 
                                value=str(order['id']), cls="checkbox")),
                        Td(f"#{order['id']}"),
                        Td(
                            Div(
                                P(order.get('merchant_name', 'æœªè®¾ç½®'), cls="font-semibold"),
                                P(f"ID: {order['merchant_id']}", cls="text-sm text-gray-500"),
                                cls="flex flex-col"
                            )
                        ),
                        Td(
                            Div(
                                P(order.get('customer_username', 'æœªçŸ¥ç”¨æˆ·'), cls="font-semibold"),
                                P(f"ID: {order['customer_user_id']}", cls="text-sm text-gray-500"),
                                cls="flex flex-col"
                            )
                        ),
                        Td(f"Â¥{order['price']}"),
                        Td(
                            Span(
                                get_order_status_icon(order['status']),
                                ORDER_STATUS_DISPLAY_MAP.get(order['status'], order['status']),
                                cls=f"badge {get_order_status_color(order['status'])} gap-1"
                            )
                        ),
                        Td(order.get('appointment_time', 'æœªè®¾ç½®')),
                        Td(order.get('created_at', '')),
                        Td(
                            Div(
                                A("è¯¦æƒ…", href=f"/orders/{order['id']}", 
                                  cls="btn btn-sm btn-info mr-1"),
                                *generate_order_action_buttons(
                                    str(order['id']), 
                                    order['status'],
                                    order['merchant_id'],
                                    order['customer_user_id']
                                ),
                                cls="flex gap-1 flex-wrap"
                            )
                        )
                    )
                    for order in orders_data['orders']
                ]
            ),
            cls="table table-zebra w-full"
        )
        
        # åˆ†é¡µç»„ä»¶
        total_pages = (orders_data['total'] + per_page - 1) // per_page
        pagination = Div(
            Div(f"å…± {orders_data['total']} æ¡è®°å½•", cls="text-sm text-gray-500"),
            Div(
                *[
                    A(
                        str(p),
                        href=f"/orders?page={p}&per_page={per_page}&status={status_filter}&merchant_id={merchant_filter}&date_from={date_from}&date_to={date_to}",
                        cls=f"btn btn-sm {'btn-active' if p == page else 'btn-ghost'}"
                    )
                    for p in range(max(1, page-2), min(total_pages+1, page+3))
                ],
                cls="btn-group"
            ),
            cls="flex justify-between items-center mt-4"
        )
        
        # å…¨é€‰åŠŸèƒ½è„šæœ¬
        select_all_script = Script(
            """
            document.getElementById('select_all').addEventListener('change', function(e) {
                const checkboxes = document.getElementsByName('order_ids');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            });
            """
        )
        
        content = Div(
            H1("è®¢å•ç®¡ç†", cls="page-title"),
            
            # ç»Ÿè®¡é¢æ¿
            stats_panel,
            
            # ç­›é€‰è¡¨å•
            Div(filter_form, cls="bg-base-100 p-4 rounded-lg shadow mb-6"),
            
            # æ‰¹é‡æ“ä½œ
            batch_operations,
            
            # è®¢å•è¡¨æ ¼
            Div(orders_table, cls="overflow-x-auto"),
            
            # åˆ†é¡µ
            pagination if total_pages > 1 else "",
            
            # JavaScript
            select_all_script,
            
            cls="w-full"
        )
        
        return create_layout("è®¢å•ç®¡ç†", content)
        
    except Exception as e:
        logger.error(f"è·å–è®¢å•åˆ—è¡¨å¤±è´¥: {e}")
        error_content = Div(
            H1("è·å–å¤±è´¥", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"è·å–è®¢å•åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"),
            A("è¿”å›é¦–é¡µ", href="/", cls="btn btn-primary mt-4")
        )
        return create_layout("è·å–å¤±è´¥", error_content)


@app.get("/orders/{order_id}")
async def order_detail(order_id: int):
    """è®¢å•è¯¦æƒ…é¡µé¢ - åŒ…å«å®Œæ•´çš„å…³è”æ¨¡å—ä¿¡æ¯"""
    try:
        # è·å–è®¢å•è¯¦æƒ…
        order_data = await order_manager.get_order_by_id(order_id)
        if not order_data:
            raise ValueError("è®¢å•ä¸å­˜åœ¨")
        
        # è·å–å…³è”çš„å•†æˆ·ä¿¡æ¯
        merchant_info = await merchant_manager.get_merchant(order_data['merchant_id'])
        
        # è·å–å…³è”çš„ç”¨æˆ·ä¿¡æ¯
        customer_info = await user_manager.get_user_profile(order_data['customer_user_id'])
        
        # è·å–å…³è”çš„è¯„ä»·ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
        review_info = None
        if order_data['status'] in [ORDER_STATUS.REVIEWED.value, ORDER_STATUS.MUTUAL_REVIEW.value, ORDER_STATUS.SINGLE_REVIEW.value]:
            try:
                review_info = await review_manager.get_review_by_order(order_id)
            except:
                pass
        
        # çŠ¶æ€è½¬æ¢é€‰é¡¹
        status_options = get_order_next_status_options(order_data['status'])
        
        # æ„å»ºè®¢å•ä¿¡æ¯å¡ç‰‡
        order_info_card = Div(
            H3("è®¢å•ä¿¡æ¯", cls="text-lg font-bold mb-4"),
            
            Div(
                Div(
                    Div("è®¢å•çŠ¶æ€", cls="stat-title"),
                    Div(
                        Span(
                            get_order_status_icon(order_data['status']),
                            ORDER_STATUS_DISPLAY_MAP.get(order_data['status'], order_data['status']),
                            cls=f"badge badge-lg {get_order_status_color(order_data['status'])} gap-2"
                        ),
                        cls="stat-value text-sm"
                    ),
                    cls="stat"
                ),
                Div(
                    Div("è®¢å•ä»·æ ¼", cls="stat-title"),
                    Div(f"Â¥{order_data['price']}", cls="stat-value text-success"),
                    cls="stat"
                ),
                Div(
                    Div("åˆ›å»ºæ—¶é—´", cls="stat-title"),
                    Div(order_data.get('created_at', 'æœªçŸ¥'), cls="stat-value text-sm"),
                    cls="stat"
                ),
                cls="stats shadow mb-4"
            ),
            
            cls="bg-base-200 p-4 rounded mb-6"
        )
        
        # å•†æˆ·ä¿¡æ¯å¡ç‰‡
        merchant_card = Div(
            H3("å•†æˆ·ä¿¡æ¯", cls="text-lg font-bold mb-4"),
            
            Div(
                P(f"å•†æˆ·åç§°: {merchant_info.get('name', 'æœªè®¾ç½®')}", cls="text-lg font-semibold"),
                P(f"å•†æˆ·ID: #{merchant_info['id']}", cls="text-gray-500"),
                P(f"è”ç³»æ–¹å¼: {merchant_info.get('username', 'æœªè®¾ç½®')}", cls="text-gray-500"),
                P(f"åœ°åŒº: {merchant_info.get('city_name', '')} - {merchant_info.get('district_name', '')}", cls="text-gray-500"),
                
                # å•†æˆ·æ“ä½œæŒ‰é’®
                Div(
                    A("æŸ¥çœ‹å•†æˆ·è¯¦æƒ…", href=f"/posts/{order_data['merchant_id']}", 
                      cls="btn btn-primary btn-sm"),
                    A("è”ç³»å•†æˆ·", href=f"https://t.me/xiaojisystembot?start=merchant_{order_data['merchant_id']}", 
                      target="_blank", cls="btn btn-info btn-sm ml-2"),
                    cls="mt-4 flex gap-2"
                )
            ),
            
            cls="bg-base-200 p-4 rounded mb-6"
        )
        
        # å®¢æˆ·ä¿¡æ¯å¡ç‰‡
        customer_card = Div(
            H3("å®¢æˆ·ä¿¡æ¯", cls="text-lg font-bold mb-4"),
            
            Div(
                P(f"ç”¨æˆ·å: {order_data.get('customer_username', 'æœªçŸ¥')}", cls="text-lg font-semibold"),
                P(f"Telegram ID: {order_data['customer_user_id']}", cls="text-gray-500"),
                P(f"ç­‰çº§: {customer_info.get('level', 1) if customer_info else 'æœªçŸ¥'}", cls="text-gray-500"),
                P(f"ç§¯åˆ†: {customer_info.get('points', 0) if customer_info else 'æœªçŸ¥'}", cls="text-gray-500"),
                
                # å®¢æˆ·æ“ä½œæŒ‰é’®
                Div(
                    A("æŸ¥çœ‹ç”¨æˆ·èµ„æ–™", href=f"/users/{order_data['customer_user_id']}", 
                      cls="btn btn-secondary btn-sm"),
                    cls="mt-4"
                )
            ),
            
            cls="bg-base-200 p-4 rounded mb-6"
        )
        
        # è¯„ä»·ä¿¡æ¯å¡ç‰‡ï¼ˆå¦‚æœæœ‰è¯„ä»·ï¼‰
        review_card = ""
        if review_info:
            review_card = Div(
                H3("è¯„ä»·ä¿¡æ¯", cls="text-lg font-bold mb-4"),
                
                Div(
                    P(f"é¢œå€¼è¯„åˆ†: {review_info.get('rating_appearance', 'æœªè¯„åˆ†')}/10", cls="mb-2"),
                    P(f"èº«æè¯„åˆ†: {review_info.get('rating_figure', 'æœªè¯„åˆ†')}/10", cls="mb-2"),
                    P(f"æœåŠ¡è¯„åˆ†: {review_info.get('rating_service', 'æœªè¯„åˆ†')}/10", cls="mb-2"),
                    P(f"æ€åº¦è¯„åˆ†: {review_info.get('rating_attitude', 'æœªè¯„åˆ†')}/10", cls="mb-2"),
                    P(f"ç¯å¢ƒè¯„åˆ†: {review_info.get('rating_environment', 'æœªè¯„åˆ†')}/10", cls="mb-2"),
                    
                    # æ–‡å­—è¯„ä»·
                    review_info.get('text_review_by_user') and Div(
                        P("æ–‡å­—è¯„ä»·:", cls="font-semibold"),
                        P(review_info['text_review_by_user'], cls="text-gray-700 bg-gray-100 p-2 rounded"),
                        cls="mt-4"
                    ),
                    
                    # å•†æˆ·ç¡®è®¤çŠ¶æ€
                    Div(
                        P("å•†æˆ·ç¡®è®¤:", cls="font-semibold"),
                        Span(
                            "âœ… å·²ç¡®è®¤" if review_info.get('is_confirmed_by_merchant') else "â³ å¾…ç¡®è®¤",
                            cls=f"badge {'badge-success' if review_info.get('is_confirmed_by_merchant') else 'badge-warning'}"
                        ),
                        cls="mt-2"
                    ),
                    
                    # è¯„ä»·ç®¡ç†æŒ‰é’®
                    Div(
                        A("æŸ¥çœ‹å®Œæ•´è¯„ä»·", href=f"/reviews/order/{order_id}", 
                          cls="btn btn-accent btn-sm"),
                        A("è¯„ä»·ç®¡ç†", href=f"/reviews?order_id={order_id}", 
                          cls="btn btn-outline btn-accent btn-sm ml-2"),
                        cls="mt-4 flex gap-2"
                    )
                ),
                
                cls="bg-base-200 p-4 rounded mb-6"
            )
        
        # çŠ¶æ€ç®¡ç†è¡¨å•
        status_form = Form(
            H3("çŠ¶æ€ç®¡ç†", cls="text-lg font-bold mb-4"),
            
            Div(
                Label("æ›´æ–°çŠ¶æ€:", cls="label"),
                Select(
                    *[Option(display_text, value=status_value,
                           selected=order_data['status']==status_value)
                      for status_value, display_text in status_options],
                    name="status", cls="select select-bordered w-full max-w-xs"
                ),
                cls="form-control w-full max-w-xs mb-4"
            ),
            
            # å¤‡æ³¨å­—æ®µ
            Div(
                Label("æ“ä½œå¤‡æ³¨:", cls="label"),
                Textarea(
                    name="note",
                    placeholder="å¯é€‰ï¼šè®°å½•çŠ¶æ€å˜æ›´åŸå› ...",
                    cls="textarea textarea-bordered w-full"
                ),
                cls="form-control w-full mb-4"
            ),
            
            Div(
                Button("æ›´æ–°çŠ¶æ€", type="submit", cls="btn btn-primary"),
                A("å–æ¶ˆ", href="/orders", cls="btn btn-ghost ml-2"),
                cls="flex gap-2"
            ),
            
            method="post",
            action=f"/orders/{order_id}/update_status",
            cls="bg-base-200 p-4 rounded mb-6"
        )
        
        # å¿«é€Ÿæ“ä½œæŒ‰é’®
        quick_actions = Div(
            H3("å¿«é€Ÿæ“ä½œ", cls="text-lg font-bold mb-4"),
            Div(
                *generate_order_action_buttons(
                    str(order_id), 
                    order_data['status'],
                    order_data['merchant_id'],
                    order_data['customer_user_id']
                ),
                cls="flex gap-2 flex-wrap"
            ),
            cls="bg-base-200 p-4 rounded mb-6"
        )
        
        content = Div(
            H1(f"è®¢å•è¯¦æƒ… #{order_id}", cls="page-title"),
            
            # è®¢å•åŸºæœ¬ä¿¡æ¯
            order_info_card,
            
            Div(
                # å·¦ä¾§ï¼šå•†æˆ·å’Œå®¢æˆ·ä¿¡æ¯
                Div(
                    merchant_card,
                    customer_card,
                    cls="space-y-4"
                ),
                
                # å³ä¾§ï¼šè¯„ä»·ä¿¡æ¯å’Œæ“ä½œ
                Div(
                    review_card,
                    status_form,
                    quick_actions,
                    cls="space-y-4"
                ),
                
                cls="grid grid-cols-1 lg:grid-cols-2 gap-6"
            ),
            
            cls="w-full"
        )
        
        return create_layout("è®¢å•è¯¦æƒ…", content)
        
    except Exception as e:
        logger.error(f"è·å–è®¢å•è¯¦æƒ…å¤±è´¥: {e}")
        error_content = Div(
            H1("è·å–å¤±è´¥", cls="text-2xl font-bold text-red-600 mb-4"),
            P(f"è·å–è®¢å•è¯¦æƒ…æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"),
            A("è¿”å›è®¢å•åˆ—è¡¨", href="/orders", cls="btn btn-primary mt-4")
        )
        return create_layout("è·å–å¤±è´¥", error_content)


@app.post("/orders/{order_id}/update_status")
async def order_update_status(order_id: int, request):
    """æ›´æ–°è®¢å•çŠ¶æ€"""
    try:
        form_data = await request.form()
        new_status = form_data.get('status')
        note = form_data.get('note', '')
        
        await order_manager.update_order_status(order_id, new_status)
        
        from starlette.responses import RedirectResponse
        return RedirectResponse(url=f"/orders/{order_id}", status_code=302)
        
    except Exception as e:
        logger.error(f"æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥: {e}")
        from starlette.responses import RedirectResponse
        return RedirectResponse(url=f"/orders/{order_id}?error=æ›´æ–°å¤±è´¥", status_code=302)


@app.post("/orders/{order_id}/complete")
async def order_complete(order_id: int):
    """æ ‡è®°è®¢å•å®Œæˆ"""
    try:
        await order_manager.update_order_status(order_id, ORDER_STATUS.COMPLETED.value)
        
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/orders", status_code=302)
        
    except Exception as e:
        logger.error(f"æ ‡è®°è®¢å•å®Œæˆå¤±è´¥: {e}")
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/orders?error=æ“ä½œå¤±è´¥", status_code=302)


@app.post("/orders/{order_id}/cancel")
async def order_cancel(order_id: int):
    """å–æ¶ˆè®¢å•"""
    try:
        await order_manager.delete_order(order_id)
        
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/orders", status_code=302)
        
    except Exception as e:
        logger.error(f"å–æ¶ˆè®¢å•å¤±è´¥: {e}")
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/orders?error=å–æ¶ˆå¤±è´¥", status_code=302)


@app.post("/orders/{order_id}/mark_reviewed")
async def order_mark_reviewed(order_id: int):
    """æ ‡è®°è®¢å•å·²è¯„ä»·"""
    try:
        await order_manager.update_order_status(order_id, ORDER_STATUS.REVIEWED.value)
        
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/orders", status_code=302)
        
    except Exception as e:
        logger.error(f"æ ‡è®°è®¢å•è¯„ä»·å¤±è´¥: {e}")
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/orders?error=æ“ä½œå¤±è´¥", status_code=302)


@app.post("/orders/batch")
async def orders_batch_operation(request):
    """æ‰¹é‡æ“ä½œè®¢å•"""
    try:
        form_data = await request.form()
        action = form_data.get('batch_action')
        order_ids = form_data.getlist('order_ids')
        
        if not order_ids:
            raise ValueError("è¯·é€‰æ‹©è¦æ“ä½œçš„è®¢å•")
        
        if action == 'batch_complete':
            for order_id in order_ids:
                await order_manager.update_order_status(int(order_id), ORDER_STATUS.COMPLETED.value)
        elif action == 'batch_reviewed':
            for order_id in order_ids:
                await order_manager.update_order_status(int(order_id), ORDER_STATUS.REVIEWED.value)
        elif action == 'batch_cancel':
            for order_id in order_ids:
                await order_manager.delete_order(int(order_id))
        elif action == 'batch_export':
            # å¯¼å‡ºCSVæ–‡ä»¶
            import csv
            import io
            from starlette.responses import StreamingResponse
            
            orders_data = []
            for order_id in order_ids:
                order = await order_manager.get_order_by_id(int(order_id))
                if order:
                    orders_data.append(order)
            
            output = io.StringIO()
            writer = csv.writer(output)
            
            # å†™å…¥æ ‡é¢˜è¡Œ
            writer.writerow([
                'è®¢å•ID', 'å•†æˆ·ID', 'å•†æˆ·åç§°', 'å®¢æˆ·ID', 'å®¢æˆ·ç”¨æˆ·å', 
                'ä»·æ ¼', 'çŠ¶æ€', 'é¢„çº¦æ—¶é—´', 'å®Œæˆæ—¶é—´', 'åˆ›å»ºæ—¶é—´'
            ])
            
            # å†™å…¥æ•°æ®è¡Œ
            for order in orders_data:
                writer.writerow([
                    order['id'],
                    order['merchant_id'],
                    order.get('merchant_name', ''),
                    order['customer_user_id'],
                    order.get('customer_username', ''),
                    order['price'],
                    ORDER_STATUS_DISPLAY_MAP.get(order['status'], order['status']),
                    order.get('appointment_time', ''),
                    order.get('completion_time', ''),
                    order.get('created_at', '')
                ])
            
            output.seek(0)
            filename = f"orders_export_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
            
            def generate():
                yield output.getvalue().encode('utf-8-sig')
            
            return StreamingResponse(
                generate(),
                media_type="text/csv",
                headers={"Content-Disposition": f"attachment; filename={filename}"}
            )
        
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/orders", status_code=302)
        
    except Exception as e:
        logger.error(f"æ‰¹é‡æ“ä½œå¤±è´¥: {e}")
        from starlette.responses import RedirectResponse
        return RedirectResponse(url="/orders?error=æ‰¹é‡æ“ä½œå¤±è´¥", status_code=302)

