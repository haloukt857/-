# -*- coding: utf-8 -*-
"""
è®¢å•ç®¡ç†è·¯ç”± V2.0
å¢å¼ºç‰ˆè®¢å•ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒå®Œæ•´çš„V2.0ä¸šåŠ¡æµç¨‹
"""

import logging
from typing import Any, Dict, List, Optional
from starlette.routing import Route
from starlette.responses import RedirectResponse, Response, StreamingResponse, HTMLResponse
from starlette.exceptions import HTTPException
from starlette.requests import Request
from datetime import datetime, timedelta
import csv
import io
import json

# å¯¼å…¥é¡¹ç›®æ¨¡å—
from database.db_orders import OrderManager
from database.db_merchants import merchant_manager
from database.db_users import user_manager
from web.layout import create_layout, require_auth, okx_form_group, okx_input, okx_button, okx_textarea, okx_select
from utils.enums import ORDER_STATUS
from fasthtml.common import *

logger = logging.getLogger(__name__)

# V2.0 è®¢å•çŠ¶æ€æ˜ å°„å’Œé¢œè‰²
ORDER_STATUS_COLORS = {
    ORDER_STATUS.ATTEMPT_BOOKING.value: "warning",
    ORDER_STATUS.COMPLETED.value: "success", 
    ORDER_STATUS.REVIEWED.value: "info",
    ORDER_STATUS.MUTUAL_REVIEW.value: "primary",
    ORDER_STATUS.SINGLE_REVIEW.value: "secondary"
}

ORDER_STATUS_ICONS = {
    ORDER_STATUS.ATTEMPT_BOOKING.value: "â³",
    ORDER_STATUS.COMPLETED.value: "âœ…",
    ORDER_STATUS.REVIEWED.value: "â­", 
    ORDER_STATUS.MUTUAL_REVIEW.value: "ğŸ¤",
    ORDER_STATUS.SINGLE_REVIEW.value: "ğŸ“"
}

@require_auth
async def orders_dashboard(request: Request) -> Response:
    """è®¢å•ç®¡ç†ä»ªè¡¨æ¿ - V2.0å¢å¼ºç‰ˆ"""
    
    # è·å–ç­›é€‰å‚æ•°
    status_filter = request.query_params.get("status", "")
    merchant_filter = request.query_params.get("merchant", "") 
    user_filter = request.query_params.get("user", "")
    date_from = request.query_params.get("date_from", "")
    date_to = request.query_params.get("date_to", "")
    page = int(request.query_params.get("page", "1"))
    per_page = int(request.query_params.get("per_page", "20"))
    
    try:
        # æ„å»ºæŸ¥è¯¢å‚æ•°
        query_params = {
            'status': status_filter if status_filter else None,
            'merchant_id': int(merchant_filter) if merchant_filter.isdigit() else None,
            'user_id': int(user_filter) if user_filter.isdigit() else None,
            'date_from': date_from if date_from else None,
            'date_to': date_to if date_to else None,
            'limit': per_page,
            'offset': (page - 1) * per_page
        }
        
        # è·å–è®¢å•æ•°æ®
        order_manager = OrderManager()
        orders = await order_manager.get_orders(**query_params)
        
        # è·å–æ€»æ•°ç”¨äºåˆ†é¡µ
        total_orders = await order_manager.count_orders(
            status=query_params['status'],
            merchant_id=query_params['merchant_id'],
            user_id=query_params['user_id'],
            date_from=query_params['date_from'],
            date_to=query_params['date_to']
        )
        
        # è·å–ç»Ÿè®¡æ•°æ®
        stats = await _get_order_statistics()
        
        # è·å–å•†æˆ·åˆ—è¡¨ç”¨äºç­›é€‰
        merchants = await merchant_manager.get_merchants(limit=100)
        
    except Exception as e:
        logger.error(f"è·å–è®¢å•æ•°æ®å¤±è´¥: {e}")
        raise HTTPException(status_code=500, detail="æ— æ³•è·å–è®¢å•æ•°æ®")
    
    # ç»Ÿè®¡å¡ç‰‡
    stats_cards = Div(
        # ä»Šæ—¥è®¢å•
        Div(
            Div(
                Span("ğŸ“Š", cls="text-3xl"),
                Div(
                    P("ä»Šæ—¥è®¢å•", cls="text-sm text-gray-500"),
                    P(str(stats['today_orders']), cls="text-2xl font-bold text-primary")
                ),
                cls="flex items-center gap-3"
            ),
            cls="stat-card"
        ),
        
        # æœ¬å‘¨æ”¶å…¥
        Div(
            Div(
                Span("ğŸ’°", cls="text-3xl"),
                Div(
                    P("æœ¬å‘¨æ”¶å…¥", cls="text-sm text-gray-500"),
                    P(f"Â¥{stats['week_revenue']:,.0f}", cls="text-2xl font-bold text-success")
                ),
                cls="flex items-center gap-3"
            ),
            cls="stat-card"
        ),
        
        # å®Œæˆç‡
        Div(
            Div(
                Span("ğŸ“ˆ", cls="text-3xl"), 
                Div(
                    P("å®Œæˆç‡", cls="text-sm text-gray-500"),
                    P(f"{stats['completion_rate']:.1f}%", cls="text-2xl font-bold text-info")
                ),
                cls="flex items-center gap-3"
            ),
            cls="stat-card"
        ),
        
        # æ´»è·ƒç”¨æˆ·
        Div(
            Div(
                Span("ğŸ‘¥", cls="text-3xl"),
                Div(
                    P("æ´»è·ƒç”¨æˆ·", cls="text-sm text-gray-500"),
                    P(str(stats['active_users']), cls="text-2xl font-bold text-warning")
                ),
                cls="flex items-center gap-3"
            ),
            cls="stat-card"
        ),
        
        cls="stats-container"
    )
    
    # é«˜çº§æœç´¢å’Œç­›é€‰è¡¨å•
    filter_form = Form(
        Div(
            # ç¬¬ä¸€è¡Œç­›é€‰å™¨
            Div(
                Div(
                    Label("è®¢å•çŠ¶æ€", cls="label-text text-sm font-medium"),
                    okx_select("status", [
                        ('', 'æ‰€æœ‰çŠ¶æ€'),
                        (ORDER_STATUS.ATTEMPT_BOOKING.value, f"{ORDER_STATUS_ICONS[ORDER_STATUS.ATTEMPT_BOOKING.value]} {ORDER_STATUS.ATTEMPT_BOOKING.value}"),
                        (ORDER_STATUS.COMPLETED.value, f"{ORDER_STATUS_ICONS[ORDER_STATUS.COMPLETED.value]} {ORDER_STATUS.COMPLETED.value}"),
                        (ORDER_STATUS.REVIEWED.value, f"{ORDER_STATUS_ICONS[ORDER_STATUS.REVIEWED.value]} {ORDER_STATUS.REVIEWED.value}"),
                        (ORDER_STATUS.MUTUAL_REVIEW.value, f"{ORDER_STATUS_ICONS[ORDER_STATUS.MUTUAL_REVIEW.value]} {ORDER_STATUS.MUTUAL_REVIEW.value}"),
                        (ORDER_STATUS.SINGLE_REVIEW.value, f"{ORDER_STATUS_ICONS[ORDER_STATUS.SINGLE_REVIEW.value]} {ORDER_STATUS.SINGLE_REVIEW.value}")
                    ], selected=status_filter, cls="select select-bordered w-full"),
                    cls="form-group"
                ),
                
                Div(
                    Label("å•†æˆ·ç­›é€‰", cls="label-text text-sm font-medium"),
                    okx_select("merchant", [('', 'æ‰€æœ‰å•†æˆ·')] + 
                              [(str(m['id']), m['name']) for m in merchants], 
                              selected=merchant_filter, cls="select select-bordered w-full"),
                    cls="form-group"
                ),
                
                Div(
                    Label("ç”¨æˆ·ID", cls="label-text text-sm font-medium"),
                    okx_input("user", placeholder="è¾“å…¥ç”¨æˆ·ID", value=user_filter, 
                             cls="input input-bordered w-full"),
                    cls="form-group"
                ),
                
                Div(
                    Label("æ¯é¡µæ˜¾ç¤º", cls="label-text text-sm font-medium"),
                    okx_select("per_page", [
                        ('10', '10æ¡'),
                        ('20', '20æ¡'),
                        ('50', '50æ¡'),
                        ('100', '100æ¡')
                    ], selected=str(per_page), cls="select select-bordered w-full"),
                    cls="form-group"
                ),
                
                cls="content-grid grid-4"
            ),
            
            # ç¬¬äºŒè¡Œï¼šæ—¥æœŸèŒƒå›´
            Div(
                Div(
                    Label("å¼€å§‹æ—¥æœŸ", cls="label-text text-sm font-medium"),
                    okx_input("date_from", type="date", value=date_from, 
                             cls="input input-bordered w-full"),
                    cls="form-group"
                ),
                
                Div(
                    Label("ç»“æŸæ—¥æœŸ", cls="label-text text-sm font-medium"),
                    okx_input("date_to", type="date", value=date_to,
                             cls="input input-bordered w-full"),
                    cls="form-group"
                ),
                
                # æ“ä½œæŒ‰é’®
                Div(
                    Label("æ“ä½œ", cls="label-text text-sm font-medium opacity-0"),
                    Div(
                        okx_button("ğŸ” ç­›é€‰", type="submit", cls="btn btn-primary"),
                        A("ğŸ”„ é‡ç½®", href="/orders", cls="btn btn-outline"),
                        cls="action-buttons"
                    ),
                    cls="form-group"
                ),
                
                cls="content-grid grid-3"
            ),
            
            cls="filter-container"
        ),
        method="get",
        action="/orders"
    )
    
    # æ‰¹é‡æ“ä½œå·¥å…·æ 
    batch_toolbar = Div(
        Div(
            H3("æ‰¹é‡æ“ä½œ", cls="content-section-title"),
            P("é€‰æ‹©è®¢å•åå¯è¿›è¡Œæ‰¹é‡æ“ä½œ", cls="text-sm text-gray-500"),
        ),
        Div(
            Form(
                Input(type="hidden", name="action", value="batch_complete"),
                okx_button("âœ… æ‰¹é‡å®Œæˆ", type="submit", cls="btn btn-success btn-sm", 
                          onclick="return confirmBatchAction('å®Œæˆ')"),
                method="post",
                action="/orders/batch"
            ),
            Form(
                Input(type="hidden", name="action", value="batch_cancel"),
                okx_button("âŒ æ‰¹é‡å–æ¶ˆ", type="submit", cls="btn btn-error btn-sm",
                          onclick="return confirmBatchAction('å–æ¶ˆ')"),
                method="post", 
                action="/orders/batch"
            ),
            A("ğŸ“Š å¯¼å‡ºæ•°æ®", href="/orders/export" + (f"?{request.url.query}" if request.url.query else ""), 
              cls="btn btn-outline btn-sm"),
            cls="action-buttons"
        ),
        cls="toolbar-container"
    )
    
    # è®¢å•åˆ—è¡¨è¡¨æ ¼
    table_rows = []
    for order in orders:
        status_color = ORDER_STATUS_COLORS.get(order['status'], 'secondary')
        status_icon = ORDER_STATUS_ICONS.get(order['status'], 'â“')
        
        row = Tr(
            # é€‰æ‹©æ¡†
            Td(
                Input(type="checkbox", name="order_ids", value=str(order['id']),
                     cls="checkbox checkbox-primary"),
                cls="w-12"
            ),
            
            # è®¢å•ID
            Td(
                Div(
                    Strong(f"#{order['id']}", cls="font-mono text-sm"),
                    P(order['created_at'][:16], cls="text-xs text-gray-500"),
                    cls="space-y-1"
                ),
                cls="min-w-24"
            ),
            
            # ç”¨æˆ·ä¿¡æ¯
            Td(
                Div(
                    P(order.get('customer_username', f"ç”¨æˆ·{order['customer_user_id']}"), 
                      cls="font-medium text-sm"),
                    P(f"ID: {order['customer_user_id']}", cls="text-xs text-gray-500"),
                    cls="space-y-1"
                )
            ),
            
            # å•†æˆ·ä¿¡æ¯
            Td(
                Div(
                    P(order.get('merchant_name', 'æœªçŸ¥å•†æˆ·'), cls="font-medium text-sm"),
                    P(f"ID: {order['merchant_id']}", cls="text-xs text-gray-500"),
                    cls="space-y-1"
                )
            ),
            
            # ä»·æ ¼
            Td(
                Strong(f"Â¥{order['price']}", cls="text-lg text-success"),
                cls="text-right"
            ),
            
            # çŠ¶æ€
            Td(
                Span(
                    f"{status_icon} {order['status']}", 
                    cls=f"badge badge-{status_color} text-xs font-medium"
                )
            ),
            
            # é¢„çº¦æ—¶é—´
            Td(
                order.get('appointment_time', 'æœªè®¾ç½®')[:16] if order.get('appointment_time') else '-',
                cls="text-sm"
            ),
            
            # æ“ä½œ
            Td(
                Div(
                    A("ğŸ‘ï¸", href=f"/orders/{order['id']}/detail", 
                      cls="btn btn-ghost btn-xs", title="æŸ¥çœ‹è¯¦æƒ…"),
                    _generate_quick_action_button(order),
                    cls="flex gap-1"
                )
            ),
            
            cls="hover:bg-gray-50"
        )
        table_rows.append(row)
    
    # åˆ†é¡µä¿¡æ¯
    total_pages = (total_orders + per_page - 1) // per_page
    pagination = _generate_pagination(page, total_pages, request.query_params)
    
    # è¡¨æ ¼
    orders_table = Div(
        Table(
            Thead(
                Tr(
                    Th(
                        Input(type="checkbox", cls="checkbox checkbox-primary", 
                              onclick="toggleAllOrders(this)"),
                        cls="w-12"
                    ),
                    Th("è®¢å•ä¿¡æ¯"),
                    Th("ç”¨æˆ·"),
                    Th("å•†æˆ·"),
                    Th("é‡‘é¢", cls="text-right"),
                    Th("çŠ¶æ€"),
                    Th("é¢„çº¦æ—¶é—´"),
                    Th("æ“ä½œ", cls="w-24")
                )
            ),
            Tbody(*table_rows),
            cls="table table-zebra w-full"
        ),
        cls="data-table-container"
    )
    
    # JavaScriptä»£ç 
    script = Script(f"""
    function toggleAllOrders(source) {{
        const checkboxes = document.querySelectorAll('input[name="order_ids"]');
        checkboxes.forEach(checkbox => checkbox.checked = source.checked);
    }}
    
    function confirmBatchAction(action) {{
        const selected = document.querySelectorAll('input[name="order_ids"]:checked');
        if (selected.length === 0) {{
            alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„è®¢å•');
            return false;
        }}
        return confirm(`ç¡®å®šè¦${action}é€‰ä¸­çš„ ${{selected.length}} ä¸ªè®¢å•å—ï¼Ÿ`);
    }}
    
    // å®æ—¶ç»Ÿè®¡æ›´æ–° (å¯é€‰)
    setInterval(async function() {{
        try {{
            const response = await fetch('/orders/stats');
            const stats = await response.json();
            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡... (å®ç°ç•¥)
        }} catch (e) {{
            console.log('ç»Ÿè®¡æ›´æ–°å¤±è´¥:', e);
        }}
    }}, 30000); // 30ç§’æ›´æ–°ä¸€æ¬¡
    """)
    
    content = Div(
        Div(
            H1("è®¢å•ç®¡ç†ä»ªè¡¨æ¿", cls="page-title"),
            A("ğŸ“Š æŸ¥çœ‹åˆ†æ", href="/orders/analytics", cls="btn btn-outline btn-sm"),
            cls="page-header"
        ),
        
        stats_cards,
        filter_form,
        batch_toolbar,
        orders_table,
        
        # åˆ†é¡µ
        Div(
            pagination,
            P(f"æ˜¾ç¤ºç¬¬ {(page-1)*per_page+1}-{min(page*per_page, total_orders)} æ¡ï¼Œå…± {total_orders} æ¡è®¢å•",
              cls="text-sm text-gray-500"),
            cls="pagination-container"
        ),
        
        script
    )
    
    return HTMLResponse(str(create_layout("è®¢å•ç®¡ç†", content)))

def _generate_quick_action_button(order: Dict[str, Any]) -> Any:
    """æ ¹æ®è®¢å•çŠ¶æ€ç”Ÿæˆå¿«é€Ÿæ“ä½œæŒ‰é’®"""
    status = order['status']
    
    if status == ORDER_STATUS.ATTEMPT_BOOKING.value:
        return A("âœ…", href=f"/orders/{order['id']}/complete",
                cls="btn btn-success btn-xs", title="æ ‡è®°å®Œæˆ")
    elif status == ORDER_STATUS.COMPLETED.value:
        return A("â­", href=f"/orders/{order['id']}/review",
                cls="btn btn-info btn-xs", title="ç®¡ç†è¯„ä»·")
    else:
        return A("âœï¸", href=f"/orders/{order['id']}/edit",
                cls="btn btn-outline btn-xs", title="ç¼–è¾‘è®¢å•")

def _generate_pagination(current_page: int, total_pages: int, query_params) -> Any:
    """ç”Ÿæˆåˆ†é¡µå¯¼èˆª"""
    if total_pages <= 1:
        return Div()
    
    # æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²
    query_dict = dict(query_params)
    if 'page' in query_dict:
        del query_dict['page']
    query_string = "&".join([f"{k}={v}" for k, v in query_dict.items() if v])
    query_prefix = f"?{query_string}&" if query_string else "?"
    
    pages = []
    
    # ä¸Šä¸€é¡µ
    if current_page > 1:
        pages.append(A("â€¹ ä¸Šä¸€é¡µ", href=f"/orders{query_prefix}page={current_page-1}",
                      cls="btn btn-outline btn-sm"))
    
    # é¡µç 
    start_page = max(1, current_page - 2)
    end_page = min(total_pages, current_page + 2)
    
    if start_page > 1:
        pages.append(A("1", href=f"/orders{query_prefix}page=1", cls="btn btn-outline btn-sm"))
        if start_page > 2:
            pages.append(Span("...", cls="px-2"))
    
    for page_num in range(start_page, end_page + 1):
        if page_num == current_page:
            pages.append(Span(str(page_num), cls="btn btn-primary btn-sm"))
        else:
            pages.append(A(str(page_num), href=f"/orders{query_prefix}page={page_num}",
                          cls="btn btn-outline btn-sm"))
    
    if end_page < total_pages:
        if end_page < total_pages - 1:
            pages.append(Span("...", cls="px-2"))
        pages.append(A(str(total_pages), href=f"/orders{query_prefix}page={total_pages}",
                      cls="btn btn-outline btn-sm"))
    
    # ä¸‹ä¸€é¡µ
    if current_page < total_pages:
        pages.append(A("ä¸‹ä¸€é¡µ â€º", href=f"/orders{query_prefix}page={current_page+1}",
                      cls="btn btn-outline btn-sm"))
    
    return Div(*pages, cls="join")

async def _get_order_statistics() -> Dict[str, Any]:
    """è·å–è®¢å•ç»Ÿè®¡æ•°æ®"""
    try:
        order_manager = OrderManager()
        
        # ä»Šæ—¥è®¢å•æ•°
        today = datetime.now().date()
        today_orders = await order_manager.count_orders(
            date_from=today.isoformat(),
            date_to=(today + timedelta(days=1)).isoformat()
        )
        
        # æœ¬å‘¨æ”¶å…¥
        week_start = today - timedelta(days=today.weekday())
        week_revenue = await order_manager.get_revenue_stats(
            date_from=week_start.isoformat(),
            date_to=(today + timedelta(days=1)).isoformat()
        )
        
        # å®Œæˆç‡
        total_orders = await order_manager.count_orders()
        completed_orders = await order_manager.count_orders(
            status=ORDER_STATUS.COMPLETED.value
        )
        completion_rate = (completed_orders / total_orders * 100) if total_orders > 0 else 0
        
        # æ´»è·ƒç”¨æˆ·æ•° (æœ¬å‘¨)
        active_users = await order_manager.count_active_users(
            date_from=week_start.isoformat()
        )
        
        return {
            'today_orders': today_orders,
            'week_revenue': week_revenue or 0,
            'completion_rate': completion_rate,
            'active_users': active_users
        }
        
    except Exception as e:
        logger.error(f"è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: {e}")
        return {
            'today_orders': 0,
            'week_revenue': 0,
            'completion_rate': 0,
            'active_users': 0
        }

@require_auth
async def order_detail_v2(request: Request) -> Response:
    """è®¢å•è¯¦æƒ…é¡µé¢ V2.0"""
    order_id = request.path_params['id']
    
    try:
        order_manager = OrderManager()
        order = await order_manager.get_order_by_id(int(order_id))
        if not order:
            raise HTTPException(status_code=404, detail="è®¢å•ä¸å­˜åœ¨")
            
        # è·å–ç”¨æˆ·ä¿¡æ¯
        user_info = await user_manager.get_user_profile(order['customer_user_id'])
        
        # è·å–å•†æˆ·ä¿¡æ¯
        merchant_info = await merchant_manager.get_merchant(order['merchant_id'])
        
    except Exception as e:
        logger.error(f"è·å–è®¢å•è¯¦æƒ…å¤±è´¥: {e}")
        raise HTTPException(status_code=500, detail="æ— æ³•è·å–è®¢å•è¯¦æƒ…")

    # è®¢å•ä¿¡æ¯å¡ç‰‡
    order_info_card = Div(
        Div(
            H3("ğŸ“‹ è®¢å•ä¿¡æ¯", cls="content-section-title"),
            Div(
                Div(f"è®¢å•ID: #{order['id']}", cls="font-mono text-lg"),
                Div(f"çŠ¶æ€: {ORDER_STATUS_ICONS.get(order['status'], 'â“')} {order['status']}", 
                    cls=f"badge badge-{ORDER_STATUS_COLORS.get(order['status'], 'secondary')} badge-lg"),
                Div(f"é‡‘é¢: Â¥{order['price']}", cls="text-2xl font-bold text-success"),
                Div(f"åˆ›å»ºæ—¶é—´: {order['created_at']}", cls="text-sm text-gray-500"),
                cls="space-y-3"
            ),
            cls="content-section"
        )
    )
    
    # ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
    user_info_card = Div(
        H3("ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯", cls="content-section-title"),
        Div(
            P(f"ç”¨æˆ·ID: {order['customer_user_id']}", cls="font-mono"),
            P(f"ç”¨æˆ·å: {order.get('customer_username', 'æœªçŸ¥')}", cls=""),
            P(f"ç­‰çº§: {user_info.get('level_name', 'æ–°æ‰‹') if user_info else 'æ–°æ‰‹'}", cls=""),
            P(f"å†å²è®¢å•: {user_info.get('order_count', 0) if user_info else 0}æ¬¡", cls=""),
            cls="space-y-2"
        ),
        cls="content-section"
    )
    
    # å•†æˆ·ä¿¡æ¯å¡ç‰‡  
    merchant_info_card = Div(
        H3("ğŸª å•†æˆ·ä¿¡æ¯", cls="content-section-title"),
        Div(
            P(f"å•†æˆ·: {merchant_info.get('name', 'æœªçŸ¥å•†æˆ·') if merchant_info else 'æœªçŸ¥å•†æˆ·'}", cls="font-medium"),
            P(f"å•†æˆ·ID: {order['merchant_id']}", cls="font-mono text-sm"),
            P(f"çŠ¶æ€: {merchant_info.get('status', 'æœªçŸ¥') if merchant_info else 'æœªçŸ¥'}", cls=""),
            A("æŸ¥çœ‹å•†æˆ·è¯¦æƒ…", href=f"/posts/{order['merchant_id']}", 
              cls="btn btn-outline btn-sm mt-2"),
            cls="space-y-2"
        ),
        cls="content-section"
    )
    
    # æ“ä½œå†å²æ—¶é—´çº¿ (é¢„ç•™)
    timeline_card = Div(
        H3("ğŸ“… æ“ä½œå†å²", cls="content-section-title"),
        Div("æ“ä½œå†å²åŠŸèƒ½å¼€å‘ä¸­...", cls="text-gray-500 text-center py-8"),
        cls="content-section"
    )
    
    content = Div(
        H1(f"è®¢å•è¯¦æƒ… - #{order['id']}", cls="page-title"),
        
        Div(
            # å·¦ä¾§ä¿¡æ¯åŒº
            Div(
                order_info_card,
                timeline_card,
                cls="space-y-6"
            ),
            
            # å³ä¾§æ“ä½œåŒº
            Div(
                user_info_card,
                merchant_info_card,
                cls="space-y-6"
            ),
            
            cls="grid grid-cols-1 lg:grid-cols-2 gap-8"
        ),
        
        # è¿”å›æŒ‰é’®
        Div(
            A("â† è¿”å›è®¢å•åˆ—è¡¨", href="/orders", cls="btn btn-outline"),
            cls="mt-8"
        )
    )
    
    return HTMLResponse(str(create_layout("è®¢å•è¯¦æƒ…", content)))

@require_auth
async def batch_operations(request: Request) -> Response:
    """æ‰¹é‡æ“ä½œå¤„ç†"""
    form = await request.form()
    action = form.get('action')
    order_ids = form.getlist('order_ids')
    
    if not order_ids:
        return RedirectResponse(url="/orders?error=no_selection", status_code=302)
    
    try:
        order_manager = OrderManager()
        success_count = 0
        
        for order_id in order_ids:
            if action == 'batch_complete':
                success = await order_manager.update_order_status(
                    int(order_id), ORDER_STATUS.COMPLETED.value)
            elif action == 'batch_cancel':
                success = await order_manager.delete_order(int(order_id))
            else:
                success = False
            
            if success:
                success_count += 1
        
        logger.info(f"æ‰¹é‡æ“ä½œ {action} å®Œæˆ: {success_count}/{len(order_ids)}")
        return RedirectResponse(
            url=f"/orders?batch_success={success_count}&batch_total={len(order_ids)}", 
            status_code=302)
        
    except Exception as e:
        logger.error(f"æ‰¹é‡æ“ä½œå¤±è´¥: {e}")
        return RedirectResponse(url="/orders?error=batch_failed", status_code=302)

@require_auth
async def export_orders(request: Request) -> Response:
    """å¯¼å‡ºè®¢å•æ•°æ®ä¸ºCSV"""
    try:
        # è·å–ç­›é€‰å‚æ•°
        query_params = {
            'status': request.query_params.get('status') or None,
            'merchant_id': int(request.query_params.get('merchant', 0)) or None,
            'user_id': int(request.query_params.get('user', 0)) or None,
            'date_from': request.query_params.get('date_from') or None,
            'date_to': request.query_params.get('date_to') or None,
            'limit': 10000  # å¯¼å‡ºé™åˆ¶
        }
        
        order_manager = OrderManager()
        orders = await order_manager.get_orders(**query_params)
        
        # åˆ›å»ºCSV
        output = io.StringIO()
        writer = csv.writer(output)
        
        # å†™å…¥è¡¨å¤´
        writer.writerow([
            'è®¢å•ID', 'ç”¨æˆ·ID', 'ç”¨æˆ·å', 'å•†æˆ·ID', 'å•†æˆ·å', 
            'é‡‘é¢', 'çŠ¶æ€', 'é¢„çº¦æ—¶é—´', 'å®Œæˆæ—¶é—´', 'åˆ›å»ºæ—¶é—´'
        ])
        
        # å†™å…¥æ•°æ®
        for order in orders:
            writer.writerow([
                order['id'],
                order['customer_user_id'], 
                order.get('customer_username', ''),
                order['merchant_id'],
                order.get('merchant_name', ''),
                order['price'],
                order['status'],
                order.get('appointment_time', ''),
                order.get('completion_time', ''),
                order['created_at']
            ])
        
        # å‡†å¤‡å“åº”
        output.seek(0)
        filename = f"orders_export_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        
        def generate():
            yield output.getvalue().encode('utf-8-sig')  # BOM for Excel
        
        return StreamingResponse(
            generate(),
            media_type="text/csv",
            headers={"Content-Disposition": f"attachment; filename={filename}"}
        )
        
    except Exception as e:
        logger.error(f"å¯¼å‡ºè®¢å•æ•°æ®å¤±è´¥: {e}")
        raise HTTPException(status_code=500, detail="å¯¼å‡ºå¤±è´¥")

@require_auth  
async def order_stats_api(request: Request) -> Response:
    """è®¢å•ç»Ÿè®¡API (ç”¨äºå®æ—¶æ›´æ–°)"""
    try:
        stats = await _get_order_statistics()
        return Response(
            content=json.dumps(stats),
            media_type="application/json"
        )
    except Exception as e:
        logger.error(f"è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: {e}")
        return Response(
            content=json.dumps({"error": "è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥"}),
            status_code=500,
            media_type="application/json"
        )

# å¯¼å‡ºè·¯ç”±åˆ—è¡¨
orders_v2_routes = [
    Route("/", orders_dashboard, methods=["GET"]),
    Route("/{id}/detail", order_detail_v2, methods=["GET"]),
    Route("/batch", batch_operations, methods=["POST"]),
    Route("/export", export_orders, methods=["GET"]),
    Route("/stats", order_stats_api, methods=["GET"]),
]
