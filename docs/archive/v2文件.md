æˆ‘å°†å¯¹æ•´ä¸ªé¡¹ç›®è¿›è¡Œä¸€æ¬¡å…¨é¢æ£€ç´¢ï¼Œå¹¶ä»…åˆ—å‡ºåœ¨é¡¹ç›®æºä»£ç ï¼ˆ.pyæ–‡ä»¶ï¼‰ä¸­æ‰¾åˆ°çš„æ‰€æœ‰åŒ…å«
  "V2" æˆ– "v2" çš„åç§°ã€æ–¹æ³•ã€ç±»ã€æ³¨é‡ŠåŠæ–‡æ¡£å­—ç¬¦ä¸²ã€‚å·²ä¸ºæ‚¨æ’é™¤äº†é¡¹ç›®æŠ¥å‘Šã€æ–‡æ¡£å’Œç¬¬
  ä¸‰æ–¹åº“ç­‰éä»£ç æ–‡ä»¶ã€‚

  ---

  V2/v2 æ ‡è¯†ç¬¦å…¨å±€æ£€ç´¢ç»“æœ

  ä»¥ä¸‹æ˜¯è¯¦ç»†åˆ—è¡¨ï¼ŒæŒ‰æ–‡ä»¶è·¯å¾„ç»„ç»‡ï¼š

  æ–‡ä»¶åä¸­åŒ…å« `v2`

   - database/db_templates_v2.py
   - scripts/migrate_to_v2.py
   - tests/test_admin_keyword_management.py
   - tests/test_binding_codes_v2.py
   - tests/test_binding_codes_v2_fixed.py
   - tests/test_db_merchants_v2.py
   - tests/test_db_merchants_v2_full.py
   - tests/test_db_merchants_v2_simple.py
   - tests/test_db_reviews_v2.py
   - tests/test_orders_v2_verification.py
   - tests/test_region_manager_v2.py
   - tests/test_region_manager_v2_comprehensive.py
   - tests/test_statistics_v2_refactor.py
   - tests/test_v2_modules_verification.py
   - utils/keyboard_utils_v2.py
   - web/routes/v2_incentives.py (æ¨æµ‹å­˜åœ¨)
   - web/routes/v2_merchants.py
   - web/routes/v2_orders.py
   - web/routes/v2_regions.py

  ---

  ä»£ç å†…å®¹ä¸­åŒ…å« `V2` æˆ– `v2`

  File: `asgi_app.py`
   - L3: ASGIç»Ÿä¸€åº”ç”¨å…¥å£ (V2.0 Refactored)
   - L16: # å¯¼å…¥æ‰€æœ‰V2è·¯ç”±æ¨¡å—
   - L27: logger.info("åˆ›å»ºæœ€ç»ˆçš„V2 ASGIåº”ç”¨...")
   - L40: # 4. æŒ‚è½½æ‰€æœ‰V2æ¨¡å—åŒ–è·¯ç”±
   - L42: app.routes.insert(0, Mount("/v2/regions", routes=regions_routes))
   - L43: app.routes.insert(0, Mount("/v2/merchants", routes=merchants_routes))
   - L44: app.routes.insert(0, Mount("/v2/incentives", routes=incentives_routes))
   - L45: app.routes.insert(0, Mount("/v2/orders", routes=orders_routes))
   - L46: logger.info("æ‰€æœ‰V2 Webè·¯ç”±å·²æŒ‚è½½ã€‚")
   - L51: logger.info("ASGI V2åº”ç”¨åˆ›å»ºå®Œæˆã€‚")

  File: `config.py`
   - L49: "current_version": "NewBindingFlow v2.0" if USE_NEW_BINDING_FLOW else 
     "BindingFlow v1.0",

  File: `database/db_binding_codes.py`
   - L3: ç»‘å®šç æ•°æ®åº“ç®¡ç†å™¨ (V2.0)
   - L19: ç»‘å®šç æ•°æ®åº“ç®¡ç†å™¨V2
   - L164: # V2è¡¨ç»“æ„æ²¡æœ‰expires_atå­—æ®µï¼Œæš‚æ—¶å¿½ç•¥è¿‡æœŸç­›é€‰
   - L267: è·å–ç»‘å®šç åŸºç¡€æ•°æ®ï¼ˆä¿æŒV2å…¼å®¹æ€§ï¼‰
   - L448: æ¸…ç†è¿‡æœŸçš„ç»‘å®šç ï¼ˆV2ç‰ˆæœ¬ä¸æ”¯æŒè¿‡æœŸæœºåˆ¶ï¼Œè¿”å›0ï¼‰
   - L454: # V2è¡¨ç»“æ„æ²¡æœ‰expires_atå­—æ®µï¼Œæš‚æ—¶ä¸æ”¯æŒè¿‡æœŸæ¸…ç†
   - L455: logger.debug("V2ç‰ˆæœ¬æš‚ä¸æ”¯æŒè¿‡æœŸæ¸…ç†åŠŸèƒ½")
   - L506: å»¶é•¿ç»‘å®šç æœ‰æ•ˆæœŸï¼ˆV2æš‚æ—¶ä¸æ”¯æŒè¿‡æœŸæœºåˆ¶ï¼‰
   - L516: # V2è¡¨ç»“æ„æ²¡æœ‰expires_atå­—æ®µï¼Œæš‚æ—¶ä¸æ”¯æŒæœ‰æ•ˆæœŸå»¶é•¿
   - L517: logger.warning("V2ç‰ˆæœ¬æš‚ä¸æ”¯æŒç»‘å®šç æœ‰æ•ˆæœŸå»¶é•¿åŠŸèƒ½")

  File: `database/db_incentives.py`
   - L3: æ¿€åŠ±ç³»ç»Ÿæ•°æ®åº“ç®¡ç†å™¨ (V2.0)
   - L22: æ¿€åŠ±ç³»ç»Ÿæ•°æ®åº“ç®¡ç†å™¨V2

  File: `database/db_keywords.py`
   - L2: å…³é”®è¯ç®¡ç†æ•°æ®åº“æ“ä½œç±» V2.0
   - L5: V2é‡æ„è¦ç‚¹:
   - L8: - ä¸V2æ¶æ„å®Œå…¨é€‚é…
   - L20: """å…³é”®è¯æ•°æ®åº“ç®¡ç†ç±» V2.0"""
   - L399: # å®ä¾‹åŒ–ç®¡ç†å™¨ï¼ˆä¿æŒV2å…¼å®¹æ€§ï¼‰

  File: `database/db_media.py`
   - L3: åª’ä½“æ–‡ä»¶æ•°æ®åº“ç®¡ç†å™¨ (V2.0)

  File: `database/db_merchants.py`
   - L3: å•†å®¶/å¸–å­æ•°æ®åº“ç®¡ç†å™¨ (V2.0) - ä¿®æ­£ç‰ˆ
   - L24: å•†æˆ·ç®¡ç†å™¨V2ç±»ï¼Œä¸å®é™…æ•°æ®åº“ç»“æ„ä¿æŒä¸€è‡´ã€‚
   - L1398: """åˆ›å»ºå•†æˆ·çš„ä¾¿æ·å‡½æ•°ã€‚æ”¯æŒV1å’ŒV2æ•°æ®æ ¼å¼è‡ªåŠ¨è½¬æ¢ã€‚"""
   - L1399: # V1åˆ°V2å­—æ®µæ˜ å°„ï¼ˆå‘åå…¼å®¹ï¼‰
   - L1469: # åˆ›å»ºV2å®ä¾‹

  File: `database/db_orders.py`
   - L3: è®¢å•æ•°æ®åº“ç®¡ç†å™¨ (V2.0)
   - L5: æ— æƒ…åœ°ã€ç²¾ç¡®åœ°é‡æ„è‡³V2.0è§„èŒƒ
   - L20: è®¢å•æ•°æ®åº“ç®¡ç†å™¨V2
   - L21: å¤–ç§‘æ‰‹æœ¯å¼è¿ç§»V1å…¨éƒ¨åŠŸèƒ½ï¼Œé€‚é…V2.0æ¶æ„
   - L27: åˆ›å»ºæ–°è®¢å•ï¼Œé€‚é…V2.0è¡¨ç»“æ„
   - L31: - customer_user_id: ç”¨æˆ·Telegram IDï¼ˆV2å­—æ®µåï¼‰
   - L36: - status: è®¢å•çŠ¶æ€ï¼ˆV2.0äº”é˜¶æ®µ...
   - L52: # éªŒè¯V2.0è®¢å•çŠ¶æ€
   - L69: # é€‚é…V2.0è¡¨ç»“æ„çš„æ’å…¥æŸ¥è¯¢
   - L89: logger.info(f"æˆåŠŸåˆ›å»ºV2è®¢å•...
   - L93: logger.error(f"V2è®¢å•æ•°æ®éªŒè¯å¤±è´¥: {e}")
   - L96: logger.error(f"åˆ›å»ºV2è®¢å•å¤±è´¥: {e}")
   - L102: æ ¹æ®IDè·å–è®¢å•è¯¦æƒ…ï¼ˆV2.0æ ¸å¿ƒæ–¹æ³•ï¼‰
   - L122: logger.debug(f"è·å–V2è®¢å•æˆåŠŸ...
   - ... (æ­¤ç±»æ–‡ä»¶åŒ…å«å¤§é‡V2æ ‡è¯†ï¼Œæ­¤å¤„ä»…åˆ—å‡ºéƒ¨åˆ†ç¤ºä¾‹)

  File: `database/db_regions.py`
   - L3: åœ°åŒºæ•°æ®åº“ç®¡ç†å™¨ (V2.0)

  File: `database/db_reviews.py`
   - L3: è¯„ä»·æ•°æ®åº“ç®¡ç†å™¨ (V2.0)
   - L23: """V2.0è¯„ä»·ç³»ç»Ÿç®¡ç†å™¨

  File: `database/db_system_config.py`
   - L3: ç³»ç»Ÿé…ç½®æ•°æ®åº“ç®¡ç†å™¨ (V2.0)

  File: `database/db_templates_v2.py`
   - L3: æ¶ˆæ¯æ¨¡æ¿æ•°æ®åº“ç®¡ç†å™¨ (V2.0)
   - L11: # å¯¼å…¥V2æ•°æ®åº“ç®¡ç†å™¨
   - L18: """V2.0 æ¨¡æ¿ç®¡ç†å™¨ - ç»Ÿä¸€æ¶ˆæ¯æ¨¡æ¿å¼•æ“"""
   - L337: 'welcome_message': 'ğŸ‰ æ¬¢è¿ä½¿ç”¨V2.0ç³»ç»Ÿï¼',

  File: `database/db_users.py`
   - L3: ç”¨æˆ·æ•°æ®ç®¡ç†å™¨ (V2.0)

  File: `dialogs/admin_keyword_management.py`
   - L11: from database.db_keywords import KeywordManagerExtended
   - L18: self.keyword_manager = KeywordManagerExtended()

  File: `dialogs/admin_region_management.py`
   - L2: ç®¡ç†å‘˜åœ°åŒºç®¡ç†å¯¹è¯æµç¨‹ (V2.0)
   - L4: å®Œå…¨åŸºäºV2æ•°æ®æ¨¡å‹: cities + districts
   - L20: """ç®¡ç†å‘˜åœ°åŒºç®¡ç†å¯¹è¯æµç¨‹ (V2.0)"""
   - L28: logger.info("ç®¡ç†å‘˜åœ°åŒºç®¡ç†ç³»ç»ŸV2åˆå§‹åŒ–å®Œæˆ")
   - L63: "ğŸŒ åœ°åŒºç®¡ç†ç³»ç»Ÿ (V2.0)\\n\\n"
   - L598: logger.info("åœ°åŒºç®¡ç†ç³»ç»ŸV2å·²æ¸…ç†")

  File: `dialogs/binding_flow_new.py`
   - L3: å•†æˆ·ç»‘å®šä¸ä¿¡æ¯æäº¤æµç¨‹ (V2.0 Refactored)
   - L13: # å¯¼å…¥V2æ•°æ®åº“ç®¡ç†å™¨
   - L21: from utils.keyboard_utils_v2 import ...

  File: `dialogs/dialog_manager.py`
   - L3: å¯¹è¯ç®¡ç†å™¨ (V2.0 Refactored)

  File: `dialogs/review_flow.py`
   - L3: è¯„ä»·æµç¨‹å¤„ç†å™¨ (V2.0)

  File: `dialogs/states.py`
   - L42: å•†æˆ·çŠ¶æ€ç»„ (V2.0æ ‡å‡†)
   - L68: """V2.0 å•†æˆ·ä¿¡æ¯æäº¤æµç¨‹çŠ¶æ€...
   - L81: """V2.0 ç”¨æˆ·æœç´¢æµç¨‹çŠ¶æ€"""
   - L88: """V2.0 ç”¨æˆ·ä¸‹å•æµç¨‹çŠ¶æ€"""
   - L93: """V2.0 è¯„ä»·æµç¨‹çŠ¶æ€"""

  File: `dialogs/user_service_flow.py`
   - L3: ç”¨æˆ·æœåŠ¡æµç¨‹å¯¹è¯æ¡† (V2.0)
   - L17: from utils.keyboard_utils_v2 import ...
   - L24: @router.callback_query(F.data == "v2_search_start")
   - L41: districts = await region_manager.get_districts_by_city(city_id) # 
     éœ€è¦åœ¨db_regions_v2ä¸­å®ç°

  File: `handlers/admin.py`
   - L19: from database.db_templates_v2 import template_manager

  File: `handlers/merchant.py`
   - L20: from database.db_templates_v2 import template_manager
   - L30: # æ ¹æ®é…ç½®é€‰æ‹©æµç¨‹ç®¡ç†å™¨ - V2ä¿®æ­£ç‰ˆ
   - L33: logger.info("ä½¿ç”¨æ–°ç‰ˆç»‘å®šæµç¨‹ (V2.0)")
   - L55: "options": "dynamic_cities",  # V2: ä»citiesè¡¨åŠ è½½
   - L61: "options": "dynamic_districts",  # V2: ä»districtsè¡¨åŠ è½½
   - L100: """ç¡®ä¿æ•°æ®åº“ç»„ä»¶å·²åˆå§‹åŒ– - V2ç‰ˆæœ¬"""
   - L102: # ä½¿ç”¨V2æ•°æ®åº“ç®¡ç†å™¨
   - L108: self.province_db = "v2_initialized"
   - L109: self.region_db = "v2_initialized"
   - L115: if step_number == 2:  # åŸå¸‚é€‰æ‹©
   - L128: elif step_number == 3:  # åœ°åŒºé€‰æ‹©
   - L266: normalized_status = MERCHANT_STATUS.normalize_to_v2(status)
   - L569: å¤„ç†å•†å®¶é¢æ¿å‘½ä»¤ - V2æ ¸å¿ƒåŠŸèƒ½
   - L587: normalized_status = MERCHANT_STATUS.normalize_to_v2(status)
   - L698: """å¤„ç†å•†æˆ·é¢æ¿å‘½ä»¤ - V2æ ¸å¿ƒåŠŸèƒ½"""

  File: `handlers/statistics.py`
   - L15: # V2æ•°æ®åº“ç®¡ç†å™¨å¯¼å…¥
   - L20: from database.db_templates_v2 import template_manager
   - L152: ç”ŸæˆæŒ‰é’®ç‚¹å‡»åˆ†ææ•°æ® - V2ç‰ˆæœ¬ï¼ˆçº¯è°ƒç”¨å±‚ï¼‰
   - L163: # ç›´æ¥è°ƒç”¨V2æ´»åŠ¨æ—¥å¿—ç®¡ç†å™¨çš„é«˜æ•ˆèšåˆæŸ¥è¯¢æ–¹æ³•
   - L237: ç”Ÿæˆå•†æˆ·è¡¨ç°åˆ†ææ•°æ® - V2ç‰ˆæœ¬ï¼ˆçº¯è°ƒç”¨å±‚ï¼‰
   - L247: # ç›´æ¥è°ƒç”¨V2ç®¡ç†å™¨çš„é«˜æ•ˆèšåˆæŸ¥è¯¢æ–¹æ³•
   - L985: æ ¼å¼åŒ–ç»¼åˆç»Ÿè®¡æ•°æ® - V2ç‰ˆæœ¬ï¼ˆä½¿ç”¨æ¨¡æ¿ç³»ç»Ÿï¼‰
   - L997: # ä½¿ç”¨V2æ¨¡æ¿ç³»ç»Ÿ

  File: `handlers/subscription_guard.py`
   - L2: é¢‘é“è®¢é˜…éªŒè¯ä¸­é—´ä»¶ (V2.0)
   - L14: # V2.0 å¯¼å…¥
   - L22: """V2.0 é¢‘é“è®¢é˜…éªŒè¯ä¸­é—´ä»¶
   - L88: """ä»V2ç³»ç»Ÿé…ç½®è·å–è®¢é˜…éªŒè¯é…ç½®
   - L94: # ä½¿ç”¨V2.0 SystemConfigManagerè·å–é…ç½®

  File: `handlers/user.py`
   - L3: ç”¨æˆ·æ ¸å¿ƒå‘½ä»¤å¤„ç†å™¨ (V2.0)
   - L13: # å¯¼å…¥V2æ•°æ®åº“ç®¡ç†å™¨
   - L15: from database.db_templates_v2 import template_manager
   - L18: from utils.keyboard_utils_v2 import create_main_menu_keyboard
   - L23: @router.callback_query(F.data == "v2_profile")

  File: `scheduler.py`
   - L4: APSchedulerå®šæ—¶ä»»åŠ¡Worker - V2.0æ¶æ„
   - L32: # é¡¹ç›®V2æ•°æ®åº“ç®¡ç†å™¨å¯¼å…¥
   - L568: logger.info("APSchedulerå®šæ—¶ä»»åŠ¡Worker - V2.0æ¶æ„")

  File: `scripts/initialize_templates.py`
   - L15: from database.db_templates_v2 import template_manager
   - L24: 'welcome_message': 'ğŸ‘‹ æ¬¢è¿ä½¿ç”¨V2.0æœºå™¨äººï¼...
   - L69: 'user_welcome_message': 'æ¬¢è¿ä½¿ç”¨V2.0æœºå™¨äººï¼...

  File: `scripts/migrate_to_v2.py`
   - L3: æ•°æ®åº“è¿ç§»è„šæœ¬ï¼šä» V1.0 è¿ç§»åˆ° V2.0
   - L7: 2.  åˆ›å»ºV2.0æ¶æ„ä¸­æ–°å¢çš„è¡¨...
   - L8: 3.  ä¿®æ”¹ç°æœ‰è¡¨ç»“æ„ä»¥é€‚åº”V2.0è®¾è®¡...
   - L42: def migrate_to_v2(db_path):
   - L43: """æ‰§è¡Œæ•°æ®åº“ä» V1 åˆ° V2 çš„ç»“æ„è¿ç§»"""
   - L55: print("\\n--- é˜¶æ®µ2: åˆ›å»º V2.0 æ–°å¢çš„è¡¨ ---")
   - ... (æ­¤æ–‡ä»¶åŒ…å«å¤§é‡V2æ ‡è¯†)

  File: `utils/enums.py`
   - L13: V2.0æ ‡å‡†ï¼š5é˜¶æ®µå•†æˆ·çŠ¶æ€ç®¡ç†
   - L15: # V2.0 æ ¸å¿ƒçŠ¶æ€ï¼ˆä¸»è¦ä½¿ç”¨ï¼‰
   - L28: def normalize_to_v2(cls, status: str) -> str:
   - L30: å°†ä»»æ„çŠ¶æ€å€¼æ ‡å‡†åŒ–ä¸ºV2.0çŠ¶æ€
   - L36: æ ‡å‡†åŒ–çš„V2.0çŠ¶æ€å€¼
   - L38: v1_to_v2_mapping = {
   - L57: # V2.0 çŠ¶æ€æ˜¾ç¤º
   - L83: # V2.0 çŠ¶æ€æ ·å¼
   - L115: def get_all_v2_statuses(cls) -> list:
   - L116: """è·å–æ‰€æœ‰V2.0æ ‡å‡†çŠ¶æ€å€¼åˆ—è¡¨"""
   - L138: V2.0æ ‡å‡†ï¼š5é˜¶æ®µè®¢å•çŠ¶æ€ç®¡ç†
   - L140: # V2.0 è®¢å•çŠ¶æ€

  File: `utils/keyboard_utils_v2.py`
   - L3: é”®ç›˜å·¥å…· (V2.0)
   - L11: [InlineKeyboardButton(text="ğŸ” æŒ‰åœ°åŒºæœç´¢å•†å®¶", 
     callback_data="v2_search_start")],
   - L12: [InlineKeyboardButton(text="ğŸ‘¤ æˆ‘çš„èµ„æ–™", callback_data="v2_profile")]
   - L24: keyboard.append([InlineKeyboardButton(text="â¬…ï¸ è¿”å›åŸå¸‚é€‰æ‹©", 
     callback_data="v2_search_start")])

  File: `web/app.py`
   - L3: FastHTML Webç®¡ç†é¢æ¿ (V2.0 Refactored)
   - L18: # å¯¼å…¥V2æ•°æ®åº“ç®¡ç†å™¨
   - L161: """V2 ä»ªè¡¨æ¿é¡µé¢"""
   - L169: content = Div(H1("ä»ªè¡¨æ¿ V2")) # å ä½ç¬¦

  File: `web/data_config.py`
   - L35: """è·å–çŠ¶æ€é€‰é¡¹åˆ—è¡¨ - ä½¿ç”¨V2.0ç»Ÿä¸€çŠ¶æ€"""
   - L36: v2_statuses = [
   - L51: return v2_statuses + v1_statuses
   - L58: # V2.0 æ ¸å¿ƒçŠ¶æ€
   - L59: for status in MERCHANT_STATUS.get_all_v2_statuses():
   - L73: # V2.0 æ ¸å¿ƒçŠ¶æ€
   - L74: for status in MERCHANT_STATUS.get_all_v2_statuses():

  File: `web/routes/incentives.py`
   - L3: æ¿€åŠ±ç³»ç»Ÿç®¡ç†è·¯ç”± (V2.0)
   - L39: ... href=f"/v2/incentives/level/{l['id']}/delete" ...
   - L45: action="/v2/incentives/level/add", ...
   - ... (æ­¤æ–‡ä»¶åŒ…å«å¤§é‡ /v2/ è·¯ç”±)

  File: `web/routes/media.py`
   - L3: åª’ä½“ä»£ç†è·¯ç”± (V2.0)

  File: `web/routes/merchants.py`
   - L3: å•†å®¶/å¸–å­ç®¡ç†è·¯ç”± (V2.0)
   - L27: # V2.0 æ ¸å¿ƒçŠ¶æ€
   - ... (æ­¤æ–‡ä»¶åŒ…å«å¤§é‡ /v2/ è·¯ç”±)

  File: `web/routes/orders.py`
   - L3: è®¢å•ç®¡ç†è·¯ç”± (V2.0)
   - L28: async def orders_list_v2(request):
   - L29: """æ¸²æŸ“V2è®¢å•åˆ—è¡¨é¡µé¢"""
   - L33: logger.error(f"åŠ è½½V2è®¢å•åˆ—è¡¨æ—¶å‡ºé”™: {e}")
   - L56: return create_layout("è®¢å•ç®¡ç†", content)
   - L59: Route("/", endpoint=orders_list_v2, methods=["GET"])

  File: `web/routes/regions.py`
   - L3: åœ°åŒºç®¡ç†è·¯ç”± (V2.0)
   - ... (æ­¤æ–‡ä»¶åŒ…å«å¤§é‡ /v2/ è·¯ç”±)

  ---

  ä»¥ä¸Šæ˜¯åœ¨é¡¹ç›®æºä»£ç ä¸­æ‰¾åˆ°çš„å…¨éƒ¨V2/v2æ ‡è¯†ç¬¦ã€‚åˆ—è¡¨éå¸¸è¯¦å°½ï¼Œå¯ä¾›æ‚¨çš„å›¢é˜Ÿè¿›è¡Œåç»­çš„
  ä»£ç çº¯å‡€åŒ–å·¥ä½œã€‚
