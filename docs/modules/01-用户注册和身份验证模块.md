# 用户注册与身份验证模块技术文档 (V2.0)

## 🚨 身份验证统一标准 (引用绑定码模块)

### 商户身份验证方法
```python
# ✅ 商户身份检查标准
from database.db_merchants import merchants_manager

async def is_merchant(telegram_chat_id):
    """检查用户是否为已绑定商户"""
    merchant = await merchants_manager.get_merchant_by_telegram_id(telegram_chat_id)
    return merchant is not None

# 获取商户永久ID
async def get_merchant_id(telegram_chat_id):
    """通过TG ID获取商户永久ID"""
    merchant = await merchants_manager.get_merchant_by_telegram_id(telegram_chat_id)
    return merchant['id'] if merchant else None
```

### 绑定流程权限验证
```python
# 绑定码验证标准 (引用03-商家绑定模块方法)
from database.db_binding_codes import binding_codes_manager

async def validate_binding_code(code):
    """验证绑定码有效性"""
    binding_info = await binding_codes_manager.get_binding_code_info(code)
    return binding_info and not binding_info.get('is_used')
```

---

## 模块概述

本模块是整个系统的基础，负责定义和验证所有与机器人交互的用户的身份与权限。在V2.0架构中，它的核心是**识别用户属于哪个角色（管理员、商户、普通用户）**，并为商户角色提供了**从临时访客到永久身份的绑定机制**。

### 业务价值
- **明确角色划分**: 清晰地定义了管理员、商户和普通用户三种角色及其权限边界。
- **建立商户身份**: 通过绑定码，将一个临时的Telegram用户与系统内的一个永久商户ID进行绑定。
- **保障系统安全**: 基于角色的权限控制，确保敏感操作只能由授权用户执行。

---

## 权限体系设计

系统通过检查用户的Telegram ID来动态判断其角色。

### 1. 管理员 (Admin)
- **识别方式**: 用户的Telegram ID存在于系统配置的 `ADMIN_IDS` 列表中。
- **核心权限**: 
    - 访问Web管理后台所有功能。
    - 在Bot中执行超级管理命令（如生成绑定码）。
    - 不受任何业务流程限制（如强制订阅等）。

### 2. 商户 (Merchant)
- **识别方式**: 用户的Telegram ID存在于 `merchants` 表的 `telegram_chat_id` 字段中。这意味着该用户已经成功通过绑定码与一个永久商户ID建立了关联。
- **核心权限**:
    - 首次绑定后，触发信息收集流程。
    - 绑定后，发送 `/start` 并点击“我的资料”即可查看与管理自己的商户资料。
    - 接收属于自己的新订单通知。
    - （未来）管理自己的帖子、活动等。

### 3. 普通用户 (Normal User)
- **识别方式**: 任何非管理员、也未在 `merchants` 表中注册的Telegram用户。
- **核心权限**:
    - 浏览已发布的商户推广帖子。
    - 与机器人交互，进行服务预约并生成订单。
    - 使用 `/profile` 命令查看自己的等级、积分和勋章。

---

## 数据库设计

本模块的权限判断与身份绑定功能，强依赖于以下数据表：

### 1. `merchants` (商家/老师信息表)
此表是判断一个用户是否为“商户”角色的关键。
```sql
CREATE TABLE merchants (
    id INTEGER PRIMARY KEY AUTOINCREMENT,      -- 永久唯一ID
    telegram_chat_id BIGINT NOT NULL UNIQUE,   -- 绑定的TG账号ID, 用于身份识别
    -- ... 其他商户信息字段
    status TEXT NOT NULL DEFAULT 'pending_submission'
);
```

### 2. `binding_codes` (绑定码表)
此表用于一次性的身份验证，是将一个普通用户转变为商户角色的“门票”。
```sql
CREATE TABLE binding_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code TEXT UNIQUE NOT NULL,                 -- 唯一的绑定码字符串
    is_used BOOLEAN DEFAULT FALSE,             -- 是否已被使用
    merchant_id INTEGER,                       -- **V2.0统一字段**: 关联到使用的 merchants.id
    used_at DATETIME,                          -- 绑定时间
    bound_telegram_username TEXT,              -- 绑定者的TG用户名
    bound_telegram_name TEXT,                  -- 绑定者的TG名称
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

## 核心业务流程：商户身份绑定

这是本模块最核心的业务流程，它将一个普通用户提升为商户角色。

```mermaid
graph TD
    A[用户向Bot发送 /bind <绑定码>] --> B{后台服务};
    B --> C{绑定码有效且未使用?};
    C -->|否| D[回复"绑定码无效"];
    C -->|是| E{该TG账号是否已绑定?};
    E -->|是| F[回复"账号已绑定"];
    E -->|否| G[创建永久商户记录];
    G --> H[更新绑定码为"已使用"];
    H --> I[回复"绑定成功, 开始填写资料"];
```

**流程详解**:
1.  **触发**: 用户向机器人发送 `/bind <绑定码>`。
2.  **验证绑定码**: 系统查询 `binding_codes` 表，确认码有效且 `is_used` 为 `false`。
3.  **验证用户唯一性**: 系统查询 `merchants` 表，确认该用户的 `telegram_chat_id` 没有绑定过任何商户。
4.  **创建身份**: 在 `merchants` 表中创建一条新记录，获得一个全新的、永久的 `id`，并存入用户的 `telegram_chat_id`。
5.  **更新绑定码**: 将 `binding_codes` 表中对应的码标记为 `is_used = true`，并记录是被哪个新创建的 `merchant_id` 使用的。
6.  **启动后续流程**: 向用户发送成功消息，并启动信息收集流程（由“商家绑定与信息收集模块”接管）。
