# å•†å®¶ç»‘å®šä¸ä¿¡æ¯æ”¶é›†æ¨¡å—æŠ€æœ¯æ–‡æ¡£ (V2.0)

## ğŸš¨ æ ¸å¿ƒç»‘å®šç æ–¹æ³•æ ‡å‡† (V2.0å”¯ä¸€æ¥å£)

### ç»Ÿä¸€è°ƒç”¨æ–¹æ³• - æ‰€æœ‰æ¨¡å—å¿…é¡»éµå¾ª
```python
# âœ… å”¯ä¸€æ­£ç¡®çš„ç»‘å®šç æ“ä½œæ–¹æ³•
from database.db_binding_codes import binding_codes_manager

# è·å–ç»‘å®šç ä¿¡æ¯
binding_info = await binding_codes_manager.get_binding_code_info(code)

# è·å–æ‰€æœ‰ç»‘å®šç 
all_codes = await binding_codes_manager.get_all_binding_codes()

# ä½¿ç”¨ç»‘å®šç 
await binding_codes_manager.use_binding_code(code, merchant_id, user_id)

# åˆ é™¤ç»‘å®šç 
await binding_codes_manager.delete_binding_code(code)
```

### ğŸ¯ å¼ºåˆ¶æ ‡å‡†
- **å”¯ä¸€ç®¡ç†å™¨**: åªèƒ½ä½¿ç”¨ `binding_codes_manager`
- **ç»Ÿä¸€å­—æ®µ**: å…¨é“¾è·¯ä½¿ç”¨ `merchant_id` å­—æ®µ
- **å­—ç¬¦ä¸²å‚æ•°**: è·¯ç”±ä½¿ç”¨ `{code}` å­—ç¬¦ä¸²ç±»å‹
- **ç¦æ­¢Serviceå±‚**: ç›´æ¥ Route â†’ DB Manager

---

## æ¨¡å—æ¦‚è¿°

æœ¬æ¨¡å—æ˜¯å•†æˆ·è¿›å…¥ç³»ç»Ÿçš„**ç¬¬ä¸€ä¸ªæ ¸å¿ƒç¯èŠ‚**ï¼Œè´Ÿè´£å¤„ç†æ–°å•†æˆ·çš„èº«ä»½ç»‘å®šã€ä¿¡æ¯æ”¶é›†å’Œæäº¤å®¡æ‰¹ã€‚å®ƒå–ä»£äº†æ—§çš„å›ºå®šæ­¥éª¤æµç¨‹ï¼Œé‡‡ç”¨æ›´çµæ´»çš„å¯¹è¯å¼äº¤äº’ï¼Œæœ€ç»ˆç›®æ ‡æ˜¯ç”Ÿæˆä¸€ä¸ªä¿¡æ¯å®Œæ•´ã€å¾…ç®¡ç†å‘˜å®¡æ‰¹çš„å¸–å­è®°å½•ã€‚

### ä¸šåŠ¡ä»·å€¼
- **å»ºç«‹æ°¸ä¹…èº«ä»½**: é€šè¿‡ç»‘å®šç ä¸ºå•†æˆ·åˆ›å»ºä¸Telegramè´¦å·è§£è€¦çš„æ°¸ä¹…å¹³å°IDã€‚
- **è‡ªåŠ¨åŒ–ä¿¡æ¯æ”¶é›†**: é€šè¿‡æœºå™¨äººå¼•å¯¼ï¼Œè‡ªåŠ¨ã€å®Œæ•´åœ°æ”¶é›†ä¸Šæ¦œæ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯ï¼ˆæ–‡æœ¬ã€åª’ä½“æ–‡ä»¶ç­‰ï¼‰ã€‚
- **è¿æ¥å®¡æ‰¹æµç¨‹**: å°†å•†æˆ·æäº¤çš„å®Œæ•´ä¿¡æ¯æ‰“åŒ…ï¼Œå¹¶ç½®ä¸ºâ€œå¾…å®¡æ‰¹â€çŠ¶æ€ï¼Œæ— ç¼å¯¹æ¥Webåå°çš„ç®¡ç†å‘˜å®¡æ ¸å·¥ä½œæµã€‚

---

## æ•°æ®åº“è®¾è®¡

æœ¬æ¨¡å—ä¾èµ–ä»¥ä¸‹æ ¸å¿ƒæ•°æ®è¡¨æ¥å®Œæˆå…¶åŠŸèƒ½ã€‚

### 1. `merchants` (å•†å®¶/è€å¸ˆä¿¡æ¯è¡¨)
```sql
CREATE TABLE merchants (
    id INTEGER PRIMARY KEY AUTOINCREMENT,      -- æ°¸ä¹…å”¯ä¸€ID, è‡ªåŠ¨å¢é•¿
    telegram_chat_id BIGINT NOT NULL,          -- å½“å‰ç»‘å®šçš„TGè´¦å·ID, å¯ä¿®æ”¹
    name TEXT,                                 -- å•†å®¶/è€å¸ˆåç§°
    username TEXT,                             -- TGç”¨æˆ·å (@handle)
    district_id INTEGER,                       -- åœ°åŒºID (å…³è”åˆ°districtsè¡¨)
    price_1 INTEGER,                           -- ä»·æ ¼1
    price_2 INTEGER,                           -- ä»·æ ¼2
    advantages TEXT,                           -- ä¼˜ç‚¹æè¿°
    disadvantages TEXT,                        -- ç¼ºç‚¹æè¿°
    basic_skills TEXT,                         -- è‡ªå¡«åŸºæœ¬åŠŸ
    status TEXT NOT NULL DEFAULT 'pending_submission', -- å¸–å­çŠ¶æ€
    publish_time DATETIME,                     -- æœŸæœ›å‘å¸ƒæ—¶é—´
    expiration_time DATETIME,                  -- å¸–å­åˆ°æœŸæ—¶é—´
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 2. `media` (åª’ä½“æ–‡ä»¶è¡¨)
```sql
CREATE TABLE media (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    merchant_id INTEGER NOT NULL,              -- å…³è”åˆ° merchants.id
    telegram_file_id TEXT NOT NULL,            -- Telegramæ–‡ä»¶çš„å”¯ä¸€ID
    media_type TEXT NOT NULL,                  -- æ–‡ä»¶ç±»å‹: 'photo' æˆ– 'video'
    sort_order INTEGER DEFAULT 0,              -- åª’ä½“æ–‡ä»¶æ’åº
    FOREIGN KEY (merchant_id) REFERENCES merchants(id) ON DELETE CASCADE
);
```

### 3. `binding_codes` (ç»‘å®šç è¡¨) - **V2.0 ç»Ÿä¸€å­—æ®µæ ‡å‡†**
```sql
CREATE TABLE binding_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code TEXT UNIQUE NOT NULL,                 -- å”¯ä¸€çš„ç»‘å®šç å­—ç¬¦ä¸²
    is_used BOOLEAN DEFAULT FALSE,             -- æ˜¯å¦å·²è¢«ä½¿ç”¨
    merchant_id INTEGER,                       -- **ç»Ÿä¸€å­—æ®µ**: å…³è”åˆ°ä½¿ç”¨çš„ merchants.id
    used_at DATETIME,                          -- ç»‘å®šæ—¶é—´
    bound_telegram_username TEXT,              -- ç»‘å®šè€…çš„TGç”¨æˆ·å
    bound_telegram_name TEXT,                  -- ç»‘å®šè€…çš„TGåç§°
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP,                      -- ç»‘å®šç è¿‡æœŸæ—¶é—´
    FOREIGN KEY (merchant_id) REFERENCES merchants(id) ON DELETE SET NULL
);
```

**é‡è¦**: V2.0 æ¶æ„ä½¿ç”¨ç»Ÿä¸€çš„ `merchant_id` å­—æ®µï¼Œ**ä¸å†ä½¿ç”¨** `used_by_merchant_id`ã€‚

---

## æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

### 1. ç»‘å®šç éªŒè¯ä¸æ°¸ä¹…IDåˆ›å»º

è¿™æ˜¯å•†æˆ·ä¸ç³»ç»Ÿå»ºç«‹è¿æ¥çš„ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡ `/bind` å‘½ä»¤è§¦å‘ã€‚

```python
# ä¼ªä»£ç é€»è¾‘ - V2.0 ç»Ÿä¸€æ¥å£
async def handle_bind_command(message: Message, code: str):
    # 1. æ£€æŸ¥ç»‘å®šç æ˜¯å¦å­˜åœ¨ä¸”æœªä½¿ç”¨ - ä½¿ç”¨ç»Ÿä¸€å­—æ®µ
    binding_data = await binding_codes_manager.get_binding_code_info(code)
    if not binding_data or binding_data.get('is_used'):
        await message.answer("ç»‘å®šç æ— æ•ˆæˆ–å·²è¢«ä½¿ç”¨ã€‚")
        return

    # 2. æ£€æŸ¥è¯¥TGç”¨æˆ·æ˜¯å¦å·²ç»‘å®šè¿‡
    user_id = message.from_user.id
    existing_merchant = await merchants_manager.get_merchant_by_telegram_id(user_id)
    if existing_merchant:
        await message.answer(f"æ‚¨çš„è´¦å·å·²ç»‘å®šåˆ°å•†æˆ·ID: {existing_merchant['id']}")
        return

    # 3. åˆ›å»ºæ°¸ä¹…å•†æˆ·è®°å½•
    new_merchant = await merchants_manager.create_merchant(telegram_chat_id=user_id, status='pending_submission')
    permanent_id = new_merchant['id']

    # 4. æ›´æ–°ç»‘å®šç çŠ¶æ€ - ä½¿ç”¨ç»Ÿä¸€å­—æ®µ merchant_id
    await binding_codes_manager.use_binding_code(code, permanent_id, user_id)

    # 5. å¯åŠ¨ä¿¡æ¯æ”¶é›†æµç¨‹
    await message.answer(f"ç»‘å®šæˆåŠŸï¼æ‚¨çš„æ°¸ä¹…å•†æˆ·IDæ˜¯ {permanent_id}ã€‚ç°åœ¨å¼€å§‹å¡«å†™èµ„æ–™...")
    await start_information_collection(user_id, permanent_id)
```

### 2. è‡ªåŠ¨åŒ–ä¿¡æ¯æ”¶é›†

ç»‘å®šæˆåŠŸåï¼Œç³»ç»Ÿé€šè¿‡FSMï¼ˆæœ‰é™çŠ¶æ€æœºï¼‰è¿›å…¥ä¸€ä¸ªå¯¹è¯å¼çš„æ”¶é›†æµç¨‹ï¼Œå¼•å¯¼å•†æˆ·é€é¡¹æä¾›ä¿¡æ¯ã€‚

- **æµç¨‹ç®¡ç†**: ä½¿ç”¨`aiogram`çš„FSMContextæ¥è·Ÿè¸ªæ¯ä¸ªç”¨æˆ·ï¼ˆå•†æˆ·ï¼‰å½“å‰æ­£åœ¨å¡«å†™çš„å­—æ®µã€‚
- **æ–‡æœ¬ä¿¡æ¯**: æœºå™¨äººä¾æ¬¡è¯¢é—®â€œåç§°â€ã€â€œä»·æ ¼1â€ã€â€œä¼˜ç‚¹â€ç­‰ï¼Œå•†æˆ·ç›´æ¥åœ¨èŠå¤©ä¸­å›å¤å³å¯ã€‚
- **é€‰æ‹©é¡¹**: å¯¹äºâ€œåœ°åŒºâ€ç­‰ä¿¡æ¯ï¼Œæœºå™¨äººå‘é€å¸¦æœ‰é€‰é¡¹çš„å†…è”é”®ç›˜ä¾›å•†æˆ·é€‰æ‹©ã€‚
- **åª’ä½“æ–‡ä»¶**: å½“éœ€è¦ä¸Šä¼ å›¾ç‰‡/è§†é¢‘æ—¶ï¼Œæœºå™¨äººä¼šæç¤ºâ€œè¯·ç›´æ¥å‘é€æœ€å¤š6å¼ å›¾ç‰‡æˆ–è§†é¢‘ç»™æˆ‘â€ã€‚
    - **åå°å¤„ç†**: Botä¼šç›‘å¬ç”¨æˆ·å‘é€çš„åª’ä½“æ–‡ä»¶ï¼Œå¹¶ä»…ä¿å­˜å…¶`telegram_file_id`åˆ°`media`è¡¨ã€‚Webåå°éœ€è¦å±•ç¤ºè¿™äº›åª’ä½“æ–‡ä»¶æ—¶ï¼Œå°†é€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„â€œä»£ç†â€è·¯ç”±ï¼Œç”±æœåŠ¡å™¨å®æ—¶ç”¨Botèº«ä»½ä»Telegramä¸‹è½½å¹¶å±•ç¤ºï¼Œæ— éœ€è½¬å­˜åˆ°å¤–éƒ¨äº‘å­˜å‚¨ã€‚
- **å®Œæˆä¸æäº¤**: å½“æ‰€æœ‰å¿…éœ€ä¿¡æ¯éƒ½æ”¶é›†å®Œæ¯•åï¼Œæœºå™¨äººä¼šå‘å•†æˆ·å±•ç¤ºä¸€ä¸ªæœ€ç»ˆç¡®è®¤ä¿¡æ¯ï¼Œå•†æˆ·ç‚¹å‡»â€œç¡®è®¤æäº¤â€åï¼Œç³»ç»Ÿä¼šå°†`merchants`è¡¨ä¸­å¯¹åº”è®°å½•çš„`status`å­—æ®µæ›´æ–°ä¸º `pending_approval`ã€‚

---

## Webç®¡ç†åå°æ¥å£ - **V2.0 å”¯ä¸€æ¥å£æ ‡å‡†**

### ç»‘å®šç ç®¡ç†æ¥å£

**å”¯ä¸€è°ƒç”¨é“¾è·¯**: Route â†’ DB Managerï¼ˆæ— Serviceå±‚å†—ä½™ï¼‰

#### 1. ç»‘å®šç åˆ—è¡¨
- **è·¯ç”±**: `GET /binding-codes`
- **å‡½æ•°**: `binding_codes_list(request: Request)`
- **æ•°æ®æº**: `binding_codes_manager.get_all_binding_codes()`
- **ç»Ÿä¸€å­—æ®µ**: ä½¿ç”¨ `merchant_id` æ˜¾ç¤ºç»‘å®šå•†æˆ·ä¿¡æ¯

#### 2. ç»‘å®šç è¯¦æƒ…
- **è·¯ç”±**: `GET /binding-codes/{code}/detail`
- **å‡½æ•°**: `binding_code_detail(request: Request)`
- **å‚æ•°ç±»å‹**: `code` (string) - **ä¸å†ä½¿ç”¨** `{code_id:int}`
- **æ•°æ®æº**: `binding_codes_manager.get_binding_code_info(code)`

#### 3. ç»‘å®šç ç”Ÿæˆ
- **è·¯ç”±**: `GET /binding-codes/generate`
- **è·¯ç”±**: `POST /binding-codes/generate`
- **å‡½æ•°**: `binding_codes_generate_page()` / `binding_codes_generate_action()`

#### 4. ç»‘å®šç åˆ é™¤
- **è·¯ç”±**: `POST /binding-codes/{code}/delete`
- **å‡½æ•°**: `binding_code_delete(request: Request)`
- **å‚æ•°å¤„ç†**: é€šè¿‡ `request.path_params.get("code")` è·å–å­—ç¬¦ä¸²å‚æ•°

#### 5. ç»‘å®šç å¯¼å‡º
- **è·¯ç”±**: `GET /binding-codes/export`
- **å‡½æ•°**: `binding_codes_export(request: Request)`
- **å¯¼å‡ºå­—æ®µ**: ç»Ÿä¸€ä½¿ç”¨ `merchant_id` åˆ—åï¼ˆæ—  `used_by_merchant_id` æ®‹ç•™ï¼‰

---

## å®é™…åŠŸèƒ½æ€»ç»“ (V2.0)

### æ ¸å¿ƒåŠŸèƒ½ç‰¹ç‚¹
- âœ… **æ°¸ä¹…IDåˆ›å»º**: é€šè¿‡ç»‘å®šç ï¼Œä¸ºå•†æˆ·å»ºç«‹ä¸€ä¸ªç¨³å›ºçš„ã€ç‹¬ç«‹äºTGè´¦å·çš„èº«ä»½IDã€‚
- âœ… **å¯¹è¯å¼ä¿¡æ¯æ”¶é›†**: é‡‡ç”¨çµæ´»çš„FSMçŠ¶æ€æœºå¼•å¯¼ç”¨æˆ·å®Œæˆèµ„æ–™å¡«å†™ï¼Œä½“éªŒæµç•…ã€‚
- âœ… **åª’ä½“æ–‡ä»¶å¤„ç†**: æ”¯æŒæ¥æ”¶ç”¨æˆ·å‘é€çš„å›¾ç‰‡å’Œè§†é¢‘ï¼Œå¹¶ä¿å­˜å…¶Telegramæ–‡ä»¶IDç”¨äºåç»­å‘å¸ƒã€‚
- âœ… **æäº¤å¾…å®¡**: æ”¶é›†å®Œæˆåï¼Œè‡ªåŠ¨å°†å¸–å­çŠ¶æ€ç½®ä¸º`pending_approval`ï¼Œå¯åŠ¨ç®¡ç†å‘˜å®¡æ ¸æµç¨‹ã€‚

### æŠ€æœ¯ç‰¹ç‚¹ - **V2.0 æ¶æ„æ ‡å‡†**
- âœ… **FSMçŠ¶æ€æœº**: ç²¾å‡†ç®¡ç†æ¯ä¸ªå•†æˆ·çš„ä¿¡æ¯æ”¶é›†è¿›åº¦ã€‚
- âœ… **æ•°æ®è§£è€¦**: æ ¸å¿ƒæ•°æ®è¡¨è®¾è®¡æ¸…æ™°ï¼Œ`merchants`è¡¨ä¸`media`è¡¨é€šè¿‡å¤–é”®å…³è”ã€‚
- âœ… **å¼‚æ­¥æ•°æ®åº“æ“ä½œ**: æ‰€æœ‰æ•°æ®åº“äº¤äº’å‡ä¸ºå¼‚æ­¥ï¼Œä¿è¯æœºå™¨äººå“åº”æ€§èƒ½ã€‚
- âœ… **å”¯ä¸€æ¥å£æ ‡å‡†**: Route â†’ DB Manager å•ä¸€è°ƒç”¨é“¾è·¯ï¼Œæ— Serviceå±‚å†—ä½™ã€‚
- âœ… **ç»Ÿä¸€å­—æ®µå‘½å**: å…¨é“¾è·¯ä½¿ç”¨ `merchant_id` å­—æ®µï¼Œä¸æ•°æ®åº“schemaç²¾ç¡®åŒ¹é…ã€‚
- âœ… **å­—ç¬¦ä¸²å‚æ•°**: è·¯ç”±å‚æ•°ç»Ÿä¸€ä½¿ç”¨ `{code}` å­—ç¬¦ä¸²ç±»å‹ï¼Œä¸å†æœ‰ç±»å‹è½¬æ¢é”™è¯¯ã€‚

### æ¶æ„å…¼å®¹æ€§
- âœ… **è¿‡æœŸæ–‡ä»¶éš”ç¦»**: `binding_mgmt_service.py.old` å·²æ ‡è®°ä¸ºè¿‡æœŸï¼Œé¿å…æ¥å£å†²çªã€‚
- âœ… **å”¯ä¸€è£…é…ç‚¹**: æ‰€æœ‰è·¯ç”±åœ¨ `web/app.py` ä¸­ç›´æ¥æ³¨å†Œï¼Œæ— é‡å¤è£…é…é£é™©ã€‚
- âœ… **ä»£ç çº¯å‡€åº¦**: åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„å¯¼å…¥å’Œå‡½æ•°ï¼Œä¿æŒæ¶æ„æ¸…æ™°ã€‚

---

## å¼€å‘æ³¨æ„äº‹é¡¹

### å¿…é¡»éµå¾ªçš„æ ‡å‡†
1. **å­—æ®µå‘½å**: ç»Ÿä¸€ä½¿ç”¨ `merchant_id`ï¼Œç¦ç”¨ `used_by_merchant_id`
2. **å‚æ•°ç±»å‹**: è·¯ç”±å‚æ•°ä½¿ç”¨å­—ç¬¦ä¸² `{code}`ï¼Œç¦ç”¨ `{code_id:int}`
3. **è°ƒç”¨é“¾è·¯**: åªèƒ½é€šè¿‡ `binding_codes_manager` è°ƒç”¨æ•°æ®åº“ï¼Œç¦ç”¨Serviceå±‚
4. **é”™è¯¯å¤„ç†**: ä½¿ç”¨ `request.path_params.get("code")` å®‰å…¨è·å–å‚æ•°

### ç¦æ­¢æ“ä½œ
- âŒ ä¸å¾—ä½¿ç”¨ `used_by_merchant_id` å­—æ®µå
- âŒ ä¸å¾—åˆ›å»ºæ–°çš„Serviceå±‚ï¼ˆå·²æœ‰.oldæ–‡ä»¶æ ‡è®°ï¼‰
- âŒ ä¸å¾—ä½¿ç”¨ `{code_id:int}` è·¯ç”±å‚æ•°
- âŒ ä¸å¾—åœ¨ `web/routes/__init__.py` ä¸­æ·»åŠ  `register_routes` å‡½æ•°

è¿™äº›æ ‡å‡†ç¡®ä¿ç³»ç»Ÿç»´æŒ"å”¯ä¸€æ–¹æ³•ã€å”¯ä¸€æ¥å£ã€ä¸æ•°æ®åº“ç²¾å‡†åŒ¹é…ã€æ— å†—ä½™"çš„æ¶æ„åŸåˆ™ã€‚
