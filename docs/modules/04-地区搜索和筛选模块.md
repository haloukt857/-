# 地区搜索和筛选模块技术文档 (V2.0)

## 模块概述

地区搜索和筛选模块是为普通用户提供的一种发现商户的方式。它通过“城市 -> 地区 -> 商户列表”的导航，帮助用户找到在特定地理位置提供服务的、**已发布**的商户。

### 业务价值
- 提供按地理位置发现商户的渠道。
- 补充了频道推广之外的另一种商户曝光方式。
- 增强了平台作为服务发现工具的价值。

---

## 数据库设计
(V2.0中无变化)

### 1. cities 城市表
```sql
CREATE TABLE IF NOT EXISTS cities (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. districts 地区表
```sql
CREATE TABLE IF NOT EXISTS districts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    city_id INTEGER NOT NULL,
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (city_id) REFERENCES cities(id) ON DELETE CASCADE,
    UNIQUE(name, city_id)
);
```

---

## 核心业务逻辑

### 1. 地区数据管理 (LocationDatabase)

**重要更正**: 所有查询逻辑中的商户状态已从 `active` 更新为 `published`，以匹配V2.0的帖子生命周期。

```python
class LocationDatabase:
    async def get_cities_with_active_merchants(self) -> List[Dict]:
        """获取包含已发布商户的城市"""
        query = """
            SELECT DISTINCT c.id, c.name, c.display_order
            FROM cities c
            INNER JOIN merchants m ON CAST(m.district_id AS INTEGER) = c.id
            WHERE c.is_active = 1 
            AND m.status = 'published'  -- 已更新
            ORDER BY c.display_order ASC, c.name ASC
        """
        # ...
    
    async def get_districts_with_active_merchants(self, city_id: int) -> List[Dict]:
        """获取指定城市中有已发布商户的地区"""
        query = """
            SELECT DISTINCT d.id, d.name, d.display_order
            FROM districts d
            INNER JOIN merchants m ON CAST(m.district_id AS INTEGER) = d.id
            WHERE d.city_id = ? 
            AND d.is_active = 1
            AND m.status = 'published'  -- 已更新
            ORDER BY d.display_order ASC, d.name ASC
        """
        # ...
    
    async def get_district_search_merchants(self, district_id: int) -> List[Dict]:
        """获取指定地区的已发布商户"""
        query = """
            SELECT id, name, price_1, price_2, advantages, disadvantages
            FROM merchants 
            WHERE CAST(district_id AS INTEGER) = ?
            AND status = 'published'  -- 已更新
            ORDER BY name ASC
        """
        # ...
```

### 2. 用户交互处理 (UserHandler)
用户通过点击Bot界面中的“地区搜索”按钮启动此流程。

```python
# 伪代码逻辑

# 1. 用户点击"地区搜索"，触发 handle_location_search_start
# 2. 系统查询 get_cities_with_active_merchants()，展示城市按钮

# 3. 用户选择城市，触发 handle_city_selection
# 4. 系统查询 get_districts_with_active_merchants(city_id)，展示地区按钮

# 5. 用户选择地区，触发 handle_district_selection
# 6. 系统查询 get_district_search_merchants(district_id)，展示商户按钮

# 7. 用户选择商户，触发 handle_merchant_district_selection
# 8. 系统检查商户状态是否为 'published'
if merchant.get('status') != 'published': # 已更新
    await callback.message.edit_text("该商户暂时不可用。")
    return
# 9. 显示商户详情，并提供"立即预约"按钮
```

---

## 总结

地区搜索模块的功能和UI流程在V2.0中保持不变，但其核心数据查询逻辑已根据新的帖子生命周期状态（`published`）进行了必要修正，确保了用户只能搜索到已经通过审核并成功发布的商户信息。
