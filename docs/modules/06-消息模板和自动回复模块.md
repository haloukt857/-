# 消息模板和自动回复模块技术文档 (V2.0)

## 模块概述

本模块为机器人提供基础的交互能力，包括两部分：
1.  **消息模板 (Template Engine)**: 为程序中所有需要发送给用户的固定消息（如欢迎语、操作指引、成功提示等）提供一个统一的、后台可配置的管理机制。
2.  **自动回复 (Auto-Reply)**: 基于用户发送的关键词，进行简单的自动应答。

在V2.0架构中，此模块作为通用基础服务，其实现经过了大幅优化，具备了更高的健壮性和可扩展性。

### 业务价值
- **提高交互一致性**：所有固定回复都来自统一模板。
- **提升运营效率**：管理员可随时在后台修改消息文案，无需改动代码。
- **自动化处理常见问题**：减少客服压力。
- **快速调试与内容填充**：模板缺失时提供明确的 `[模板缺失: key]` 回退提示。

---

## 数据库设计 (`templates` 表)

```sql
CREATE TABLE IF NOT EXISTS templates (
    key TEXT PRIMARY KEY NOT NULL, -- 模板的唯一键，例如 'welcome_message'
    content TEXT NOT NULL,         -- 模板的具体内容
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP -- 最后更新时间
);
```
*   **主键**: `key` 字段是唯一主键，用于程序调用。
*   **分类**: 系统通过 `key` 的前缀（如 `error_`, `admin_`）来进行逻辑上的分类和统计，无需单独的 `category` 字段，设计更为灵活。

---

## V2.0 核心特性与API

V2.0的 `TemplateManager` 提供了强大且完善的功能集。

### 1. 核心API
- `get_template(key: str, default: str = None) -> str`
  - **功能**: 获取模板内容。
  - **关键特性**: 如果模板 `key` 不存在，将返回一个格式为 `[模板缺失: a_key]` 的明确错误提示，极大地简化了开发和调试过程。

- `add_template(key: str, content: str) -> bool`
  - **功能**: 添加一个新模板。如果 `key` 已存在则会失败。

- `update_template(key: str, content: str) -> bool`
  - **功能**: 更新一个已存在的模板。

- `delete_template(key: str) -> bool`
  - **功能**: 删除一个模板。

### 2. 高级功能
- `get_template_statistics() -> Dict[str, int]`
  - **功能**: 获取模板的统计信息，包括总数、按分类（前缀）统计的数量以及近期更新数。

- `get_templates_by_prefix(prefix: str) -> List[Dict]`
  - **功能**: 根据键的前缀获取一批模板，用于后台分类管理。

- `bulk_create_templates(templates: Dict[str, str]) -> int`
  - **功能**: 批量创建模板，主要用于系统初始化或数据迁移。

- `initialize_default_templates()`
  - **功能**: 在系统首次启动时，自动创建一套基础的默认模板（如欢迎语、通用错误提示等），确保系统开箱即用。

---

## 最佳实践：使用前缀进行分类

为了便于管理和统计，所有模板的 `key` 都应遵循 `category_name` 的格式。

- **示例**:
  - `welcome_message`
  - `error_permission_denied`
  - `admin_panel_title`
  - `user_profile_header`

这种方式使得通过 `get_templates_by_prefix('error_')` 即可获取所有错误相关的模板，非常高效。

## 标准键名清单（用户中心）

- 唯一键名规范：统一采用 `user_*` 前缀（不再使用 `welcome_private` 等变体作为标准）。
- 键名与示例文案：
  - `user_welcome_message`：👋 欢迎！这是你的主菜单。
  - `user_no_profile`：ℹ️ 暂无个人资料，请先完善信息。
  - `data_invalid_format`：格式错误
  - `user_profile_title`：📋 用户资料
  - `user_profile_level`：等级：{level_name}
  - `user_profile_xp`：经验值：{xp}
  - `user_profile_points`：积分：{points}
  - `user_profile_orders`：完成订单：{order_count}
  - `user_profile_badges`：勋章：{badges_text}

### 初始化路径说明

- 首次启动时，`database/schema_templates.sql` 会插入上述默认模板（使用 `INSERT OR IGNORE`）。
- 运行时，`database/db_init.py` 的 `_verify_critical_templates` 会自动校验并补齐以上关键模板。
- 历史键（如 `welcome_private`）已淘汰且不再作为初始化项或依赖；运行逻辑仅依赖 `user_*` 标准键名。
- 迁移清理：`database/migrations/migration_2025_09_19_1_清理历史模板键.sql` 会删除 `welcome_private` 以消除并存。

### Markdown 注意事项

- 系统已清理迁移历史中的 `**` 粗体标记；为兼容 `parse_mode=Markdown`，新模板文案避免使用 `**`。
