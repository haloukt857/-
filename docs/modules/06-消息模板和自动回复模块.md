# æ¶ˆæ¯æ¨¡æ¿å’Œè‡ªåŠ¨å›å¤æ¨¡å—æŠ€æœ¯æ–‡æ¡£ (V2.0)

## æ¨¡å—æ¦‚è¿°

æœ¬æ¨¡å—ä¸ºæœºå™¨äººæä¾›åŸºç¡€çš„äº¤äº’èƒ½åŠ›ï¼ŒåŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š
1.  **æ¶ˆæ¯æ¨¡æ¿ (Template Engine)**: ä¸ºç¨‹åºä¸­æ‰€æœ‰éœ€è¦å‘é€ç»™ç”¨æˆ·çš„å›ºå®šæ¶ˆæ¯ï¼ˆå¦‚æ¬¢è¿è¯­ã€æ“ä½œæŒ‡å¼•ã€æˆåŠŸæç¤ºç­‰ï¼‰æä¾›ä¸€ä¸ªç»Ÿä¸€çš„ã€åå°å¯é…ç½®çš„ç®¡ç†æœºåˆ¶ã€‚
2.  **è‡ªåŠ¨å›å¤ (Auto-Reply)**: åŸºäºç”¨æˆ·å‘é€çš„å…³é”®è¯ï¼Œè¿›è¡Œç®€å•çš„è‡ªåŠ¨åº”ç­”ã€‚

åœ¨V2.0æ¶æ„ä¸­ï¼Œæ­¤æ¨¡å—ä½œä¸ºé€šç”¨åŸºç¡€æœåŠ¡ï¼Œå…¶å®ç°ç»è¿‡äº†å¤§å¹…ä¼˜åŒ–ï¼Œå…·å¤‡äº†æ›´é«˜çš„å¥å£®æ€§å’Œå¯æ‰©å±•æ€§ã€‚

### ä¸šåŠ¡ä»·å€¼
- **æé«˜äº¤äº’ä¸€è‡´æ€§**ï¼šæ‰€æœ‰å›ºå®šå›å¤éƒ½æ¥è‡ªç»Ÿä¸€æ¨¡æ¿ã€‚
- **æå‡è¿è¥æ•ˆç‡**ï¼šç®¡ç†å‘˜å¯éšæ—¶åœ¨åå°ä¿®æ”¹æ¶ˆæ¯æ–‡æ¡ˆï¼Œæ— éœ€æ”¹åŠ¨ä»£ç ã€‚
- **è‡ªåŠ¨åŒ–å¤„ç†å¸¸è§é—®é¢˜**ï¼šå‡å°‘å®¢æœå‹åŠ›ã€‚
- **å¿«é€Ÿè°ƒè¯•ä¸å†…å®¹å¡«å……**ï¼šæ¨¡æ¿ç¼ºå¤±æ—¶æä¾›æ˜ç¡®çš„ `[æ¨¡æ¿ç¼ºå¤±: key]` å›é€€æç¤ºã€‚

---

## æ•°æ®åº“è®¾è®¡ (`templates` è¡¨)

```sql
CREATE TABLE IF NOT EXISTS templates (
    key TEXT PRIMARY KEY NOT NULL, -- æ¨¡æ¿çš„å”¯ä¸€é”®ï¼Œä¾‹å¦‚ 'welcome_message'
    content TEXT NOT NULL,         -- æ¨¡æ¿çš„å…·ä½“å†…å®¹
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP -- æœ€åæ›´æ–°æ—¶é—´
);
```
*   **ä¸»é”®**: `key` å­—æ®µæ˜¯å”¯ä¸€ä¸»é”®ï¼Œç”¨äºç¨‹åºè°ƒç”¨ã€‚
*   **åˆ†ç±»**: ç³»ç»Ÿé€šè¿‡ `key` çš„å‰ç¼€ï¼ˆå¦‚ `error_`, `admin_`ï¼‰æ¥è¿›è¡Œé€»è¾‘ä¸Šçš„åˆ†ç±»å’Œç»Ÿè®¡ï¼Œæ— éœ€å•ç‹¬çš„ `category` å­—æ®µï¼Œè®¾è®¡æ›´ä¸ºçµæ´»ã€‚

---

## V2.0 æ ¸å¿ƒç‰¹æ€§ä¸API

V2.0çš„ `TemplateManager` æä¾›äº†å¼ºå¤§ä¸”å®Œå–„çš„åŠŸèƒ½é›†ã€‚

### 1. æ ¸å¿ƒAPI
- `get_template(key: str, default: str = None) -> str`
  - **åŠŸèƒ½**: è·å–æ¨¡æ¿å†…å®¹ã€‚
  - **å…³é”®ç‰¹æ€§**: å¦‚æœæ¨¡æ¿ `key` ä¸å­˜åœ¨ï¼Œå°†è¿”å›ä¸€ä¸ªæ ¼å¼ä¸º `[æ¨¡æ¿ç¼ºå¤±: a_key]` çš„æ˜ç¡®é”™è¯¯æç¤ºï¼Œæå¤§åœ°ç®€åŒ–äº†å¼€å‘å’Œè°ƒè¯•è¿‡ç¨‹ã€‚

- `add_template(key: str, content: str) -> bool`
  - **åŠŸèƒ½**: æ·»åŠ ä¸€ä¸ªæ–°æ¨¡æ¿ã€‚å¦‚æœ `key` å·²å­˜åœ¨åˆ™ä¼šå¤±è´¥ã€‚

- `update_template(key: str, content: str) -> bool`
  - **åŠŸèƒ½**: æ›´æ–°ä¸€ä¸ªå·²å­˜åœ¨çš„æ¨¡æ¿ã€‚

- `delete_template(key: str) -> bool`
  - **åŠŸèƒ½**: åˆ é™¤ä¸€ä¸ªæ¨¡æ¿ã€‚

### 2. é«˜çº§åŠŸèƒ½
- `get_template_statistics() -> Dict[str, int]`
  - **åŠŸèƒ½**: è·å–æ¨¡æ¿çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ€»æ•°ã€æŒ‰åˆ†ç±»ï¼ˆå‰ç¼€ï¼‰ç»Ÿè®¡çš„æ•°é‡ä»¥åŠè¿‘æœŸæ›´æ–°æ•°ã€‚

- `get_templates_by_prefix(prefix: str) -> List[Dict]`
  - **åŠŸèƒ½**: æ ¹æ®é”®çš„å‰ç¼€è·å–ä¸€æ‰¹æ¨¡æ¿ï¼Œç”¨äºåå°åˆ†ç±»ç®¡ç†ã€‚

- `bulk_create_templates(templates: Dict[str, str]) -> int`
  - **åŠŸèƒ½**: æ‰¹é‡åˆ›å»ºæ¨¡æ¿ï¼Œä¸»è¦ç”¨äºç³»ç»Ÿåˆå§‹åŒ–æˆ–æ•°æ®è¿ç§»ã€‚

- `initialize_default_templates()`
  - **åŠŸèƒ½**: åœ¨ç³»ç»Ÿé¦–æ¬¡å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€å¥—åŸºç¡€çš„é»˜è®¤æ¨¡æ¿ï¼ˆå¦‚æ¬¢è¿è¯­ã€é€šç”¨é”™è¯¯æç¤ºç­‰ï¼‰ï¼Œç¡®ä¿ç³»ç»Ÿå¼€ç®±å³ç”¨ã€‚

---

## æœ€ä½³å®è·µï¼šä½¿ç”¨å‰ç¼€è¿›è¡Œåˆ†ç±»

ä¸ºäº†ä¾¿äºç®¡ç†å’Œç»Ÿè®¡ï¼Œæ‰€æœ‰æ¨¡æ¿çš„ `key` éƒ½åº”éµå¾ª `category_name` çš„æ ¼å¼ã€‚

- **ç¤ºä¾‹**:
  - `welcome_message`
  - `error_permission_denied`
  - `admin_panel_title`
  - `user_profile_header`

è¿™ç§æ–¹å¼ä½¿å¾—é€šè¿‡ `get_templates_by_prefix('error_')` å³å¯è·å–æ‰€æœ‰é”™è¯¯ç›¸å…³çš„æ¨¡æ¿ï¼Œéå¸¸é«˜æ•ˆã€‚

## æ ‡å‡†é”®åæ¸…å•ï¼ˆç”¨æˆ·ä¸­å¿ƒï¼‰

- å”¯ä¸€é”®åè§„èŒƒï¼šç»Ÿä¸€é‡‡ç”¨ `user_*` å‰ç¼€ï¼ˆä¸å†ä½¿ç”¨ `welcome_private` ç­‰å˜ä½“ä½œä¸ºæ ‡å‡†ï¼‰ã€‚
- é”®åä¸ç¤ºä¾‹æ–‡æ¡ˆï¼š
  - `user_welcome_message`ï¼šğŸ‘‹ æ¬¢è¿ï¼è¿™æ˜¯ä½ çš„ä¸»èœå•ã€‚
  - `user_no_profile`ï¼šâ„¹ï¸ æš‚æ— ä¸ªäººèµ„æ–™ï¼Œè¯·å…ˆå®Œå–„ä¿¡æ¯ã€‚
  - `data_invalid_format`ï¼šæ ¼å¼é”™è¯¯
  - `user_profile_title`ï¼šğŸ“‹ ç”¨æˆ·èµ„æ–™
  - `user_profile_level`ï¼šç­‰çº§ï¼š{level_name}
  - `user_profile_xp`ï¼šç»éªŒå€¼ï¼š{xp}
  - `user_profile_points`ï¼šç§¯åˆ†ï¼š{points}
  - `user_profile_orders`ï¼šå®Œæˆè®¢å•ï¼š{order_count}
  - `user_profile_badges`ï¼šå‹‹ç« ï¼š{badges_text}

### åˆå§‹åŒ–è·¯å¾„è¯´æ˜

- é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œ`database/schema_templates.sql` ä¼šæ’å…¥ä¸Šè¿°é»˜è®¤æ¨¡æ¿ï¼ˆä½¿ç”¨ `INSERT OR IGNORE`ï¼‰ã€‚
- è¿è¡Œæ—¶ï¼Œ`database/db_init.py` çš„ `_verify_critical_templates` ä¼šè‡ªåŠ¨æ ¡éªŒå¹¶è¡¥é½ä»¥ä¸Šå…³é”®æ¨¡æ¿ã€‚
- å†å²é”®ï¼ˆå¦‚ `welcome_private`ï¼‰å·²æ·˜æ±°ä¸”ä¸å†ä½œä¸ºåˆå§‹åŒ–é¡¹æˆ–ä¾èµ–ï¼›è¿è¡Œé€»è¾‘ä»…ä¾èµ– `user_*` æ ‡å‡†é”®åã€‚
- è¿ç§»æ¸…ç†ï¼š`database/migrations/migration_2025_09_19_1_æ¸…ç†å†å²æ¨¡æ¿é”®.sql` ä¼šåˆ é™¤ `welcome_private` ä»¥æ¶ˆé™¤å¹¶å­˜ã€‚

### Markdown æ³¨æ„äº‹é¡¹

- ç³»ç»Ÿå·²æ¸…ç†è¿ç§»å†å²ä¸­çš„ `**` ç²—ä½“æ ‡è®°ï¼›ä¸ºå…¼å®¹ `parse_mode=Markdown`ï¼Œæ–°æ¨¡æ¿æ–‡æ¡ˆé¿å…ä½¿ç”¨ `**`ã€‚
