# 商家与用户双向评价系统模块（V2）

本模块定义了“评价系统”的数据结构与使用规则，专注于最小必要功能：一单两评、管理员管理、机器人侧仅返回报告频道链接，不引入邀请/催评/评价过期等额外流程。

## 核心规则
- 一单两评：同一订单最多两条记录，方向分别为 u2m（用户→商户/老师）与 m2u（商户/老师→用户）。
- 评分标准：
  - u2m 采用 5 维（1–10）：外貌、身材、服务、态度、环境（沿用现有 reviews 表字段）。
  - m2u 采用 5 维（1–10）：出击素质、长度、硬度、时间、用户气质（新表 merchant_reviews）。
- 管理边界：仅管理员可进行“确认/编辑/删除(软删)/暂停-启用”。编辑评分后需重算聚合分。
- 展示与查询：列表不读取长文本，详情页再取文本。机器人端仅返回 `report_post_url`（报告频道唯一链接）。
- 门禁策略：机器人端查询需商户/老师“启用且未过期”方可返回；管理员后台不受此限制。
- 数据保留：商户/老师过期仅影响机器人查询可见性；历史评价与积分始终保留；恢复启用后自动恢复可查。

## 表结构

### 1) 用户→商户/老师：reviews（沿用现表，最小增列）
- 保留现有主键与评分字段：`id, order_id UNIQUE, merchant_id, customer_user_id, rating_appearance, rating_figure, rating_service, rating_attitude, rating_environment, text_review_by_user, created_at`。
- 新增字段（管理员控制/可见性/报告链接/审计）：
  - `is_active BOOLEAN NOT NULL DEFAULT 1`（单条评价启用/暂停）
  - `is_deleted BOOLEAN NOT NULL DEFAULT 0`（软删）
  - `is_confirmed_by_admin BOOLEAN NOT NULL DEFAULT 0`、`confirmed_by_admin_id INTEGER`、`confirmed_at DATETIME`
  - `report_post_url TEXT`、`published_at DATETIME`
  - `updated_at DATETIME DEFAULT CURRENT_TIMESTAMP`
- 索引（最小）：`(merchant_id, created_at DESC)`、`(is_confirmed_by_admin, is_active, is_deleted)`

### 2) 商户/老师→用户：merchant_reviews（新增表）
```sql
CREATE TABLE merchant_reviews (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    order_id INTEGER NOT NULL UNIQUE,
    merchant_id INTEGER NOT NULL,
    user_id BIGINT NOT NULL,

    rating_attack_quality   INTEGER NOT NULL CHECK(rating_attack_quality BETWEEN 1 AND 10),
    rating_length           INTEGER NOT NULL CHECK(rating_length BETWEEN 1 AND 10),
    rating_hardness         INTEGER NOT NULL CHECK(rating_hardness BETWEEN 1 AND 10),
    rating_duration         INTEGER NOT NULL CHECK(rating_duration BETWEEN 1 AND 10),
    rating_user_temperament INTEGER NOT NULL CHECK(rating_user_temperament BETWEEN 1 AND 10),

    text_review_by_merchant TEXT,

    is_active BOOLEAN NOT NULL DEFAULT 1,
    is_deleted BOOLEAN NOT NULL DEFAULT 0,
    is_confirmed_by_admin BOOLEAN NOT NULL DEFAULT 0,
    confirmed_by_admin_id INTEGER,
    confirmed_at DATETIME,
    report_post_url TEXT,
    published_at DATETIME,

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```
- 索引（最小）：`(merchant_id, created_at DESC)`、`(user_id, created_at DESC)`、`(is_confirmed_by_admin, is_active, is_deleted)`

### 3) 商户聚合：merchant_scores（沿用现表）
- 统计口径仅纳入 u2m 且 `is_confirmed_by_admin=1 AND is_active=1 AND is_deleted=0` 的记录。
- 字段保持现状（五维平均分、计数、`updated_at`）。

### 4) 用户聚合：user_scores（新增表，供 Bot 自查与后台查看）
```sql
CREATE TABLE user_scores (
    user_id BIGINT PRIMARY KEY,
    avg_attack_quality   REAL,
    avg_length           REAL,
    avg_hardness         REAL,
    avg_duration         REAL,
    avg_user_temperament REAL,
    total_reviews_count INTEGER DEFAULT 0,
    updated_at DATETIME
);
```

## 使用约定
- 列表与检索：仅选择评分与必要元数据，不读取 TEXT；机器人端直接输出 `report_post_url`。
- 管理端操作：编辑评分或可见性后需同步刷新对应聚合（商户侧用 `merchant_scores`；用户侧用 `user_scores`）。
- 账号更换：评价通过 `merchant_id` 与商户实体绑定，更换 Telegram 账号不会影响历史评价与链接。

## Bot 交互（按钮 + 编辑模式）
- 入口按钮与文案：
  - 用户端（u2m）文案：`上完课后点击按钮进行评价：` 按钮文本：`❗️完成后评价老师`
  - 商户端（m2u）文案：`上完课后点击按钮进行评价：` 按钮文本：`❗️完成后评价狼友`
  - 回调：U2M → `rv:u2m:start:{order_id}`；M2U → `rv:m2u:start:{order_id}`
  - 生成工具：`handlers.reviews.build_start_review_button(direction, order_id, text='❗️完成后评价老师/狼友')`
- 评分步骤：逐维度选择（1–10），每次点击后原位 `edit_message` 切换到下一维度；完成后出现“提交 / 补充文字 / 重置评分 / 取消”。
- 权限校验：
  - U2M：仅 `orders.customer_user_id` 可评价；
  - M2U：仅 `merchants.telegram_chat_id`（与订单商户匹配）可评价；
  - 当点击“完成后评价…”按钮时，如订单未处于“已完成”，系统将自动标记为“已完成”并进入评分面板（不再弹出二次确认）。
- 文本评价：可后补；提交不强制要求文本。
- 提交：
  - U2M 写入/更新 `reviews`；M2U 写入/更新 `merchant_reviews`；均不读取长文本。
  - 成功后提示“已提交，等待管理员确认”；链接由后台发布后通过 `report_post_url` 更新。

## 迁移文件
- 新增：`database/migrations/migration_2025_09_24_1_评价系统V2_新增m2u与扩展u2m.sql`
  - reviews 增列
  - 创建 merchant_reviews、user_scores
  - 建立最小索引

## 与其他模块关系
- 与订单：仅在“订单完成”后进入评价环节；不改变订单流程与状态机。
- 与商户启用/过期：机器人端查询需商户启用且未过期；后台不受限制。
- 与激励/等级：预留服务层钩子，待后续按运营规则接入；本次不做实现。

### 2. 商家确认评价有效性
- **触发**: 商家在Bot中点击“确认此评价有效”的按钮。
- **操作**: 系统找到`reviews`表中对应的记录，将`is_confirmed_by_merchant`字段更新为`TRUE`。
- **后续激励**: **只有在商家确认后**，系统才会为评价者（用户）增加相应的积分和经验，并进行升级或勋章检查。

### 3. 商家评价用户 (接口预留)
- **触发**: 在商家确认评价有效后，机器人可继续引导商家对用户进行评价。
- **评价维度**: **(待定)** 未来的设计将在这里定义商家评价用户的具体维度。

### 4. 商家平均分计算 (后台定时任务)
- **触发**: `APScheduler` 每日定时执行。
- **计算**: 任务扫描在过去24小时内有**新的有效评价**的商家。
- **聚合**: 对每个商家，任务从`reviews`表中拉取其所有 **`is_confirmed_by_merchant = TRUE`** 的评价，重新计算各项服务的平均分。
- **更新**: 将计算出的新平均分和总有效评价数，更新到`merchant_scores`表中。

### 5. 数据查询
- **商家查看评分**: 商家通过Bot面板查询时，系统会JOIN `merchants` 和 `merchant_scores` 表，快速返回其各项平均分。
- **用户查看评价**: 用户在查看商家详情时，系统会从`reviews`表中分页拉取该商家**已被确认为有效**的文字评价列表。
