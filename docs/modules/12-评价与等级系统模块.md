# 评价与等级系统模块技术文档（V2 概览）

## 模块概述

本模块描述“评价 → 激励/等级”的总体关系。当前阶段，我们仅完成“评价系统 V2”的数据结构与最小规则；积分/等级/勋章将于后续通过服务层钩子对接，避免影响既有流程。

### 业务价值
- **提升用户粘性**: 等级和勋章系统为用户提供长期目标，鼓励持续消费和互动。
- **量化商家质量**: 多维度评分为用户选择商家提供直观、量化的参考依据。
- **激励有效行为**: 通过积分离散式地奖励用户的关键行为（完成订单、评价等）。
- **动态可配置**: 管理员可在后台灵活配置等级、勋章和积分规则，适应运营需求。

---

## 与评价系统的衔接（当前阶段）

- 一单两评：u2m（用户→商户/老师）使用 `reviews`；m2u（商户/老师→用户）使用 `merchant_reviews`。
- 管理员确认：仅管理员可“确认/编辑/删除/暂停-启用”。编辑评分后触发聚合重算。
- 聚合：
  - 商户侧使用 `merchant_scores`（仅统计 u2m 且确认+启用+未删除）。
  - 用户侧使用 `user_scores`（统计 m2u 五维平均分与计数）。
- 机器人端：查询只返回评分与 `report_post_url`；不回传长文本。
- 钩子：评价“提交/确认/编辑评分后”预留调用激励/等级模块的入口（后续对接）。

### 2. 用户与等级系统相关表

**`users` (用户积分与状态总表)** - 存储用户的聚合信息，用于高性能查询。
```sql
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY,                  -- 用户的Telegram ID
    username TEXT,                               -- 用户名
    xp INTEGER DEFAULT 0,                        -- 经验值
    points INTEGER DEFAULT 0,                    -- 积分
    order_count INTEGER DEFAULT 0,               -- 完成订单次数
    level_name TEXT DEFAULT '新手',              -- 等级名称 (反范式设计，用于快速查询)
    badges TEXT DEFAULT '[]'                     -- 勋章列表 (JSON格式的字符串)
);
```

**`user_levels` (等级定义表)** - 由管理员在后台配置。
```sql
CREATE TABLE user_levels (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    level_name TEXT NOT NULL UNIQUE,             -- 等级名称, 如“新手”、“老司机”
    xp_required INTEGER NOT NULL UNIQUE          -- 升级到此等级所需的经验值
);
```

**`badges` (勋章定义表)** - 由管理员在后台配置。
```sql
CREATE TABLE badges (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    badge_name TEXT NOT NULL UNIQUE,             -- 勋章名称, 如“百人斩”
    badge_icon TEXT,                             -- 勋章图标Emoji或URL
    description TEXT                             -- 勋章描述
);
```

**`user_badges` (用户勋章关联表)** - 记录用户获得的勋章。
```sql
CREATE TABLE user_badges (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id BIGINT NOT NULL,
    badge_id INTEGER NOT NULL,
    earned_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (badge_id) REFERENCES badges(id),
    UNIQUE(user_id, badge_id)
);
```

**`badge_triggers` (勋章触发条件表)** - 由管理员在后台配置。
```sql
CREATE TABLE badge_triggers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    badge_id INTEGER NOT NULL,
    trigger_type TEXT NOT NULL,                  -- 触发类型, 如 order_count, perfect_reviews, total_points
    trigger_value INTEGER NOT NULL,              -- 触发条件的值, 如 10, 5000
    FOREIGN KEY (badge_id) REFERENCES badges(id) ON DELETE CASCADE
);
```

## 后续计划（激励/等级）
- 规则配置来源：`system_config` 中的 `points_config`（后续定义）。
- 行为节点：提交评价、管理员确认、完成双向评价……触发积分/经验/等级/徽章（后续落地）。
- 不改变当前业务流：对接以服务钩子实现，避免对订单/评价造成阻塞。

---

## 工作流程

1.  **评价流程**: 订单完成后，Bot引导用户进行按钮评分和可选的文字评价，数据写入`reviews`表。
2.  **激励与检查**: 评价完成后，系统根据`system_config`为用户增加`users`表中的积分和经验，并检查是否满足升级或获得勋章的条件。
3.  **分数聚合**: 每日一次的定时任务 (`APScheduler`) 从`reviews`表读取数据，计算商家的平均分，并更新到`merchant_scores`表中。
4.  **查询**: 
    - 商家面板查询评分时，JOIN `merchants` 和 `merchant_scores` 表。
    - 用户查询个人信息时，直接查询 `users` 表。
5.  **后台管理**: 管理员在Web后台管理`user_levels`, `badges`, `badge_triggers`和`system_config`中的积分规则。
