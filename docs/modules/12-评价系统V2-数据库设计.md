# 评价系统 V2 — 数据库设计（落地版）

本文档为评价系统 V2 的权威数据库说明，覆盖表结构、约束、索引与最小使用规则。配合《12-商家与用户双向评价系统模块.md》一同使用。

## 一、设计目标
- 一单两评：同一订单最多两条记录（u2m 与 m2u 各一条）。
- 管理员唯一入口：确认/编辑/删除(软删)/暂停-启用。
- 机器人端仅返回 `report_post_url`，列表查询不读取长文本。
- 机器人查询随商户“启用且未过期”做门禁过滤；后台不受限制。
- 历史评价与积分始终保留，与商户账号换绑无关（依赖 `merchant_id` 永久ID）。

## 二、表结构与索引

### 1) 用户→商户/老师：reviews（沿用现表，最小增列）
关键字段（已存在）：
- `id`, `order_id UNIQUE`, `merchant_id`, `customer_user_id`
- `rating_appearance`, `rating_figure`, `rating_service`, `rating_attitude`, `rating_environment`（1–10）
- `text_review_by_user`（可空）, `created_at`

新增字段（管理员控制/可见性/报告链接/审计）：
- `is_active BOOLEAN NOT NULL DEFAULT 1`
- `is_deleted BOOLEAN NOT NULL DEFAULT 0`
- `is_confirmed_by_admin BOOLEAN NOT NULL DEFAULT 0`
- `confirmed_by_admin_id INTEGER`, `confirmed_at DATETIME`
- `report_post_url TEXT`, `published_at DATETIME`
- `updated_at DATETIME DEFAULT CURRENT_TIMESTAMP`

最小索引：
- `idx_reviews_merchant_time (merchant_id, created_at DESC)`
- `idx_reviews_visible (is_confirmed_by_admin, is_active, is_deleted)`

### 2) 商户/老师→用户：merchant_reviews（新增）
- `id INTEGER PK AUTOINCREMENT`
- `order_id INTEGER NOT NULL UNIQUE`
- `merchant_id INTEGER NOT NULL`
- `user_id BIGINT NOT NULL`
- 五维评分（1–10）：
  - `rating_attack_quality`（出击素质）
  - `rating_length`（长度）
  - `rating_hardness`（硬度）
  - `rating_duration`（时间）
  - `rating_user_temperament`（用户气质）
- `text_review_by_merchant TEXT`
- 管理/可见性/发布：`is_active`、`is_deleted`、`is_confirmed_by_admin`、`confirmed_by_admin_id`、`confirmed_at`、`report_post_url`、`published_at`
- 审计：`created_at`、`updated_at`

最小索引：
- `idx_mr_merchant_time (merchant_id, created_at DESC)`
- `idx_mr_user_time (user_id, created_at DESC)`
- `idx_mr_visible (is_confirmed_by_admin, is_active, is_deleted)`

### 3) 用户聚合：user_scores（新增）
- `user_id BIGINT PRIMARY KEY`
- `avg_attack_quality, avg_length, avg_hardness, avg_duration, avg_user_temperament REAL`
- `total_reviews_count INTEGER DEFAULT 0`
- `updated_at DATETIME`

### 4) 商户聚合：merchant_scores（沿用）
- 统计口径：仅纳入 u2m 且 `is_confirmed_by_admin=1 AND is_active=1 AND is_deleted=0`。

## 三、迁移文件
- `database/migrations/migration_2025_09_24_1_评价系统V2_新增m2u与扩展u2m.sql`
  - reviews 增列
  - 创建 merchant_reviews、user_scores
  - 建立最小索引

## 四、查询与使用约定
- 列表仅读取评分与必要元数据，不读取长文本（TEXT）。
- 机器人端返回 `report_post_url`；详情页再按需读取文本。
- 机器人查询默认启用商户门禁过滤（status=active 且未过期）。
- 管理端操作（确认/编辑/删除/暂停-启用）后需同步刷新聚合（商户侧 merchant_scores；用户侧 user_scores）。

## 五、与账号换绑的关系
- 评价与商户实体通过永久 `merchant_id` 绑定；Telegram 账号更换不会影响历史评价与报告链接。

（完）

