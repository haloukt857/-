# 用户激励系统模块 (V2.0)

## 模块概述

本模块是一个面向普通用户的、独立的激励体系。它通过积分、经验、等级和勋章，对用户的有效行为（如完成订单、进行评价）进行奖励，旨在提升用户在平台内的活跃度和忠诚度。

### 业务价值
- **提升用户粘性**: 等级和勋章系统为用户提供了清晰的长期目标和荣誉感。
- **激励关键行为**: 通过积分离散式地奖励能为平台带来价值的用户行为。
- **用户分层**: 等级系统为未来进行精细化运营（如高等级用户享受特殊服务）提供了基础。
- **后台动态配置**: 所有激励规则均可由管理员在后台灵活配置，适应运营变化。

---

## 数据库设计

本模块的数据库设计专注于用户聚合信息的快速查询和后台配置的灵活性。

### 1. `users` (用户积分与状态总表)
存储用户的聚合信息，用于毫秒级查询。
```sql
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY,                  -- 用户的Telegram ID
    username TEXT,                               -- 用户名
    xp INTEGER DEFAULT 0,                        -- 经验值
    points INTEGER DEFAULT 0,                    -- 积分
    order_count INTEGER DEFAULT 0,               -- 完成订单次数
    level_name TEXT DEFAULT '新手',              -- 等级名称 (反范式设计，用于快速查询)
    badges TEXT DEFAULT '[]'                     -- 勋章列表 (JSON格式的字符串)
);
```

### 2. `user_levels` (等级定义表)
由管理员在后台配置。
```sql
CREATE TABLE user_levels (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    level_name TEXT NOT NULL UNIQUE,             -- 等级名称, 如“新手”、“老司机”
    xp_required INTEGER NOT NULL UNIQUE          -- 升级到此等级所需的经验值
);
```

### 3. `badges` (勋章定义表)
由管理员在后台配置。
```sql
CREATE TABLE badges (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    badge_name TEXT NOT NULL UNIQUE,             -- 勋章名称, 如“百人斩”
    badge_icon TEXT,                             -- 勋章图标Emoji或URL
    description TEXT                             -- 勋章描述
);
```

### 4. `user_badges` (用户勋章关联表)
记录用户获得的勋章。
```sql
CREATE TABLE user_badges (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id BIGINT NOT NULL,
    badge_id INTEGER NOT NULL,
    earned_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (badge_id) REFERENCES badges(id),
    UNIQUE(user_id, badge_id)
);
```

### 5. `badge_triggers` (勋章触发条件表)
由管理员在后台配置。
```sql
CREATE TABLE badge_triggers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    badge_id INTEGER NOT NULL,
    trigger_type TEXT NOT NULL,                  -- 触发类型, 如 order_count, perfect_reviews, total_points
    trigger_value INTEGER NOT NULL,              -- 触发条件的值, 如 10, 5000
    FOREIGN KEY (badge_id) REFERENCES badges(id) ON DELETE CASCADE
);
```

### 6. `system_config` (动态积分配置)
积分获取规则存储在 `system_config` 表中，键为 `points_config`。

---

## 工作流程

1.  **激励触发**: 当一个**有效**的关键动作被完成时，系统会触发激励流程。例如，当一个评价被商家确认为有效后。
2.  **积分/经验发放**: 在评价被商家确认有效后，系统读取`system_config`中的积分规则，为评价者（用户）的`users`记录增加相应的`points`和`xp`。
3.  **升级检查**: 每次经验值变动后，系统会检查用户的总`xp`是否达到`user_levels`中定义的下一等级要求。如果满足，则更新`users`表中的`level_name`字段。
4.  **勋章检查**: 每次关键数据（如`order_count`, `points`）变动后，系统会检查是否满足`badge_triggers`中的任何条件。如果满足，则在`user_badges`中创建一条新记录，并更新`users`表中的`badges` JSON字段。
5.  **后台管理**: 管理员在Web后台对`user_levels`, `badges`, `badge_triggers`和积分规则进行增删改查。

---

## 用户查询界面 (Bot端)

为了让用户能随时查看自己的成就，系统为普通用户提供 `/profile` 命令。

- **触发方式**: 用户在机器人处发送 `/profile` 命令。
- **核心逻辑**: 后台通过对 `users` 表进行一次高效的单表主键查询，获取该用户的所有聚合信息。
- **展示内容**: 机器人将以卡片形式，清晰地向用户展示其当前的等级、经验值、积分、出击次数和已获得的勋章列表。

---

## 与评价系统 V2 的衔接（当前阶段）

- 行为节点：评价“提交/管理员确认/评分编辑后重算”将作为积分/经验/等级/勋章的触发点（服务层钩子，后续对接）。
- 聚合来源：
  - 商户侧评分来源 `merchant_scores`（仅统计 u2m 且确认+启用+未删除）。
  - 用户侧评分来源 `user_scores`（统计 m2u 五维平均与计数）。
- 实施原则：不改变订单与评价主流程；通过钩子实现松耦合接入。
